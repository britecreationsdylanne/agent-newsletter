<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BriteCo Brief - Agent Newsletter Generator</title>
    <!-- Agent Newsletter Tool for Insurance Agents -->

    <!-- BritePulse Error Tracking & Feedback -->
    <script
      src="https://britepulse-api-29820647719.us-central1.run.app/sdk.js"
      data-api-key="pk_8f665b20-148a-43ea-8f00-90243860dc53_ab522017551c419197a82e1eded24918"
      data-api-url="https://britepulse-api-29820647719.us-central1.run.app"
      defer
    ></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Preview-only: More space between Claims image and text */
        #newsletterPreview .claims-content {
            padding-left: 15px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #018181 0%, #272d3f 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: #272d3f;
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #FE8916;
            font-size: 14px;
            letter-spacing: 2px;
        }

        .progress-container {
            margin: 0 40px 20px 40px;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
            color: #4b5563;
        }

        .progress-step {
            font-weight: 600;
            color: #018181;
        }

        .progress-label {
            color: #6b7280;
        }

        .progress {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            background: #018181;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .step {
            padding: 40px;
            display: none;
        }

        .step.active {
            display: block;
        }

        .step h2 {
            color: #272d3f;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .step p {
            color: #666;
            margin-bottom: 30px;
        }

        .month-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 30px auto;
            max-width: 400px;
        }

        .month-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px 20px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .month-card:hover {
            border-color: #018181;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(1,129,129,0.15);
        }

        .month-card.selected {
            background: #018181;
            border-color: #018181;
            color: white;
        }

        .month-card .name {
            font-weight: 600;
            font-size: 16px;
        }

        .month-card .season {
            font-size: 13px;
            color: #999;
            text-transform: capitalize;
        }

        .month-card.selected .season {
            color: rgba(255,255,255,0.7);
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top-color: #018181;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .topic-list {
            display: grid;
            gap: 15px;
            margin: 20px 0;
        }

        .topic-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .topic-card:hover {
            border-color: #018181;
            transform: translateX(4px);
        }

        .topic-card.selected {
            border-color: #018181;
            background: #f0f9f9;
        }

        .topic-card .title {
            font-weight: 600;
            color: #272d3f;
            margin-bottom: 8px;
        }

        .topic-card .description {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .topic-card .source {
            color: #018181;
            font-size: 13px;
            text-decoration: none;
        }

        .btn {
            background: #018181;
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #016666;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(1,129,129,0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #666;
        }

        .btn-secondary:hover {
            background: #555;
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .content-section {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }

        .content-section h3 {
            color: #018181;
            margin-bottom: 15px;
        }

        .error {
            background: #fee;
            border: 2px solid #fcc;
            color: #c00;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        /* Research Dashboard Tabs */
        .research-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0;
        }

        .research-tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .research-tab:hover {
            color: #018181;
        }

        .research-tab.active {
            color: #018181;
            border-bottom-color: #018181;
        }

        .research-tab.completed {
            color: #059669;
        }

        .tab-check {
            color: #059669;
            font-weight: bold;
        }

        /* Selection Progress Tracker */
        .selection-progress-tracker {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            border-top: 2px solid #e5e7eb;
            padding: 20px;
            margin-top: 20px;
            border-radius: 0 0 8px 8px;
        }

        .selection-progress-items {
            display: flex;
            gap: 12px;
        }

        .selection-progress-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .selection-progress-item:hover {
            border-color: #018181;
            background: #f0fdfa;
        }

        .selection-progress-item.active {
            border-color: #018181;
            background: #e6f4f4;
        }

        .selection-progress-item.completed {
            border-color: #059669;
            background: #ecfdf5;
        }

        .selection-progress-item .progress-icon {
            font-size: 18px;
        }

        .selection-progress-item .progress-label {
            font-weight: 600;
            font-size: 14px;
            color: #374151;
        }

        .selection-progress-item.completed .progress-label {
            color: #059669;
        }

        .selection-progress-item .progress-check {
            font-size: 16px;
            color: #059669;
            display: none;
        }

        .selection-progress-item.completed .progress-check {
            display: inline;
        }

        .selection-progress-actions {
            display: flex;
            gap: 12px;
        }

        .selection-progress-actions .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* 3-Card Research Dashboard Styles */
        .research-dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        @media (max-width: 1200px) {
            .research-dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .research-dashboard {
                grid-template-columns: 1fr;
            }
        }

        .research-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .research-card.disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .research-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
        }

        .research-card-description {
            font-size: 12px;
            color: #6b7280;
            line-height: 1.4;
            margin: 0 0 12px 0;
            padding: 0;
        }

        .research-card-title {
            font-size: 18px;
            font-weight: 600;
            color: #272d3f;
        }

        .research-card-badge {
            background: #FE8916;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .research-card-badge.coming-soon {
            background: #9ca3af;
        }

        .research-card-filters {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .research-card-filters select,
        .research-card-filters input {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
        }

        .research-card-filters select:focus,
        .research-card-filters input:focus {
            border-color: #018181;
            outline: none;
        }

        .research-card-results {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            padding-right: 5px;
        }

        .research-result-item {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .research-result-item:hover {
            border-color: #018181;
            background: #f0f9f9;
        }

        .research-result-item.selected {
            border-color: #018181;
            background: #e0f2f2;
        }

        .research-result-title {
            font-weight: 600;
            color: #272d3f;
            font-size: 14px;
            margin-bottom: 6px;
        }

        .research-result-snippet {
            color: #666;
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 6px;
        }

        .research-result-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #999;
        }

        .research-result-link {
            color: #018181;
            text-decoration: none;
        }

        .research-result-link:hover {
            text-decoration: underline;
        }

        .research-card-search-btn {
            background: #018181;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .research-card-search-btn:hover {
            background: #016666;
        }

        .research-card-search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .research-card-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #666;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: nowrap;
            gap: 12px;
            align-items: center;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
        }

        @media screen and (max-width: 600px) {
            .checkbox-group {
                flex-wrap: wrap;
                gap: 8px;
            }
            .checkbox-group label {
                font-size: 12px;
            }
        }

        .section-selection-header {
            background: #272d3f;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .section-selection-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .section-selection-header p {
            margin: 5px 0 0 0;
            opacity: 0.8;
            font-size: 14px;
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body>
    <!-- Login Screen Overlay -->
    <div id="loginOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a2e; z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div style="background: #1a1a2e; padding: 4rem 3.5rem; border-radius: 32px; text-align: center; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(26,26,46,0.4); border: 1px solid rgba(102,126,234,0.2);">
            <!-- Logo and Title -->
            <div style="display: flex; align-items: center; justify-content: center; gap: 1.5rem; margin-bottom: 3rem;">
                <div style="width: 80px; height: 80px; background: rgba(102,126,234,0.2); border-radius: 16px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(102,126,234,0.3);">
                    <svg style="width: 48px; height: 48px; color: #667eea;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                </div>
                <h1 style="font-size: 2.5rem; font-weight: 800; color: white; letter-spacing: -1px; margin: 0;">Brief Generator</h1>
            </div>

            <h2 style="font-size: 1.75rem; font-weight: 600; color: white; margin-bottom: 1rem;">Welcome Back</h2>
            <p style="color: #a0aec0; margin-bottom: 3rem; font-size: 1.25rem;">Sign in to access your AI tools</p>

            <!-- Google Sign In Button -->
            <button id="googleSignInBtn" onclick="signInWithGoogle()" style="display: flex; align-items: center; justify-content: center; gap: 1.25rem; width: 100%; padding: 1.25rem 2rem; background: white; border: none; border-radius: 16px; font-size: 1.25rem; font-weight: 600; color: #1a1a2e; cursor: pointer; transition: all 0.2s;">
                <svg width="28" height="28" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
            </button>

            <p style="margin-top: 2.5rem; font-size: 1rem; color: #718096;">Use your BriteCo Google account to sign in</p>
        </div>
    </div>

    <!-- Firebase Auth Script -->
    <script>
        // Firebase auth objects (initialized after config loads)
        let auth = null;
        let googleProvider = null;
        let currentUser = null;

        // Initialize Firebase with config from server
        async function initFirebase() {
            try {
                const response = await fetch('/api/firebase-config');
                const firebaseConfig = await response.json();

                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                googleProvider = new firebase.auth.GoogleAuthProvider();

                // Restrict to BriteCo domain
                googleProvider.setCustomParameters({ hd: 'brite.co' });

                // Auth state listener
                auth.onAuthStateChanged((user) => {
                    currentUser = user;
                    if (user) {
                        document.getElementById('loginOverlay').style.display = 'none';
                        updateUserDisplay(user);
                    } else {
                        document.getElementById('loginOverlay').style.display = 'flex';
                    }
                });
            } catch (error) {
                console.error('Failed to load Firebase config:', error);
            }
        }

        // Initialize on page load
        initFirebase();

        // Sign in with Google
        async function signInWithGoogle() {
            try {
                document.getElementById('googleSignInBtn').disabled = true;
                document.getElementById('googleSignInBtn').innerHTML = 'Signing in...';
                await auth.signInWithPopup(googleProvider);
            } catch (error) {
                console.error('Sign in error:', error);
                document.getElementById('googleSignInBtn').disabled = false;
                document.getElementById('googleSignInBtn').innerHTML = `
                    <svg width="28" height="28" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Sign in with Google
                `;
                alert('Sign in failed. Please use a BriteCo Google account.');
            }
        }

        // Sign out
        async function signOut() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        // Update user display in header
        function updateUserDisplay(user) {
            const header = document.querySelector('.header');
            // Remove existing user info if present
            const existingUserInfo = document.getElementById('userInfo');
            if (existingUserInfo) existingUserInfo.remove();

            // Add user info
            const userInfo = document.createElement('div');
            userInfo.id = 'userInfo';
            userInfo.style.cssText = 'display: flex; align-items: center; gap: 1rem; margin-top: 0.75rem;';
            userInfo.innerHTML = `
                <span style="color: #a0aec0; font-size: 0.9rem;">${user.email}</span>
                <button onclick="signOut()" style="background: transparent; border: 1px solid #667eea; color: #667eea; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">Sign Out</button>
            `;
            header.appendChild(userInfo);
        }
    </script>

    <div class="container">
        <div class="header">
            <h1>BriteCo Brief Generator</h1>
        </div>

        <div class="progress-container">
            <div class="progress-text">
                <span class="progress-step" id="progressStep">Step 1 of 15</span>
                <span class="progress-label" id="progressLabel">Select Month</span>
            </div>
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>

        <!-- Step 1: Select Month -->
        <div class="step active" id="step1">
            <h2>Select Newsletter Month</h2>
            <p>Choose the month for seasonal content and trends</p>

            <div class="month-grid" id="monthGrid">
                <!-- Months will be generated here -->
            </div>

            <div class="buttons">
                <button class="btn" id="monthNextBtn" disabled onclick="showStep('2-britespot')">Continue to Brite Spot ‚Üí</button>
            </div>
        </div>

        <!-- Step 2: The Brite Spot (Manual Input + AI Rewrite) -->
        <div class="step" id="step2-britespot">
            <h2>‚ú® The Brite Spot</h2>
            <p>Share BriteCo company news, new features, or updates. Enter your content and optionally use AI to polish it.</p>

            <div style="max-width: 700px; margin: 0 auto;">
                <!-- Newsletter Header Intro -->
                <div style="background: white; border: 2px solid #F47920; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #272d3f;">
                        üìã Newsletter Header Intro <span style="color: #666; font-weight: 400;">(appears below BriteCo Brief header)</span>
                    </label>
                    <textarea id="headerIntroInput" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;" placeholder="e.g., Welcome to this month's edition! Here's what's new in insurance..."></textarea>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; gap: 15px;">
                        <span style="font-size: 12px; color: #666;">This text appears at the top of the newsletter, below the main header and before The Brite Spot section.</span>
                        <button class="btn-secondary btn" style="padding: 8px 16px; white-space: nowrap; flex-shrink: 0;" onclick="rewriteHeaderIntro()">AI Rewrite</button>
                    </div>
                </div>
                <div id="headerIntroRewriteResult" style="display: none; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: 600; color: #15803d;">AI Rewritten Version</span>
                        <button class="btn" style="padding: 6px 12px; font-size: 13px;" onclick="useHeaderIntroRewrite()">Use This Version</button>
                    </div>
                    <div id="headerIntroRewriteText" style="color: #166534; line-height: 1.6;"></div>
                </div>

                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #272d3f;">
                        Brite Spot - Intro Paragraph
                    </label>
                    <textarea id="briteSpotInput" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;" placeholder="Enter a short intro paragraph about BriteCo news or updates..."></textarea>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <span style="font-size: 12px; color: #666;">A brief introduction paragraph that appears before the bullet points.</span>
                        <button class="btn-secondary btn" style="padding: 8px 16px;" onclick="rewriteBriteSpotIntro()">AI Rewrite</button>
                    </div>
                </div>
                <div id="briteSpotIntroRewriteResult" style="display: none; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: 600; color: #15803d;">AI Rewritten Version</span>
                        <button class="btn" style="padding: 6px 12px; font-size: 13px;" onclick="useBriteSpotIntroRewrite()">Use This Version</button>
                    </div>
                    <div id="briteSpotIntroRewriteText" style="color: #166534; line-height: 1.6;"></div>
                </div>

                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #272d3f;">
                        Brite Spot - Bullet Points <span style="color: #666; font-weight: 400;">(one per line)</span>
                    </label>
                    <textarea id="briteSpotBulletsInput" rows="5" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;" placeholder="Enter each bullet point on a new line:
‚Ä¢ New feature announcement
‚Ä¢ Updated dashboard tools
‚Ä¢ Partner integration news"></textarea>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <span id="briteSpotWordCount" style="font-size: 13px; color: #666;">0 / 100 words</span>
                        <button class="btn-secondary btn" style="padding: 8px 16px;" onclick="rewriteBriteSpotBullets()">AI Rewrite</button>
                    </div>
                </div>

                <div id="briteSpotRewriteResult" style="display: none; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: 600; color: #15803d;">AI Rewritten Version</span>
                        <button class="btn" style="padding: 6px 12px; font-size: 13px;" onclick="useBriteSpotRewrite()">Use This Version</button>
                    </div>
                    <div id="briteSpotRewriteText" style="color: #166534; line-height: 1.6;"></div>
                </div>

                <div style="background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 0 8px 8px 0; margin-bottom: 20px;">
                    <div style="font-weight: 600; color: #1e40af; margin-bottom: 5px;">üí° Tips for Brite Spot</div>
                    <ul style="margin: 0; padding-left: 20px; color: #1e40af; font-size: 14px;">
                        <li>Announce new BriteCo features or tools</li>
                        <li>Share company milestones or achievements</li>
                        <li>Highlight agent success stories</li>
                        <li>Keep it concise and action-oriented</li>
                    </ul>
                </div>
            </div>

            <div class="buttons" style="justify-content: center;">
                <button class="btn-secondary btn" onclick="showStep(1)">‚Üê Back</button>
                <button class="btn" onclick="saveBriteSpotPage(); showStep('2-spotlight')">Continue to InsurNews Spotlight ‚Üí</button>
            </div>
        </div>

        <!-- Step 2B: InsurNews Spotlight (Multi-Source Selection) -->
        <div class="step" id="step2-spotlight">
            <h2>‚≠ê InsurNews Spotlight</h2>
            <p>Search across multiple sources and select 3-5 articles. AI will create a comprehensive feature story.</p>

            <!-- Selected Articles Counter + Add Custom Link Button (matching Research Dashboard layout) -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div id="spotlightSelectionCounter" style="background: #FFF4EB; border: 2px solid #F47920; border-radius: 8px; padding: 12px 20px;">
                    <span style="font-weight: 600; color: #C25A10;">üìë Selected: <span id="spotlightSelectedCount">0</span> / 5 articles (min 3)</span>
                </div>
                <button class="btn-secondary btn" onclick="showSpotlightUploadModal()" style="padding: 8px 16px; font-size: 13px;">üìé Add Custom Link</button>
            </div>

            <!-- Custom Links Indicator for Spotlight -->
            <div id="spotlightCustomLinksIndicatorMain" style="display: none; font-size: 12px; color: #059669; background: #d1fae5; padding: 8px 12px; margin-bottom: 15px; border-radius: 4px; border: 1px solid #10b981;"></div>

            <!-- Upload Link Modal for Spotlight -->
            <div id="spotlightUploadLinkModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 550px; width: 90%; margin: 20px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 15px 0; color: #374151;">üìé Add Custom Article Links</h3>
                    <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">Paste links to articles you'd like to include in the Spotlight story.</p>

                    <!-- Added Links List -->
                    <div id="spotlightAddedLinksList" style="margin-bottom: 15px; display: none;">
                        <p style="font-size: 12px; font-weight: 600; color: #059669; margin-bottom: 8px;">‚úì Added Links:</p>
                        <div id="spotlightAddedLinksContainer" style="max-height: 150px; overflow-y: auto; border: 1px solid #d1fae5; border-radius: 6px; padding: 8px; background: #ecfdf5;"></div>
                    </div>

                    <input type="text" id="spotlightCustomLinkInput" placeholder="https://example.com/article..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; margin-bottom: 10px;">
                    <div id="spotlightUploadLinkError" style="color: #dc2626; font-size: 13px; margin-bottom: 15px; display: none;"></div>

                    <div style="display: flex; gap: 10px; justify-content: space-between; align-items: center;">
                        <button class="btn" id="spotlightFetchArticleBtn" onclick="fetchSpotlightCustomArticle()" style="background: #059669;">+ Add This Link</button>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-secondary btn" onclick="hideSpotlightUploadModal()">Done</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3-Card Search Dashboard (same order as venue-voice) -->
            <div class="research-dashboard">
                <!-- Card 1: Perplexity Research -->
                <div class="research-card" id="spotlightPerplexityCard">
                    <div class="research-card-header">
                        <span class="research-card-title">üîÆ Perplexity Research</span>
                        <span class="research-card-badge">AI + Citations</span>
                    </div>
                    <p class="research-card-description">Searches the web via Perplexity AI, then GPT-5.2 transforms findings into newsletter-ready articles with agent-specific insights.</p>
                    <div class="research-card-filters">
                        <input type="text" id="spotlightPerplexityQuery" placeholder="e.g., insurance market trends..." value="P&C insurance industry trends 2026">
                        <select id="spotlightPerplexityTimeWindow">
                            <option value="7d">Last 7 days</option>
                            <option value="30d" selected>Last 30 days</option>
                            <option value="90d">Last 90 days</option>
                        </select>
                    </div>
                    <button class="research-card-search-btn" onclick="searchSpotlightPerplexity()">Search with Perplexity</button>
                    <div class="research-card-results" id="spotlightPerplexityResults">
                        <p style="text-align: center; color: #999; padding: 20px;">Enter a topic and search</p>
                    </div>
                </div>

                <!-- Card 2: Insight Builder (Industry Signals) -->
                <div class="research-card" id="spotlightSignalsCard">
                    <div class="research-card-header">
                        <span class="research-card-title">üìä Insight Builder</span>
                        <span class="research-card-badge">All Signals</span>
                    </div>
                    <p class="research-card-description">Scans 8 market signals simultaneously via OpenAI web search, then GPT-5.2 analyzes impact on the insurance industry and generates actionable headlines.</p>
                    <div class="research-card-filters">
                        <span style="color: #666; font-size: 0.8em;">Auto, Home, Commercial, Claims, Regulations, Technology, Market Trends</span>
                        <select id="spotlightSignalsTimeWindow">
                            <option value="7d">Last 7 days</option>
                            <option value="30d" selected>Last 30 days</option>
                            <option value="90d">Last 90 days</option>
                        </select>
                    </div>
                    <button class="research-card-search-btn" onclick="searchSpotlightSignals()">Search All 8 Signals</button>
                    <div class="research-card-results" id="spotlightSignalsResults">
                        <p style="text-align: center; color: #999; padding: 20px;">Click to analyze all 8 market signals</p>
                    </div>
                </div>

                <!-- Card 3: Source Explorer (Curated Sources) -->
                <div class="research-card" id="spotlightCuratedCard">
                    <div class="research-card-header">
                        <span class="research-card-title">üì∞ Source Explorer</span>
                        <span class="research-card-badge">Industry</span>
                    </div>
                    <p class="research-card-description">Searches curated insurance industry sources, then GPT-5.2 extracts story angles and agent implications.</p>
                    <div style="background: #f8fafc; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 11px; color: #64748b;">
                        <strong style="color: #374151;">Curated Sources:</strong><br>
                        insurancenewsnet.com ‚Ä¢ insurancejournal.com ‚Ä¢ propertycasualty360.com ‚Ä¢ claimsjournal.com ‚Ä¢ carriermanagement.com ‚Ä¢ thinkadvisor.com ‚Ä¢ dig-in.com
                    </div>
                    <div class="research-card-filters">
                        <div class="checkbox-group">
                            <label><input type="checkbox" value="insurance" checked class="spotlightSourcePack"> Insurance News</label>
                            <label><input type="checkbox" value="claims" class="spotlightSourcePack"> Claims</label>
                            <label><input type="checkbox" value="regulations" class="spotlightSourcePack"> Regulations</label>
                        </div>
                        <input type="text" id="spotlightCuratedQuery" placeholder="e.g., market news, industry updates..." value="P&C insurance industry news">
                        <select id="spotlightCuratedTimeWindow">
                            <option value="7d">Last 7 days</option>
                            <option value="30d" selected>Last 30 days</option>
                            <option value="90d">Last 90 days</option>
                        </select>
                    </div>
                    <button class="research-card-search-btn" onclick="searchSpotlightCurated()">Search Sources</button>
                    <div class="research-card-results" id="spotlightCuratedResults">
                        <p style="text-align: center; color: #999; padding: 20px;">Select source packs and search</p>
                    </div>
                </div>
            </div>

            <div class="buttons" style="justify-content: space-between; margin-top: 20px;">
                <button class="btn-secondary btn" onclick="showStep('2-britespot')">‚Üê Back to Brite Spot</button>
                <button class="btn" id="generateSpotlightBtn" disabled onclick="generateSpotlightContent()" style="padding: 8px 16px;">Generate Spotlight Story ‚Üí</button>
            </div>
        </div>

        <!-- Step 2B-Review: Spotlight Story Preview/Edit -->
        <div class="step" id="step2-spotlight-review">
            <h2>‚≠ê Review Spotlight Story</h2>
            <p>Review and edit your generated InsurNews Spotlight content. Click on any text to edit it directly.</p>

            <!-- Single editable view - Google Doc style -->
            <div id="spotlightEditableView" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <!-- Document Page -->
                <div style="background: white; max-width: 800px; margin: 0 auto; padding: 50px 60px; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08); min-height: 500px; font-family: 'Arial', sans-serif;">
                    <!-- Headline - Editable -->
                    <div id="spotlightHeadlineEditable" contenteditable="true" style="margin: 0 0 25px 0; font-size: 24px; color: #008181; line-height: 1.4; font-weight: 700; border-bottom: 2px solid #008181; padding-bottom: 15px; outline: none; cursor: text;"
                         onfocus="this.style.background='#f0f9f9'" onblur="this.style.background='transparent'">
                        Loading...
                    </div>

                    <!-- Article Body Sections - Editable -->
                    <div id="spotlightBodyEditable" style="font-size: 14px; line-height: 1.8; color: #333;">
                        <!-- H3 sections will be rendered here as editable content -->
                    </div>

                    <!-- Agent Takeaway Box - Editable -->
                    <div style="margin-top: 35px; padding: 20px; background: #f0f9f9; border-left: 4px solid #008181; border-radius: 0 8px 8px 0;">
                        <h4 style="margin: 0 0 10px 0; color: #008181; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700;">üí° Agent Takeaway</h4>
                        <div id="spotlightTakeawayEditable" contenteditable="true" style="margin: 0; color: #333; font-size: 14px; line-height: 1.7; outline: none; cursor: text;"
                             onfocus="this.style.background='#e0f2f2'" onblur="this.style.background='transparent'">
                            Loading...
                        </div>
                    </div>

                    <!-- Sources - Read only -->
                    <div style="margin-top: 35px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                        <p style="font-size: 11px; color: #666; margin: 0 0 8px 0; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">Sources</p>
                        <div id="spotlightSourcesEditable" style="font-size: 12px; color: #008181;">
                            <!-- Sources will be listed here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="buttons" style="justify-content: center;">
                <button class="btn-secondary btn" onclick="showStep('2-spotlight')">‚Üê Back to Article Selection</button>
                <button class="btn" onclick="saveSpotlightEdits(); showStep('2-research')">Continue to Research Dashboard ‚Üí</button>
            </div>
        </div>

        <!-- Step 2C: Research Dashboard (Curious Claims, News Roundup, Agent Advantage) -->
        <div class="step" id="step2-research">
            <h2>üîç Research Dashboard</h2>
            <p>Search and select articles for the remaining newsletter sections.</p>

            <!-- Section Tabs -->
            <div class="research-tabs">
                <button class="research-tab active" data-section="claims" onclick="switchResearchTab('claims')">
                    üîç Curious Claims
                    <span class="tab-check" id="claimsTabCheck" style="display:none">‚úì</span>
                </button>
                <button class="research-tab" data-section="roundup" onclick="switchResearchTab('roundup')">
                    üì∞ News Roundup
                    <span class="tab-check" id="roundupTabCheck" style="display:none">‚úì</span>
                </button>
                <button class="research-tab" data-section="tips" onclick="switchResearchTab('tips')">
                    üí° Agent Advantage
                    <span class="tab-check" id="tipsTabCheck" style="display:none">‚úì</span>
                </button>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <p id="researchSectionLabel" style="margin: 0;">Researching for: <strong>Curious Claims</strong> section. Search and select one article below.</p>
                <button class="btn-secondary btn" onclick="showUploadLinkModal()" style="padding: 8px 16px; font-size: 13px;">üìé Add Custom Link</button>
            </div>

            <!-- Custom Links Indicator for Research Dashboard -->
            <div id="researchCustomLinksIndicator" style="display: none; font-size: 12px; color: #059669; background: #d1fae5; padding: 8px 12px; margin-bottom: 15px; border-radius: 4px; border: 1px solid #10b981;"></div>

            <!-- Upload Link Modal -->
            <div id="uploadLinkModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 550px; width: 90%; margin: 20px; max-height: 80vh; overflow-y: auto; position: relative;">
                    <!-- Close X Button -->
                    <button onclick="hideUploadLinkModal()" style="position: absolute; top: 12px; right: 12px; background: none; border: none; font-size: 24px; color: #9ca3af; cursor: pointer; padding: 4px 8px; line-height: 1;" onmouseover="this.style.color='#374151'" onmouseout="this.style.color='#9ca3af'">&times;</button>

                    <h3 id="uploadLinkModalTitle" style="margin: 0 0 15px 0; color: #374151; padding-right: 30px;">üìé Add Custom Article Links to <span id="modalSectionName">Curious Claims</span></h3>
                    <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">Paste links to articles you'd like to include. AI will analyze each and add them to your search results.</p>

                    <!-- Added Links List -->
                    <div id="addedLinksList" style="margin-bottom: 15px; display: none;">
                        <p style="font-size: 12px; font-weight: 600; color: #059669; margin-bottom: 8px;">‚úì Added Links:</p>
                        <div id="addedLinksContainer" style="max-height: 150px; overflow-y: auto; border: 1px solid #d1fae5; border-radius: 6px; padding: 8px; background: #ecfdf5;"></div>
                    </div>

                    <input type="text" id="customLinkInput" placeholder="https://example.com/article..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; margin-bottom: 10px;">
                    <div id="uploadLinkError" style="color: #dc2626; font-size: 13px; margin-bottom: 15px; display: none;"></div>

                    <div style="display: flex; gap: 10px; justify-content: space-between; align-items: center;">
                        <button class="btn" id="fetchArticleBtn" onclick="fetchCustomArticle()" style="background: #059669;">+ Add This Link</button>
                        <button class="btn-secondary btn" onclick="hideUploadLinkModal()">Done</button>
                    </div>

                    <!-- Add Another Link section - appears after first link -->
                    <div id="addAnotherLinkSection" style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                        <p style="font-size: 13px; color: #6b7280; margin-bottom: 10px;">Add another link:</p>
                        <input type="text" id="anotherLinkInput" placeholder="https://example.com/another-article..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; margin-bottom: 10px;">
                        <button class="btn" onclick="fetchAnotherCustomArticle()" style="background: #059669;">+ Add This Link</button>
                    </div>
                </div>
            </div>

            <div class="research-dashboard">
                <!-- Card 1: Perplexity Research -->
                <div class="research-card" id="perplexityCard">
                    <div class="research-card-header">
                        <span class="research-card-title">üîÆ Perplexity Research</span>
                        <span class="research-card-badge">AI + Citations</span>
                    </div>
                    <p class="research-card-description">Searches the web via Perplexity AI, then GPT-5.2 transforms findings into newsletter-ready articles with agent-specific insights.</p>
                    <div class="research-card-filters">
                        <input type="text" id="perplexityQuery" placeholder="e.g., insurance fraud, strange claim, lawsuit verdict..." value="unusual bizarre insurance claim lawsuit settlement story">
                        <select id="perplexityTimeWindow">
                            <option value="7d">Last 7 days</option>
                            <option value="30d" selected>Last 30 days</option>
                            <option value="90d">Last 90 days</option>
                        </select>
                    </div>
                    <button class="research-card-search-btn" onclick="searchPerplexity()">Search with Perplexity</button>
                    <div class="research-card-results" id="perplexityResults">
                        <p style="text-align: center; color: #999; padding: 20px;">Enter a topic and search</p>
                    </div>
                </div>

                <!-- Card 2: Insight Builder -->
                <div class="research-card" id="insightCard">
                    <div class="research-card-header">
                        <span class="research-card-title">üìä Insight Builder</span>
                        <span class="research-card-badge">All Signals</span>
                    </div>
                    <p class="research-card-description">Scans P&C insurance news signals via OpenAI web search, then GPT-5.2 analyzes impact on agents and generates actionable headlines.</p>
                    <div class="research-card-filters">
                        <span style="color: #666; font-size: 0.8em;">Auto, Home, Commercial, Claims, Regulations, Technology, Market Trends</span>
                        <select id="insightTimeWindow">
                            <option value="7d">Last 7 days</option>
                            <option value="30d" selected>Last 30 days</option>
                            <option value="90d">Last 90 days</option>
                        </select>
                    </div>
                    <button class="research-card-search-btn" onclick="searchInsights()">Search All 8 Signals</button>
                    <div class="research-card-results" id="insightResults">
                        <p style="text-align: center; color: #999; padding: 20px;">Click to analyze all 8 market signals</p>
                    </div>
                </div>

                <!-- Card 3: Source Explorer -->
                <div class="research-card" id="explorerCard">
                    <div class="research-card-header">
                        <span class="research-card-title">üì∞ Source Explorer</span>
                        <span class="research-card-badge">Industry</span>
                    </div>
                    <p class="research-card-description">Searches curated insurance industry sources, then GPT-5.2 extracts story angles and agent implications.</p>
                    <div style="background: #f8fafc; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 11px; color: #64748b;">
                        <strong style="color: #374151;">Curated Sources:</strong><br>
                        insurancenewsnet.com ‚Ä¢ insurancejournal.com ‚Ä¢ propertycasualty360.com ‚Ä¢ claimsjournal.com ‚Ä¢ carriermanagement.com ‚Ä¢ thinkadvisor.com ‚Ä¢ dig-in.com
                    </div>
                    <div class="research-card-filters">
                        <div class="checkbox-group" style="margin-bottom: 10px;">
                            <label><input type="checkbox" value="insurance" checked class="explorerPack"> Insurance News</label>
                            <label><input type="checkbox" value="claims" class="explorerPack"> Claims</label>
                            <label><input type="checkbox" value="regulations" class="explorerPack"> Regulations</label>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <select id="explorerTimeFrame" style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 13px; background: white; cursor: pointer; min-width: 120px;">
                                <option value="7d">Last 7 days</option>
                                <option value="30d" selected>Last 30 days</option>
                                <option value="90d">Last 90 days</option>
                            </select>
                        </div>
                        <input type="text" id="explorerQuery" placeholder="e.g., P&C news, agent tips..." value="P&C insurance agent news" style="width: 100%;">
                    </div>
                    <button class="research-card-search-btn" onclick="searchSources()">Search Sources</button>
                    <div class="research-card-results" id="explorerResults">
                        <p style="text-align: center; color: #999; padding: 20px;">Select source packs and search</p>
                    </div>
                </div>
            </div>

            <!-- Selection Progress Tracker -->
            <div class="selection-progress-tracker">
                <div class="selection-progress-items">
                    <div class="selection-progress-item" id="progressClaims" onclick="switchResearchTab('claims')">
                        <span class="progress-icon">üîç</span>
                        <span class="progress-label">Curious Claims</span>
                        <span class="progress-check" id="checkClaims"></span>
                    </div>
                    <div class="selection-progress-item" id="progressRoundup" onclick="switchResearchTab('roundup')">
                        <span class="progress-icon">üì∞</span>
                        <span class="progress-label">News Roundup</span>
                        <span class="progress-check" id="checkRoundup"></span>
                    </div>
                    <div class="selection-progress-item" id="progressTips" onclick="switchResearchTab('tips')">
                        <span class="progress-icon">üí°</span>
                        <span class="progress-label">Agent Advantage</span>
                        <span class="progress-check" id="checkTips"></span>
                    </div>
                </div>
                <div class="selection-progress-actions">
                    <button class="btn-secondary btn" onclick="showStep('2-spotlight')">‚Üê Back</button>
                    <button class="btn" id="researchNextBtn" disabled onclick="generateContent()">Generate Newsletter ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Step 3: Researching Articles (GPT-5.2 research stage) -->
        <div class="step" id="step3">
            <div class="loading">
                <div class="spinner"></div>
                <h3>Researching Your Articles...</h3>
                <p style="color: #666;">GPT-5.2 is analyzing your selections and building detailed summaries</p>
                <div class="research-progress" style="margin-top: 20px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto;">
                    <div id="researchClaimsStatus" style="padding: 8px 0; border-bottom: 1px solid #eee;">
                        <span style="margin-right: 10px;">üîç</span> CURIOUS CLAIMS: <span style="color: #666;">Waiting...</span>
                    </div>
                    <div id="researchRoundupStatus" style="padding: 8px 0; border-bottom: 1px solid #eee;">
                        <span style="margin-right: 10px;">üì∞</span> NEWS ROUNDUP: <span style="color: #666;">Waiting...</span>
                    </div>
                    <div id="researchSpotlightStatus" style="padding: 8px 0; border-bottom: 1px solid #eee;">
                        <span style="margin-right: 10px;">‚≠ê</span> INSURNEWS SPOTLIGHT: <span style="color: #666;">Waiting...</span>
                    </div>
                    <div id="researchTipsStatus" style="padding: 8px 0;">
                        <span style="margin-right: 10px;">üí°</span> AGENT ADVANTAGE: <span style="color: #666;">Waiting...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Writing Content (Opus 4.5 writing stage) -->
        <div class="step" id="step4">
            <div class="loading">
                <div class="spinner"></div>
                <h3>Writing Newsletter Content...</h3>
                <p style="color: #666;" id="aiModelText">Claude Opus 4.5 is crafting your newsletter sections...</p>
            </div>
        </div>

        <!-- Step 5: Review Content -->
        <div class="step" id="step5">
            <h2>‚úèÔ∏è Review & Edit Content</h2>
            <p>Your AI-generated newsletter is ready! Edit any section before continuing.</p>

            <div id="generatedContent" class="content-section" contenteditable="true" style="border: 2px dashed #e5e7eb; padding: 20px; border-radius: 8px; min-height: 400px;">
                <!-- Content will be displayed here -->
            </div>

            <div class="buttons">
                <button class="btn-secondary btn" onclick="showStep('2-research')">‚Üê Back</button>
                <button class="btn" onclick="checkBrandGuidelines()">Check Brand Guidelines ‚Üí</button>
            </div>
        </div>

        <!-- Step 6: Brand Guidelines Check -->
        <div class="step" id="step6">
            <div class="loading">
                <div class="spinner"></div>
                <h3>Checking Brand Guidelines...</h3>
                <p style="color: #666;">AI is reviewing content for tone, style, and brand consistency</p>
            </div>
        </div>

        <!-- Step 7: Brand Guidelines Results -->
        <div class="step" id="step7">
            <h2>‚úÖ Brand Guidelines Check</h2>
            <p>Your content has been reviewed for brand consistency.</p>

            <div id="brandCheckResults" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <!-- Results will be displayed here -->
            </div>

            <!-- Export to Google Docs & Email Section -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">
                <h3 style="margin: 0 0 10px 0; color: #008181;">üìÑ Export to Google Docs & Email</h3>
                <p style="font-size: 14px; color: #666; margin-bottom: 20px;">Hit export and once complete, you can auto email the exported link to your team.</p>

                <!-- Primary Export Button -->
                <button class="btn" onclick="exportToGoogleDocs()" id="exportDocsBtn" style="background: #4285f4;">
                    <span id="exportDocsBtnText">üìÑ Export to Google Docs</span>
                </button>

                <!-- Export Result (shows after export) -->
                <div id="exportDocsResult" style="display: none; margin-top: 20px; padding: 15px; border-radius: 6px;"></div>

                <!-- Email Section (hidden until export succeeds) -->
                <div id="emailAfterExportSection" style="display: none; margin-top: 20px; border-top: 2px solid #e5e7eb; padding-top: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #374151;">‚úâÔ∏è Email the Google Doc Link</h4>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px; font-size: 14px;">Select recipients:</label>

                        <!-- Team member checkboxes -->
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; padding: 12px; background: #f9fafb; border-radius: 6px;">
                            <label style="display: flex; align-items: center; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" class="docRecipientCheckbox" value="john.ortbal@brite.co" checked style="margin-right: 8px; width: 16px; height: 16px;">
                                <span>John Ortbal (john.ortbal@brite.co)</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" class="docRecipientCheckbox" value="stef.lynn@brite.co" checked style="margin-right: 8px; width: 16px; height: 16px;">
                                <span>Stef Lynn (stef.lynn@brite.co)</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" class="docRecipientCheckbox" value="selena.fragassi@brite.co" checked style="margin-right: 8px; width: 16px; height: 16px;">
                                <span>Selena Fragassi (selena.fragassi@brite.co)</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" class="docRecipientCheckbox" value="dylanne.crugnale@brite.co" checked style="margin-right: 8px; width: 16px; height: 16px;">
                                <span>Dylanne Crugnale (dylanne.crugnale@brite.co)</span>
                            </label>
                        </div>

                        <!-- Additional emails input -->
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px;">Additional emails (comma-separated):</label>
                        <input type="text" id="docAdditionalEmails" placeholder="email1@example.com, email2@example.com" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 4px; font-size: 14px; margin-bottom: 15px;">

                        <!-- Send Email Button -->
                        <button class="btn" onclick="sendExportEmail()" id="sendExportEmailBtn" style="background: #059669;">
                            <span id="sendExportEmailBtnText">‚úâÔ∏è Send Email</span>
                        </button>

                        <div id="emailSendResult" style="display: none; margin-top: 15px; padding: 12px; border-radius: 6px;"></div>
                    </div>
                </div>
            </div>

            <div class="buttons">
                <button class="btn-secondary btn" onclick="showStep(5)">‚Üê Back to Edit</button>
                <button class="btn-secondary btn" onclick="exportBrandCheckResults()">üìã Export Brand Check</button>
                <button class="btn" onclick="generateImages()">Continue to Image Prompts ‚Üí</button>
            </div>
        </div>

        <!-- Step 8: Edit Image Prompts -->
        <div class="step" id="step8">
            <h2>üé® Image Generation</h2>
            <p>Review prompts and select styles, then generate images</p>

            <div id="promptGenerationLoading">
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>Generating Prompts...</h3>
                    <p style="color: #666;">Analyzing your articles with Claude AI...</p>
                </div>
            </div>

            <div id="promptEditing" style="display: none;">
                <!-- Brite Spot Prompt -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">
                    <h3 style="margin: 0 0 5px 0;">‚ú® Brite Spot Image Prompt</h3>
                    <p style="font-size: 13px; color: #666; margin-bottom: 15px;" id="briteSpotPromptArticle"></p>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px;">Image Style:</label>
                        <select id="briteSpotImageStyle" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; background: white;" onchange="updatePromptWithStyle('briteSpot')">
                            <option value="photorealistic">Photorealistic (Default)</option>
                            <option value="sketch">Sketch / Illustration</option>
                            <option value="watercolor">Watercolor</option>
                            <option value="modern-flat">Modern Flat Design</option>
                            <option value="magazine">Magazine Editorial</option>
                            <option value="cartoon">Cartoon</option>
                            <option value="infographic">Infographic / Data Viz</option>
                        </select>
                    </div>
                    <textarea id="briteSpotImagePromptText" rows="3" style="width: 100%; padding: 12px; border: 2px solid #3b82f6; border-radius: 6px; font-size: 14px; font-family: inherit;" placeholder="Prompt will appear here..."></textarea>
                </div>

                <!-- Curious Claims Prompt -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">
                    <h3 style="margin: 0 0 5px 0;">üîç Curious Claims Image Prompt</h3>
                    <p style="font-size: 13px; color: #666; margin-bottom: 15px;" id="claimsPromptArticle"></p>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px;">Image Style:</label>
                        <select id="claimsImageStyle" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; background: white;" onchange="updatePromptWithStyle('claims')">
                            <option value="photorealistic">Photorealistic (Default)</option>
                            <option value="sketch">Sketch / Illustration</option>
                            <option value="watercolor">Watercolor</option>
                            <option value="modern-flat">Modern Flat Design</option>
                            <option value="magazine">Magazine Editorial</option>
                            <option value="cartoon">Cartoon</option>
                            <option value="infographic">Infographic / Data Viz</option>
                        </select>
                    </div>
                    <textarea id="claimsImagePromptText" rows="3" style="width: 100%; padding: 12px; border: 2px solid #3b82f6; border-radius: 6px; font-size: 14px; font-family: inherit;" placeholder="Prompt will appear here..."></textarea>
                </div>

                <!-- Spotlight Prompt -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">
                    <h3 style="margin: 0 0 5px 0;">‚≠ê InsurNews Spotlight Image Prompt</h3>
                    <p style="font-size: 13px; color: #666; margin-bottom: 15px;" id="spotlightPromptArticle"></p>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px;">Image Style:</label>
                        <select id="spotlightImageStyle" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; background: white;" onchange="updatePromptWithStyle('spotlight')">
                            <option value="photorealistic">Photorealistic (Default)</option>
                            <option value="sketch">Sketch / Illustration</option>
                            <option value="watercolor">Watercolor</option>
                            <option value="modern-flat">Modern Flat Design</option>
                            <option value="magazine">Magazine Editorial</option>
                            <option value="cartoon">Cartoon</option>
                            <option value="infographic">Infographic / Data Viz</option>
                        </select>
                    </div>
                    <textarea id="spotlightImagePromptText" rows="3" style="width: 100%; padding: 12px; border: 2px solid #3b82f6; border-radius: 6px; font-size: 14px; font-family: inherit;" placeholder="Prompt will appear here..."></textarea>
                </div>

                <!-- Agent Advantage Prompt -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">
                    <h3 style="margin: 0 0 5px 0;">üí° Agent Advantage Image Prompt</h3>
                    <p style="font-size: 13px; color: #666; margin-bottom: 15px;" id="tipsPromptArticle"></p>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px;">Image Style:</label>
                        <select id="tipsImageStyle" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; background: white;" onchange="updatePromptWithStyle('tips')">
                            <option value="photorealistic">Photorealistic (Default)</option>
                            <option value="sketch">Sketch / Illustration</option>
                            <option value="watercolor">Watercolor</option>
                            <option value="modern-flat">Modern Flat Design</option>
                            <option value="magazine">Magazine Editorial</option>
                            <option value="cartoon">Cartoon</option>
                            <option value="infographic">Infographic / Data Viz</option>
                        </select>
                    </div>
                    <textarea id="tipsImagePromptText" rows="3" style="width: 100%; padding: 12px; border: 2px solid #3b82f6; border-radius: 6px; font-size: 14px; font-family: inherit;" placeholder="Prompt will appear here..."></textarea>
                </div>

                <div class="buttons">
                    <button class="btn-secondary btn" onclick="showStep(7)">‚Üê Back</button>
                    <button class="btn-secondary btn" onclick="generateImages(true)" style="background: #f59e0b; color: white; border-color: #f59e0b;">üîÑ Regenerate Prompts</button>
                    <button class="btn" onclick="generateImagesFromPrompts()">Generate Images ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Step 9: Generating Images -->
        <div class="step" id="step9">
            <div class="loading">
                <div class="spinner"></div>
                <h3>Generating Images...</h3>
                <p style="color: #666;" id="imageGenStatus2">Creating images with Gemini...</p>
                <div style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 8px; padding: 15px; margin-top: 20px; max-width: 500px; margin-left: auto; margin-right: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 14px; font-weight: 600; color: #1e40af;">Progress</span>
                        <span style="font-size: 14px; font-weight: 600; color: #1e40af;" id="imageGenProgress2">0%</span>
                    </div>
                    <div style="background: #dbeafe; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div id="imageGenProgressBar2" style="background: linear-gradient(90deg, #3b82f6, #2563eb); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                    </div>
                    <p style="margin-top: 10px; margin-bottom: 0; font-size: 13px; color: #64748b; text-align: center;" id="imageGenTime2">Estimated time: ~20-30 seconds</p>
                </div>
            </div>
        </div>

        <!-- Step 10: Review Article Images (Brite Spot, Claims, Spotlight, Tips) -->
        <div class="step" id="step10">
            <h2>üñºÔ∏è Article Images</h2>
            <p>Review and customize images for your newsletter sections</p>

            <!-- Brite Spot Image -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">
                <h3 style="margin: 0 0 10px 0;">‚ú® Brite Spot Image</h3>
                <p style="font-size: 14px; color: #666; margin-bottom: 15px;" id="briteSpotImageTitle">For your Brite Spot section</p>

                <div id="briteSpotImagePreview" style="background: #f5f5f5; border: 2px dashed #ddd; border-radius: 8px; min-height: 300px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                    <div style="text-align: center; color: #999;">
                        <div class="spinner" style="margin: 0 auto 10px;"></div>
                        <div>Generating image...</div>
                    </div>
                </div>

                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Image Prompt:</label>
                    <textarea id="briteSpotPrompt" rows="2" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 4px; font-size: 14px;" placeholder="Describe the image you want..."></textarea>
                </div>
                <button class="btn-secondary btn" onclick="regenerateImage('briteSpot')" style="margin-right: 10px;">üîÑ Regenerate</button>
                <button class="btn-secondary btn" onclick="exportImage('briteSpot')" style="margin-right: 10px;">üì• Export</button>
                <button class="btn-secondary btn" onclick="resizeImage('briteSpot')">üîç Resize</button>
            </div>

            <!-- Claims Image -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">
                <h3 style="margin: 0 0 10px 0;">üîç Curious Claims Image</h3>
                <p style="font-size: 14px; color: #666; margin-bottom: 15px;" id="claimsImageTitle">For your claims story</p>

                <div id="claimsImagePreview" style="background: #f5f5f5; border: 2px dashed #ddd; border-radius: 8px; min-height: 300px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                    <div style="text-align: center; color: #999;">
                        <div class="spinner" style="margin: 0 auto 10px;"></div>
                        <div>Generating image...</div>
                    </div>
                </div>

                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Image Prompt:</label>
                    <textarea id="claimsPrompt" rows="2" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 4px; font-size: 14px;" placeholder="Describe the image you want..."></textarea>
                </div>
                <button class="btn-secondary btn" onclick="regenerateImage('claims')" style="margin-right: 10px;">üîÑ Regenerate</button>
                <button class="btn-secondary btn" onclick="exportImage('claims')" style="margin-right: 10px;">üì• Export</button>
                <button class="btn-secondary btn" onclick="resizeImage('claims')">üîç Resize</button>
            </div>

            <!-- Spotlight Image -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">
                <h3 style="margin: 0 0 10px 0;">‚≠ê InsurNews Spotlight Image</h3>
                <p style="font-size: 14px; color: #666; margin-bottom: 15px;" id="spotlightImageTitle">For your spotlight story</p>

                <div id="spotlightImagePreview" style="background: #f5f5f5; border: 2px dashed #ddd; border-radius: 8px; min-height: 300px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                    <div style="text-align: center; color: #999;">
                        <div class="spinner" style="margin: 0 auto 10px;"></div>
                        <div>Generating image...</div>
                    </div>
                </div>

                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Image Prompt:</label>
                    <textarea id="spotlightPrompt" rows="2" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 4px; font-size: 14px;" placeholder="Describe the image you want..."></textarea>
                </div>
                <button class="btn-secondary btn" onclick="regenerateImage('spotlight')" style="margin-right: 10px;">üîÑ Regenerate</button>
                <button class="btn-secondary btn" onclick="exportImage('spotlight')" style="margin-right: 10px;">üì• Export</button>
                <button class="btn-secondary btn" onclick="resizeImage('spotlight')">üîç Resize</button>
            </div>

            <!-- Tips Image -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">
                <h3 style="margin: 0 0 10px 0;">üí° Agent Advantage Image</h3>
                <p style="font-size: 14px; color: #666; margin-bottom: 15px;" id="tipsImageTitle">For your agent tips section</p>

                <div id="tipsImagePreview" style="background: #f5f5f5; border: 2px dashed #ddd; border-radius: 8px; min-height: 300px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                    <div style="text-align: center; color: #999;">
                        <div class="spinner" style="margin: 0 auto 10px;"></div>
                        <div>Generating image...</div>
                    </div>
                </div>

                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Image Prompt:</label>
                    <textarea id="tipsPrompt" rows="2" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 4px; font-size: 14px;" placeholder="Describe the image you want..."></textarea>
                </div>
                <button class="btn-secondary btn" onclick="regenerateImage('tips')" style="margin-right: 10px;">üîÑ Regenerate</button>
                <button class="btn-secondary btn" onclick="exportImage('tips')" style="margin-right: 10px;">üì• Export</button>
                <button class="btn-secondary btn" onclick="resizeImage('tips')">üîç Resize</button>
            </div>

            <!-- Tip at bottom of page -->
            <div style="background: #ecfdf5; border-left: 4px solid #10b981; padding: 12px 16px; border-radius: 6px; margin-top: 20px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 16px;">‚úì</span>
                    <span style="font-size: 13px; color: #065f46;"><strong>Ready for Ontraport:</strong> Exported images are already sized correctly ‚Äî no resizing needed!</span>
                </div>
            </div>

            <div class="buttons">
                <button class="btn-secondary btn" onclick="goBackToPrompts()">‚Üê Back to Prompts</button>
                <button class="btn-secondary btn" onclick="generateImagesFromPrompts(true)" style="background: #f59e0b; color: white; border-color: #f59e0b;">üîÑ Regenerate All Images</button>
                <button class="btn" onclick="showSubjectLineStep()">Continue to Subject Line ‚Üí</button>
            </div>
        </div>

        <!-- Step 10.4: Generating Meme Concept (Loading) -->
        <div class="step" id="step10_4">
            <div class="loading">
                <div class="spinner"></div>
                <h3>Generating Meme Concept...</h3>
                <p style="color: #666;">Claude is analyzing your newsletter content to create a custom meme concept...</p>
                <p style="color: #999; font-size: 14px; margin-top: 10px;">This will take just a moment...</p>
            </div>
        </div>

        <!-- Step 10.5: Meme Prompt Generation -->
        <div class="step" id="step10_5">
            <h2>üí° Meme Concept</h2>
            <p>Based on your newsletter content, here's a suggested meme concept</p>

            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0;">AI-Generated Meme Concept</h3>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Visual Scene:</label>
                    <textarea id="memeScenePrompt" rows="2" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 4px; font-size: 14px;" placeholder="Description of what the image should show..."></textarea>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">Describe what the meme image should visually show (15-25 words)</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Top Text:</label>
                    <input type="text" id="memeTopText" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 4px; font-size: 14px; text-transform: uppercase;" placeholder="TOP TEXT (3-6 WORDS)">
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">The setup (3-6 words, all caps)</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Bottom Text:</label>
                    <input type="text" id="memeBottomText" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 4px; font-size: 14px; text-transform: uppercase;" placeholder="BOTTOM TEXT (3-8 WORDS)">
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">The punchline (3-8 words, all caps)</p>
                </div>

                <button class="btn-secondary btn" onclick="generateMemePrompt(true)" style="margin-top: 10px;">üîÑ Regenerate Concept</button>
            </div>

            <div class="buttons">
                <button class="btn-secondary btn" onclick="goBackToArticleImages()">‚Üê Back to Images</button>
                <button class="btn" onclick="proceedToMemeGeneration()">Generate Meme ‚Üí</button>
            </div>
        </div>

        <!-- Step 11: Meme Generation -->
        <div class="step" id="step11">
            <h2>üòÑ Monthly Meme</h2>
            <p>Generate or upload a fun meme for your newsletter header</p>

            <!-- Info callout about meme sizing -->
            <div style="background: #ecfdf5; border-left: 4px solid #10b981; padding: 15px 20px; border-radius: 6px; margin-bottom: 20px;">
                <div style="display: flex; align-items: start; gap: 10px;">
                    <div style="font-size: 20px;">‚úì</div>
                    <div>
                        <div style="font-weight: 600; color: #047857; margin-bottom: 5px;">Ready for Ontraport</div>
                        <div style="font-size: 14px; color: #065f46; line-height: 1.5;">
                            Your meme will be automatically sized to <strong>480√ó480px</strong> ‚Äî perfect for hosting on Ontraport!
                        </div>
                    </div>
                </div>
            </div>

            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">
                <h3 style="margin: 0 0 10px 0;">üì± Monthly Meme</h3>
                <p style="font-size: 14px; color: #666; margin-bottom: 15px;">Funny, shareable image for the top of your newsletter</p>

                <div id="memePreview" style="background: #f5f5f5; border: 2px dashed #ddd; border-radius: 8px; min-height: 300px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                    <div style="text-align: center; color: #999;">
                        <div class="spinner" style="margin: 0 auto 10px;"></div>
                        <div>Generating meme...</div>
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Meme Prompt:</label>
                    <textarea id="memePrompt" rows="2" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 4px; font-size: 14px;" placeholder="Describe the meme you want..."></textarea>
                </div>

                <button class="btn-secondary btn" onclick="regenerateImage('meme')" style="margin-right: 10px;">üîÑ Regenerate</button>
                <button class="btn-secondary btn" onclick="exportImage('meme')" style="margin-right: 10px;">üì• Export</button>
                <button class="btn-secondary btn" onclick="resizeImage('meme')">üìê Resize</button>

                <div style="margin: 20px 0; padding: 15px; background: #f9fafb; border-radius: 8px; border: 2px dashed #e5e7eb;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px;">Or Upload Your Own:</h4>
                    <input type="file" id="memeUpload" accept="image/*" style="display: none;" onchange="handleMemeUpload(event)">
                    <button class="btn-secondary btn" onclick="document.getElementById('memeUpload').click()">üìÅ Upload Image</button>
                </div>
            </div>

            <div class="buttons">
                <button class="btn-secondary btn" onclick="goBackToMemeConceptWithState()">‚Üê Back to Concept</button>
                <button class="btn-secondary btn" onclick="proceedToMemeGeneration(true)" style="background: #f59e0b; color: white; border-color: #f59e0b;">üîÑ Regenerate Meme</button>
                <button class="btn" onclick="showStep(12)">Continue to Subject Line ‚Üí</button>
            </div>
        </div>

        <!-- Step 12: Subject Line & Preheader -->
        <div class="step" id="step12">
            <h2>‚úâÔ∏è Subject Line & Preheader</h2>
            <p>Claude will analyze your content and suggest compelling subject lines and preheaders</p>

            <!-- Tone Selection (shown first) -->
            <div id="toneSelection" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #3b82f6;">
                <h3 style="margin: 0 0 10px 0;">üé® Select Tone</h3>
                <p style="font-size: 14px; color: #666; margin-bottom: 15px;">Choose the tone for your subject line and preheader</p>
                <select id="subjectLineTone" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; background: white; margin-bottom: 15px;">
                    <option value="professional">Professional & Informative</option>
                    <option value="friendly">Friendly & Conversational</option>
                    <option value="urgent">Urgent & Action-Oriented</option>
                    <option value="playful">Playful & Fun</option>
                    <option value="exclusive">Exclusive & Premium</option>
                </select>
                <button class="btn" onclick="generateWithSelectedTone()" style="width: 100%;">Generate Subject Lines ‚Üí</button>
            </div>

            <div id="subjectLineLoading" style="display: none;">
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>Generating Options...</h3>
                    <p style="color: #666;">Claude is reviewing your newsletter content...</p>
                </div>
            </div>

            <div id="subjectLineOptions" style="display: none;">
                <!-- Subject Line Options -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">
                    <h3 style="margin: 0 0 15px 0;">üìß Subject Line Options</h3>
                    <p style="font-size: 14px; color: #666; margin-bottom: 15px;">Choose one or edit to create your own</p>

                    <div id="subjectOptions" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                        <!-- Options will be populated here -->
                    </div>

                    <div style="margin-top: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px;">Your Subject Line:</label>
                        <input type="text" id="finalSubjectLine" placeholder="Selected or custom subject line" style="width: 100%; padding: 12px; border: 2px solid #3b82f6; border-radius: 4px; font-size: 16px; font-weight: 500;">
                    </div>
                </div>

                <!-- Preheader Options -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">
                    <h3 style="margin: 0 0 15px 0;">üëÅÔ∏è Preheader Options</h3>
                    <p style="font-size: 14px; color: #666; margin-bottom: 15px;">Choose one or edit to create your own</p>

                    <div id="preheaderOptions" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                        <!-- Options will be populated here -->
                    </div>

                    <div style="margin-top: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px;">Your Preheader:</label>
                        <input type="text" id="finalPreheader" placeholder="Selected or custom preheader" style="width: 100%; padding: 12px; border: 2px solid #3b82f6; border-radius: 4px; font-size: 16px;">
                    </div>
                </div>

                <!-- Regenerate with different tone -->
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px dashed #e5e7eb;">
                    <p style="margin: 0 0 10px 0; font-size: 14px; color: #666;">Not satisfied? Try a different tone:</p>
                    <select id="regenerateTone" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 4px; font-size: 14px; background: white; margin-bottom: 10px;">
                        <option value="professional">Professional & Informative</option>
                        <option value="friendly">Friendly & Conversational</option>
                        <option value="urgent">Urgent & Action-Oriented</option>
                        <option value="playful">Playful & Fun</option>
                        <option value="exclusive">Exclusive & Premium</option>
                    </select>
                    <button class="btn-secondary btn" onclick="regenerateSubjectLines()" style="width: 100%;">üîÑ Regenerate with New Tone</button>
                </div>
            </div>

            <div class="buttons">
                <button class="btn-secondary btn" onclick="showStep(10)">‚Üê Back to Images</button>
                <button class="btn" onclick="showNewsletterPreview()">Continue to Preview ‚Üí</button>
            </div>
        </div>

        <!-- Step 13: Get HTML Code -->
        <div class="step" id="step13">
            <h2>üíª Newsletter Preview</h2>
            <p>Review your complete newsletter before sending</p>

            <!-- Editing Instructions -->
            <div style="background: #e0f2fe; border: 2px solid #0284c7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0 0 10px 0; font-size: 14px; color: #0c4a6e;"><strong>‚úèÔ∏è Live Editing:</strong> Click any text in the preview below to edit it directly.</p>
                <button class="btn" onclick="savePreviewEdits()" style="background: #0284c7; padding: 10px 20px; font-size: 14px;">üíæ Save Changes to HTML</button>
                <span id="saveStatus" style="margin-left: 10px; font-size: 14px; color: #166534; display: none;">‚úì Changes saved!</span>
            </div>

            <!-- Subject Line & Preheader Display -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #3b82f6;">
                <h3 style="margin: 0 0 15px 0;">üìß Email Info</h3>
                <div style="margin-bottom: 12px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px; color: #666;">Subject Line:</label>
                    <div id="previewSubjectLine" contenteditable="true" onblur="saveSubjectEdit(this)" style="padding: 12px; background: #f9fafb; border-radius: 6px; font-size: 16px; font-weight: 500; color: #333; border: 2px solid transparent; transition: border-color 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='transparent'; saveSubjectEdit(this)">Your subject line will appear here</div>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px; color: #666;">Preheader:</label>
                    <div id="previewPreheader" contenteditable="true" onblur="savePreheaderEdit(this)" style="padding: 12px; background: #f9fafb; border-radius: 6px; font-size: 14px; color: #666; border: 2px solid transparent; transition: border-color 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='transparent'; savePreheaderEdit(this)">Your preheader will appear here</div>
                </div>
            </div>

            <div id="newsletterPreview" style="background: #f5f5f5; border: 1px solid #ddd; border-radius: 8px; padding: 40px 20px; max-width: 640px; margin: 20px auto;">
                <!-- Full newsletter HTML will be displayed here -->
            </div>

            <div id="htmlCodeView" style="display: none; background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 8px; margin: 20px 0; max-height: 500px; overflow-y: auto;">
                <pre id="htmlCode" style="margin: 0; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace; font-size: 12px;"></pre>
            </div>

            <div class="buttons">
                <button class="btn-secondary btn" onclick="showStep(12)">‚Üê Back to Subject Line</button>
                <button class="btn-secondary btn" onclick="toggleHTMLView()" id="htmlViewBtn">üìù View HTML Code</button>
                <button class="btn-secondary btn" onclick="copyHTMLCode()">üìã Copy HTML</button>
                <button class="btn" onclick="showStep(15)">Push to Ontraport ‚Üí</button>
            </div>
        </div>

        <!-- Step 14: Send Test Email -->
        <div class="step" id="step14">
            <h2>üìß Send Test Email</h2>
            <p>Send a test version to your email to preview before pushing to Ontraport</p>

            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Test Email Address:</label>
                    <input type="email" id="testEmail" placeholder="your@email.com" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 4px; font-size: 14px;">
                </div>

                <button class="btn" onclick="sendTestEmail()">üìß Send Test</button>
            </div>

            <div class="buttons">
                <button class="btn-secondary btn" onclick="showStep(13)">‚Üê Back to HTML Code</button>
                <button class="btn" onclick="showStep(15)">Push to Ontraport ‚Üí</button>
            </div>
        </div>

        <!-- Step 15: Push to Ontraport -->
        <div class="step" id="step15">
            <h2>üöÄ Push to Ontraport</h2>
            <p>Send your newsletter to Ontraport with pre-configured BriteCo settings</p>

            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">
                <div style="padding: 15px; background-color: #f0fdf4; border-radius: 6px; border-left: 4px solid #22c55e; margin-bottom: 20px;">
                    <p style="margin: 0; font-weight: 600; color: #166534;">Subject Line:</p>
                    <p id="ontraportSubjectDisplay" style="margin: 5px 0 0 0; font-size: 16px; color: #272d3f;"></p>
                </div>
                <!-- Hidden input for pushToOntraport function -->
                <input type="hidden" id="subject">

                <button class="btn" onclick="pushToOntraport(event)" style="width: 100%; padding: 15px; font-size: 16px;">üöÄ Push to Ontraport</button>
            </div>

            <div class="buttons">
                <button class="btn-secondary btn" onclick="showStep(13)">‚Üê Back to Preview</button>
            </div>
        </div>

    </div>

    <!-- Newsletter Archive Section -->
    <div style="padding: 80px 20px; margin-top: 60px; background: #466F88;">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div style="margin-bottom: 40px; text-align: center;">
                <h2 style="font-size: 36px; color: white; margin-bottom: 12px; font-weight: 700;">Previous Newsletters</h2>
                <p style="color: rgba(255,255,255,0.8); font-size: 16px;">View past newsletters sent to your subscribers</p>
            </div>

            <div id="newsletterArchiveGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 28px;">
                <!-- Archive cards will be loaded here -->
            </div>

            <div id="newsletterArchiveEmpty" style="text-align: center; padding: 60px 20px; color: #999; display: none;">
                <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.3;">üì≠</div>
                <h3 style="color: #666;">No Previous Newsletters</h3>
                <p>Newsletters you publish will appear here</p>
            </div>
        </div>
    </div>

    <!-- Newsletter View Modal -->
    <div id="newsletterModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; overflow: auto;">
        <div style="max-width: 800px; margin: 40px auto; background: white; border-radius: 12px; position: relative;">
            <button onclick="closeNewsletterModal()" style="position: absolute; top: 20px; right: 20px; background: white; border: 2px solid #e5e7eb; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; z-index: 10;">√ó</button>
            <div id="newsletterModalContent" style="padding: 20px; max-height: 80vh; overflow: auto;">
                <!-- Newsletter HTML will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // API base URL
        const API_BASE = window.location.origin;

        // State
        let selectedMonth = '';
        let selectedSeason = '';

        // Newsletter Header Intro state
        let headerIntroContent = '';

        // Brite Spot state
        let briteSpotContent = '';
        let briteSpotBullets = [];  // Array of bullet point strings
        let briteSpotRewritten = '';

        // InsurNews Spotlight state (multi-source)
        let spotlightSelectedArticles = [];  // Array of 3-5 selected articles
        let spotlightSearchResults = { perplexity: [], curated: [], insight: [] };  // Object with arrays for each card
        let spotlightGeneratedContent = null;  // { subheader, h3s, body, sources }
        let spotlightCustomLinks = [];  // Persist custom links separately so they survive searches

        // Research Dashboard state
        let selectedClaims = null;
        let selectedSpotlight = null;  // Selected article for spotlight section
        let selectedRoundup = [];  // Array of up to 5 articles for roundup bullets
        let currentResearchSection = 'claims'; // Track which section we're researching for
        let selectedTips = null;  // Single article for agent tips (generates intro + 5 tips)
        let claimsTopics = [];
        let roundupTopics = [];
        let tipsTopics = [];

        // Track shown articles to avoid duplicates on refresh
        let shownClaimsArticles = [];
        let shownRoundupArticles = [];
        let shownSpotlightArticles = [];
        let shownTipsArticles = [];

        // 3-Card Research Dashboard State
        let researchResults = {
            insight: [],
            explorer: [],
            perplexity: []
        };
        let allResearchResults = [];  // Combined results from all cards

        // Persist custom links for Research Dashboard (survives searches)
        let researchCustomLinks = {
            claims: [],
            roundup: [],
            tips: []
        };

        // Tab-specific search results and state (each tab has its own searches)
        let tabSearchState = {
            claims: {
                results: { insight: [], explorer: [], perplexity: [] },
                htmlCache: { insight: '', explorer: '', perplexity: '' }
            },
            roundup: {
                results: { insight: [], explorer: [], perplexity: [] },
                htmlCache: { insight: '', explorer: '', perplexity: '' }
            },
            tips: {
                results: { insight: [], explorer: [], perplexity: [] },
                htmlCache: { insight: '', explorer: '', perplexity: '' }
            }
        };

        // Meme text overlay state (draggable text boxes)
        let memeTextOverlays = [];
        let selectedMemeTextBox = -1;

        // Month data
        const months = [
            { name: 'january', emoji: '‚ùÑÔ∏è', season: 'winter' },
            { name: 'february', emoji: 'üíù', season: 'winter' },
            { name: 'march', emoji: 'üå∑', season: 'spring' },
            { name: 'april', emoji: 'üå∏', season: 'spring' },
            { name: 'may', emoji: 'üå∫', season: 'spring' },
            { name: 'june', emoji: '‚òÄÔ∏è', season: 'summer' },
            { name: 'july', emoji: 'üéÜ', season: 'summer' },
            { name: 'august', emoji: 'üåª', season: 'summer' },
            { name: 'september', emoji: 'üçÇ', season: 'fall' },
            { name: 'october', emoji: 'üéÉ', season: 'fall' },
            { name: 'november', emoji: 'ü¶É', season: 'fall' },
            { name: 'december', emoji: 'üéÑ', season: 'winter' }
        ];

        // Global helper functions for content extraction
        function cleanContent(content) {
            if (!content) return 'Content not available';

            // If it has a 'raw' property, extract from it
            if (content.raw) {
                try {
                    // Remove markdown code blocks
                    let cleaned = content.raw.replace(/```json\n/g, '').replace(/\n```/g, '');
                    return JSON.parse(cleaned);
                } catch (e) {
                    return content.raw;
                }
            }
            return content;
        }

        function extractContentText(content) {
            if (!content) return '';

            // If it has raw JSON, parse it
            if (content.raw) {
                try {
                    const cleaned = content.raw.replace(/```json\n/g, '').replace(/\n```/g, '');
                    const parsed = JSON.parse(cleaned);

                    // Extract text based on structure
                    if (parsed.short_version) {
                        return `${parsed.short_version} ${parsed.whats_happening || ''} ${parsed.why_matters || ''}`;
                    } else if (parsed.content) {
                        // New single paragraph format for tip/trend
                        return parsed.content;
                    } else if (parsed.intro) {
                        return `${parsed.intro} ${(parsed.steps || []).join(' ')}`;
                    } else if (parsed.overview) {
                        return `${parsed.overview} ${(parsed.examples || []).join(' ')} ${parsed.opportunity || ''}`;
                    }
                    return JSON.stringify(parsed);
                } catch (e) {
                    return content.raw.substring(0, 500);
                }
            }

            if (typeof content === 'string') return content;
            if (content.content) return content.content;
            if (content.short_version) return `${content.short_version} ${content.whats_happening || ''} ${content.why_matters || ''}`;
            return JSON.stringify(content).substring(0, 500);
        }

        // Initialize months
        function initMonths() {
            const grid = document.getElementById('monthGrid');
            months.forEach(month => {
                const card = document.createElement('div');
                card.className = 'month-card';
                card.innerHTML = `
                    <div class="name">${month.name.charAt(0).toUpperCase() + month.name.slice(1)}</div>
                    <div class="season">${month.season}</div>
                `;
                card.onclick = () => selectMonth(month.name, month.season, card);
                grid.appendChild(card);
            });
        }

        function selectMonth(month, season, element) {
            selectedMonth = month;
            selectedSeason = season;

            document.querySelectorAll('.month-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('monthNextBtn').disabled = false;
        }

        // ============================================================================
        // BRITE SPOT FUNCTIONS
        // ============================================================================

        // Update word count for Brite Spot (paragraph + bullets)
        document.addEventListener('DOMContentLoaded', function() {
            const briteSpotInput = document.getElementById('briteSpotInput');
            const briteSpotBulletsInput = document.getElementById('briteSpotBulletsInput');
            if (briteSpotInput) {
                briteSpotInput.addEventListener('input', updateBriteSpotWordCount);
            }
            if (briteSpotBulletsInput) {
                briteSpotBulletsInput.addEventListener('input', updateBriteSpotWordCount);
            }
        });

        function updateBriteSpotWordCount() {
            const paragraphInput = document.getElementById('briteSpotInput');
            const bulletsInput = document.getElementById('briteSpotBulletsInput');
            const counter = document.getElementById('briteSpotWordCount');
            if (counter) {
                // Count words from both paragraph and bullets
                let totalWords = 0;
                if (paragraphInput) {
                    const words = paragraphInput.value.trim().split(/\s+/).filter(w => w.length > 0);
                    totalWords += words.length;
                    briteSpotContent = paragraphInput.value;
                }
                if (bulletsInput) {
                    const words = bulletsInput.value.trim().split(/\s+/).filter(w => w.length > 0);
                    totalWords += words.length;
                }
                counter.textContent = `${totalWords} / 100 words`;
                counter.style.color = totalWords > 100 ? '#dc2626' : '#666';
            }
        }

        // Rewrite state variables
        let headerIntroRewritten = '';
        let briteSpotIntroRewritten = '';
        let briteSpotBulletsRewritten = '';

        // Header Intro rewrite
        async function rewriteHeaderIntro() {
            const input = document.getElementById('headerIntroInput').value.trim();
            const resultDiv = document.getElementById('headerIntroRewriteResult');
            const resultText = document.getElementById('headerIntroRewriteText');

            if (!input) {
                alert('Please enter some content first');
                return;
            }

            resultDiv.style.display = 'block';
            resultText.innerHTML = '<div class="spinner" style="margin: 10px auto;"></div> Rewriting with AI...';

            try {
                const response = await fetch(`${API_BASE}/api/rewrite-section`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: input, section: 'header_intro', month: selectedMonth })
                });

                const data = await response.json();

                if (data.success) {
                    headerIntroRewritten = data.rewritten;
                    resultText.textContent = data.rewritten;
                } else {
                    resultText.innerHTML = `<span style="color: #dc2626;">Error: ${data.error}</span>`;
                }
            } catch (error) {
                resultText.innerHTML = `<span style="color: #dc2626;">Error: ${error.message}</span>`;
            }
        }

        function useHeaderIntroRewrite() {
            if (headerIntroRewritten) {
                document.getElementById('headerIntroInput').value = headerIntroRewritten;
                headerIntroContent = headerIntroRewritten;
                document.getElementById('headerIntroRewriteResult').style.display = 'none';
            }
        }

        // Brite Spot Intro Paragraph rewrite
        async function rewriteBriteSpotIntro() {
            const input = document.getElementById('briteSpotInput').value.trim();
            const resultDiv = document.getElementById('briteSpotIntroRewriteResult');
            const resultText = document.getElementById('briteSpotIntroRewriteText');

            if (!input) {
                alert('Please enter some content first');
                return;
            }

            resultDiv.style.display = 'block';
            resultText.innerHTML = '<div class="spinner" style="margin: 10px auto;"></div> Rewriting with AI...';

            try {
                const response = await fetch(`${API_BASE}/api/rewrite-section`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: input, section: 'brite_spot_intro' })
                });

                const data = await response.json();

                if (data.success) {
                    briteSpotIntroRewritten = data.rewritten;
                    resultText.textContent = data.rewritten;
                } else {
                    resultText.innerHTML = `<span style="color: #dc2626;">Error: ${data.error}</span>`;
                }
            } catch (error) {
                resultText.innerHTML = `<span style="color: #dc2626;">Error: ${error.message}</span>`;
            }
        }

        function useBriteSpotIntroRewrite() {
            if (briteSpotIntroRewritten) {
                document.getElementById('briteSpotInput').value = briteSpotIntroRewritten;
                briteSpotContent = briteSpotIntroRewritten;
                updateBriteSpotWordCount();
                document.getElementById('briteSpotIntroRewriteResult').style.display = 'none';
            }
        }

        // Brite Spot Bullets rewrite
        async function rewriteBriteSpotBullets() {
            const input = document.getElementById('briteSpotBulletsInput').value.trim();
            const resultDiv = document.getElementById('briteSpotRewriteResult');
            const resultText = document.getElementById('briteSpotRewriteText');

            if (!input) {
                alert('Please enter some bullet points first');
                return;
            }

            resultDiv.style.display = 'block';
            resultText.innerHTML = '<div class="spinner" style="margin: 10px auto;"></div> Rewriting with AI...';

            try {
                const response = await fetch(`${API_BASE}/api/rewrite-section`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: input, section: 'brite_spot_bullets' })
                });

                const data = await response.json();

                if (data.success) {
                    briteSpotBulletsRewritten = data.rewritten;
                    resultText.textContent = data.rewritten;
                } else {
                    resultText.innerHTML = `<span style="color: #dc2626;">Error: ${data.error}</span>`;
                }
            } catch (error) {
                resultText.innerHTML = `<span style="color: #dc2626;">Error: ${error.message}</span>`;
            }
        }

        function useBriteSpotRewrite() {
            if (briteSpotBulletsRewritten) {
                document.getElementById('briteSpotBulletsInput').value = briteSpotBulletsRewritten;
                updateBriteSpotWordCount();
                document.getElementById('briteSpotRewriteResult').style.display = 'none';
            }
        }

        // Save Brite Spot page content before moving to next step
        function saveBriteSpotPage() {
            // Save header intro
            const headerIntroInput = document.getElementById('headerIntroInput');
            if (headerIntroInput) {
                headerIntroContent = headerIntroInput.value.trim();
                console.log('[Brite Spot] Saved header intro:', headerIntroContent);
            }

            // Save brite spot paragraph content
            const briteSpotInput = document.getElementById('briteSpotInput');
            if (briteSpotInput) {
                briteSpotContent = briteSpotInput.value.trim();
                console.log('[Brite Spot] Saved paragraph:', briteSpotContent?.substring(0, 100));
            }

            // Save brite spot bullets content
            const briteSpotBulletsInput = document.getElementById('briteSpotBulletsInput');
            if (briteSpotBulletsInput) {
                const bulletsText = briteSpotBulletsInput.value.trim();
                // Parse bullets - split by newline and filter empty lines
                briteSpotBullets = bulletsText.split('\n')
                    .map(line => line.replace(/^[‚Ä¢\-\*]\s*/, '').trim())  // Remove bullet prefixes
                    .filter(line => line.length > 0);
                console.log('[Brite Spot] Saved bullets:', briteSpotBullets);
            }
        }

        // ============================================================================
        // INSURNEWS SPOTLIGHT FUNCTIONS (3-Card Multi-Source)
        // ============================================================================

        // Search Card 1: Perplexity Research
        async function searchSpotlightPerplexity() {
            const query = document.getElementById('spotlightPerplexityQuery').value;
            const timeWindow = document.getElementById('spotlightPerplexityTimeWindow').value;
            const resultsDiv = document.getElementById('spotlightPerplexityResults');

            resultsDiv.innerHTML = '<div class="research-card-loading"><div class="spinner"></div><p>Searching with Perplexity AI & analyzing with GPT-5.2...</p></div>';

            try {
                const response = await fetch(`${API_BASE}/api/v2/search-perplexity`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        time_window: timeWindow,
                        exclude_urls: shownSpotlightArticles
                    })
                });

                const data = await response.json();

                if (data.success && data.results.length > 0) {
                    // Mark these as perplexity source
                    data.results.forEach(r => r.source_card = 'perplexity');

                    // Merge with custom links (custom links come first)
                    const mergedResults = [...spotlightCustomLinks, ...data.results];

                    // Show queries header then results
                    resultsDiv.innerHTML = '';
                    if (data.queries_used && data.queries_used.length > 0) {
                        const headerDiv = document.createElement('div');
                        headerDiv.style.cssText = 'font-size: 11px; color: #666; background: #f5f5f5; padding: 8px; margin-bottom: 10px; border-radius: 4px;';
                        headerDiv.innerHTML = `<strong>Queries:</strong> ${data.queries_used.join(' | ')}`;
                        resultsDiv.appendChild(headerDiv);
                    }

                    // Show custom links indicator if any
                    if (spotlightCustomLinks.length > 0) {
                        const customLinksDiv = document.createElement('div');
                        customLinksDiv.style.cssText = 'font-size: 12px; color: #059669; background: #d1fae5; padding: 8px 12px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #10b981;';
                        customLinksDiv.innerHTML = `<strong>üìé ${spotlightCustomLinks.length} custom link${spotlightCustomLinks.length > 1 ? 's' : ''} added</strong> (shown first)`;
                        resultsDiv.appendChild(customLinksDiv);
                    }

                    displaySpotlightResults(mergedResults, 'spotlightPerplexityResults', true);
                } else {
                    let html = '';
                    if (data.queries_used && data.queries_used.length > 0) {
                        html += `<div style="font-size: 11px; color: #666; background: #f5f5f5; padding: 8px; margin-bottom: 10px; border-radius: 4px;">
                            <strong>Queries tried:</strong><br>${data.queries_used.join('<br>')}
                        </div>`;
                    }
                    html += `<p style="text-align: center; color: #999; padding: 20px;">No articles found. Try a different search term.</p>`;
                    resultsDiv.innerHTML = html;
                }
            } catch (error) {
                console.error('Perplexity search error:', error);
                resultsDiv.innerHTML = `<p style="color: #c00; padding: 20px;">Error: ${error.message}</p>`;
            }
        }

        // Search Card 2: Insight Builder (Industry Signals)
        async function searchSpotlightSignals() {
            const timeWindow = document.getElementById('spotlightSignalsTimeWindow').value;
            const resultsDiv = document.getElementById('spotlightSignalsResults');

            resultsDiv.innerHTML = '<div class="research-card-loading"><div class="spinner"></div><p>Scanning all 8 market signals...</p></div>';

            try {
                const response = await fetch(`${API_BASE}/api/v2/search-insights`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        time_window: timeWindow,
                        exclude_urls: shownSpotlightArticles
                    })
                });

                const data = await response.json();

                if (data.success && data.results.length > 0) {
                    // Mark these as insights source
                    data.results.forEach(r => r.source_card = 'insights');

                    // Show signals searched then results
                    resultsDiv.innerHTML = '';
                    if (data.signals_searched && data.signals_searched.length > 0) {
                        const headerDiv = document.createElement('div');
                        headerDiv.style.cssText = 'font-size: 11px; color: #666; background: #f5f5f5; padding: 8px; margin-bottom: 10px; border-radius: 4px;';
                        headerDiv.innerHTML = `<strong>Signals scanned:</strong> ${data.signals_searched.join(', ')}`;
                        resultsDiv.appendChild(headerDiv);
                    }
                    displaySpotlightResults(data.results, 'spotlightSignalsResults', true);
                } else {
                    resultsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No signals found. Try again later.</p>';
                }
            } catch (error) {
                console.error('Insights search error:', error);
                resultsDiv.innerHTML = `<p style="color: #c00; padding: 20px;">Error: ${error.message}</p>`;
            }
        }

        // Search Card 3: Source Explorer (Curated Sources)
        async function searchSpotlightCurated() {
            const query = document.getElementById('spotlightCuratedQuery').value;
            const timeWindow = document.getElementById('spotlightCuratedTimeWindow').value;
            const resultsDiv = document.getElementById('spotlightCuratedResults');

            // Get selected source packs
            const selectedPacks = [];
            document.querySelectorAll('.spotlightSourcePack:checked').forEach(cb => {
                selectedPacks.push(cb.value);
            });

            if (selectedPacks.length === 0) {
                alert('Please select at least one source pack');
                return;
            }

            resultsDiv.innerHTML = '<div class="research-card-loading"><div class="spinner"></div><p>Searching curated sources...</p></div>';

            try {
                const response = await fetch(`${API_BASE}/api/v2/search-sources`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        source_packs: selectedPacks,
                        time_window: timeWindow,
                        exclude_urls: shownSpotlightArticles
                    })
                });

                const data = await response.json();

                if (data.success && data.results.length > 0) {
                    // Mark these as curated source
                    data.results.forEach(r => r.source_card = 'curated');

                    // Show queries header then results
                    resultsDiv.innerHTML = '';
                    if (data.queries_used && data.queries_used.length > 0) {
                        const headerDiv = document.createElement('div');
                        headerDiv.style.cssText = 'font-size: 11px; color: #666; background: #f5f5f5; padding: 8px; margin-bottom: 10px; border-radius: 4px;';
                        headerDiv.innerHTML = `<strong>Queries tried:</strong><br>${data.queries_used.join('<br>')}`;
                        resultsDiv.appendChild(headerDiv);
                    }
                    displaySpotlightResults(data.results, 'spotlightCuratedResults', true);
                } else {
                    let html = '';
                    if (data.queries_used && data.queries_used.length > 0) {
                        html += `<div style="font-size: 11px; color: #666; background: #f5f5f5; padding: 8px; margin-bottom: 10px; border-radius: 4px;">
                            <strong>Queries tried:</strong><br>${data.queries_used.join('<br>')}
                        </div>`;
                    }
                    html += `<p style="text-align: center; color: #999; padding: 20px;">No articles found. Try a different search term.</p>`;
                    resultsDiv.innerHTML = html;
                }
            } catch (error) {
                console.error('Sources search error:', error);
                resultsDiv.innerHTML = `<p style="color: #c00; padding: 20px;">Error: ${error.message}</p>`;
            }
        }

        // Display results in a specific container (for 3-card layout)
        function displaySpotlightResults(results, containerId, append = false) {
            const container = document.getElementById(containerId);
            if (!append) {
                container.innerHTML = '';
            }

            results.forEach((result, index) => {
                const isSelected = spotlightSelectedArticles.some(a => a.url === result.url);
                const card = document.createElement('div');
                card.className = 'research-result-card';
                card.style.cssText = `
                    background: ${isSelected ? '#f0fdf4' : '#f9fafb'};
                    border: 2px solid ${isSelected ? '#22c55e' : '#e5e7eb'};
                    border-radius: 8px;
                    padding: 12px;
                    margin-bottom: 8px;
                    cursor: pointer;
                    transition: all 0.2s;
                `;

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 10px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #272d3f; margin-bottom: 4px; font-size: 13px;">${result.title || result.headline}</div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">${(result.snippet || result.industry_data || '').substring(0, 100)}...</div>
                            <div style="font-size: 11px; color: #018181;">${result.publisher || 'Unknown source'}</div>
                        </div>
                        <div style="width: 20px; height: 20px; border: 2px solid ${isSelected ? '#22c55e' : '#ccc'}; border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: ${isSelected ? '#22c55e' : 'white'};">
                            ${isSelected ? '<span style="color: white; font-size: 12px;">‚úì</span>' : ''}
                        </div>
                    </div>
                `;
                card.onclick = () => toggleSpotlightArticle(result, containerId);
                container.appendChild(card);
            });
        }

        function toggleSpotlightArticle(article, containerId) {
            const existingIndex = spotlightSelectedArticles.findIndex(a => a.url === article.url);

            if (existingIndex >= 0) {
                // Deselect
                spotlightSelectedArticles.splice(existingIndex, 1);
            } else if (spotlightSelectedArticles.length < 5) {
                // Select (max 5)
                spotlightSelectedArticles.push(article);
                shownSpotlightArticles.push(article.url);
            } else {
                alert('Maximum 5 articles. Deselect one to add another.');
                return;
            }

            // Refresh all 3 result containers to update checkmarks
            refreshAllSpotlightResults();
            updateSpotlightCounter();
        }

        function refreshAllSpotlightResults() {
            // Re-render each container that has results
            ['spotlightCuratedResults', 'spotlightPerplexityResults', 'spotlightSignalsResults'].forEach(containerId => {
                const container = document.getElementById(containerId);
                // Only refresh if it has result cards (not the default placeholder)
                if (container && container.querySelector('.research-result-card')) {
                    const cards = container.querySelectorAll('.research-result-card');
                    cards.forEach(card => {
                        // Extract URL from the card's onclick data
                        const title = card.querySelector('div[style*="font-weight: 600"]')?.textContent;
                        const isSelected = spotlightSelectedArticles.some(a =>
                            (a.title === title || a.headline === title)
                        );
                        card.style.background = isSelected ? '#f0fdf4' : '#f9fafb';
                        card.style.border = `2px solid ${isSelected ? '#22c55e' : '#e5e7eb'}`;
                        const checkbox = card.querySelector('div[style*="width: 20px"]');
                        if (checkbox) {
                            checkbox.style.borderColor = isSelected ? '#22c55e' : '#ccc';
                            checkbox.style.background = isSelected ? '#22c55e' : 'white';
                            checkbox.innerHTML = isSelected ? '<span style="color: white; font-size: 12px;">‚úì</span>' : '';
                        }
                    });
                }
            });
        }

        function updateSpotlightCounter() {
            const count = spotlightSelectedArticles.length;
            document.getElementById('spotlightSelectedCount').textContent = count;
            document.getElementById('generateSpotlightBtn').disabled = count < 3;
            document.getElementById('spotlightNextBtn').disabled = !spotlightGeneratedContent;
        }

        async function generateSpotlightContent() {
            const btn = document.getElementById('generateSpotlightBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 8px;"></span> Generating...';

            try {
                const response = await fetch(`${API_BASE}/api/generate-spotlight`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        articles: spotlightSelectedArticles,
                        month: selectedMonth
                    })
                });

                const data = await response.json();

                if (data.success) {
                    spotlightGeneratedContent = data.content;
                    btn.innerHTML = '‚úì Spotlight Generated';
                    btn.style.background = '#22c55e';

                    // Populate and show the review page
                    displaySpotlightReview(data.content);
                    showStep('2-spotlight-review');
                } else {
                    throw new Error(data.error || 'Failed to generate spotlight');
                }
            } catch (error) {
                btn.innerHTML = 'Generate Spotlight Story ‚Üí';
                btn.disabled = false;
                alert(`Error: ${error.message}`);
            }
        }

        // Normalize spotlight content to handle different API response formats
        // Ensures content always has: { subheader, h3s: [{title, body}], agent_takeaway, sources }
        function normalizeSpotlightContent(content) {
            console.log('[Spotlight] Normalizing content:', typeof content, content);

            // If it's a string, try to parse as JSON
            if (typeof content === 'string') {
                // Try to extract JSON from markdown code blocks
                let jsonStr = content;
                if (content.includes('```json')) {
                    const match = content.match(/```json\s*([\s\S]*?)\s*```/);
                    if (match) jsonStr = match[1];
                } else if (content.includes('```')) {
                    const match = content.match(/```\s*([\s\S]*?)\s*```/);
                    if (match) jsonStr = match[1];
                }

                try {
                    content = JSON.parse(jsonStr);
                } catch (e) {
                    console.log('[Spotlight] Could not parse as JSON, treating as plain text');
                    // Treat as plain text body
                    return {
                        subheader: 'InsurNews Spotlight',
                        h3s: [{ title: 'Overview', body: content }],
                        agent_takeaway: '',
                        sources: []
                    };
                }
            }

            // If not an object, wrap it
            if (!content || typeof content !== 'object') {
                return {
                    subheader: 'InsurNews Spotlight',
                    h3s: [{ title: 'Overview', body: String(content || 'No content available') }],
                    agent_takeaway: '',
                    sources: []
                };
            }

            // Normalize the structure
            const normalized = {
                subheader: content.subheader || content.headline || content.title || 'InsurNews Spotlight',
                h3s: [],
                agent_takeaway: content.agent_takeaway || content.takeaway || content.actionable_insights || '',
                sources: content.sources || []
            };

            // Helper to extract body text from any h3 object
            function extractH3Body(h3) {
                console.log('[Spotlight] extractH3Body input:', h3);
                if (!h3 || typeof h3 !== 'object') return typeof h3 === 'string' ? h3 : '';

                // Check common body keys FIRST (priority order)
                const bodyKeys = ['body', 'content', 'text', 'paragraph', 'description', 'summary', 'details'];
                for (const key of bodyKeys) {
                    if (h3[key] && typeof h3[key] === 'string' && h3[key].length > 10) {
                        console.log('[Spotlight] Found body in key:', key, h3[key].substring(0, 50));
                        return h3[key];
                    }
                }

                // If no body key found, try to get any long string value (but NOT the title)
                const stringVals = Object.entries(h3)
                    .filter(([k, v]) => typeof v === 'string' && v.length > 30 && !['title', 'h3', 'heading', 'header'].includes(k))
                    .map(([k, v]) => v);
                if (stringVals.length > 0) {
                    console.log('[Spotlight] Using longest string value:', stringVals[0].substring(0, 50));
                    return stringVals[0];
                }

                // Last resort: combine ALL string values except title-like keys
                const allStrings = Object.entries(h3)
                    .filter(([k, v]) => typeof v === 'string' && v.length > 5 && !['title', 'h3', 'heading', 'header', 'url', 'source'].includes(k))
                    .map(([k, v]) => v);
                if (allStrings.length > 0) {
                    console.log('[Spotlight] Combining all strings:', allStrings.length);
                    return allStrings.join(' ');
                }

                console.log('[Spotlight] No body found in h3');
                return '';
            }

            // Handle h3s as single object (not array) - convert to array
            if (content.h3s && typeof content.h3s === 'object' && !Array.isArray(content.h3s)) {
                console.log('[Spotlight] Converting h3s object to array');
                content.h3s = [content.h3s];
            }

            // Handle different h3s formats
            if (Array.isArray(content.h3s)) {
                normalized.h3s = content.h3s.map(h3 => ({
                    title: h3.title || h3.h3 || h3.heading || h3.header || '',
                    body: extractH3Body(h3)
                })).filter(h3 => h3.body.length > 10);
            } else if (content.body && typeof content.body === 'string') {
                // Single body field - split into paragraphs
                normalized.h3s = [{ title: 'Overview', body: content.body }];
            } else if (content.content && typeof content.content === 'string') {
                normalized.h3s = [{ title: 'Overview', body: content.content }];
            } else if (content.text && typeof content.text === 'string') {
                normalized.h3s = [{ title: 'Overview', body: content.text }];
            } else if (content.sections && Array.isArray(content.sections)) {
                // Alternative "sections" key
                normalized.h3s = content.sections.map(s => ({
                    title: s.title || s.heading || s.header || '',
                    body: extractH3Body(s)
                })).filter(s => s.body.length > 10);
            } else if (content.paragraphs && Array.isArray(content.paragraphs)) {
                // Alternative "paragraphs" key
                normalized.h3s = content.paragraphs.map((p, i) => ({
                    title: '',
                    body: typeof p === 'string' ? p : extractH3Body(p)
                })).filter(p => p.body.length > 10);
            } else {
                // Try to extract any string values as content
                const bodyTexts = Object.values(content)
                    .filter(v => typeof v === 'string' && v.length > 50)
                    .filter(v => !v.startsWith('http') && !v.includes('@'));

                if (bodyTexts.length > 0) {
                    normalized.h3s = bodyTexts.map((text, i) => ({
                        title: '',
                        body: text
                    }));
                }
            }

            // If still no h3s, try deeper extraction
            if (normalized.h3s.length === 0) {
                // Try to find any nested arrays or objects with text
                const findText = (obj, depth = 0) => {
                    if (depth > 3) return [];
                    let texts = [];
                    if (Array.isArray(obj)) {
                        obj.forEach(item => texts = texts.concat(findText(item, depth + 1)));
                    } else if (typeof obj === 'object' && obj !== null) {
                        Object.values(obj).forEach(val => {
                            if (typeof val === 'string' && val.length > 50 && !val.startsWith('http')) {
                                texts.push(val);
                            } else {
                                texts = texts.concat(findText(val, depth + 1));
                            }
                        });
                    }
                    return texts;
                };
                const deepTexts = findText(content);
                if (deepTexts.length > 0) {
                    normalized.h3s = deepTexts.slice(0, 5).map(text => ({ title: '', body: text }));
                }
            }

            // Final fallback
            if (normalized.h3s.length === 0) {
                normalized.h3s = [{ title: '', body: 'Content could not be parsed. Please try regenerating.' }];
            }

            console.log('[Spotlight] Normalized result:', normalized);
            return normalized;
        }

        // Global helper to recursively extract all text from any object structure
        // Used by both normalizeSpotlightContent and displaySpotlightReview
        function extractTextFromObj(obj, depth = 0) {
            if (depth > 5) return '';
            if (!obj) return '';
            if (typeof obj === 'string') return obj;
            if (typeof obj === 'number') return '';

            if (Array.isArray(obj)) {
                // For arrays, extract from each item and join
                const results = obj.map(item => {
                    if (typeof item === 'object' && item.body) return item.body;
                    if (typeof item === 'object' && item.content) return item.content;
                    if (typeof item === 'object' && item.text) return item.text;
                    return extractTextFromObj(item, depth + 1);
                }).filter(t => t && t.length > 10);
                return results.join('\n\n');
            }

            if (typeof obj === 'object') {
                // Priority: look for body/content/text keys first
                const priorityKeys = ['body', 'content', 'text', 'paragraph', 'summary', 'description'];
                for (const key of priorityKeys) {
                    if (obj[key] && typeof obj[key] === 'string' && obj[key].length > 20) {
                        return obj[key];
                    }
                }

                // If object has h3s array, extract body from each
                if (obj.h3s && Array.isArray(obj.h3s)) {
                    return obj.h3s.map(h3 => h3.body || h3.content || h3.text || '').filter(t => t.length > 10).join('\n\n');
                }

                // Collect all text values, skipping metadata keys
                const texts = [];
                for (const [key, val] of Object.entries(obj)) {
                    // Skip metadata keys
                    if (['subheader', 'title', 'heading', 'url', 'source', 'link', 'id', 'type', 'h3', 'header', 'agent_takeaway', 'sources'].includes(key)) continue;
                    const extracted = extractTextFromObj(val, depth + 1);
                    if (extracted && extracted.length > 20) texts.push(extracted);
                }
                return texts.join('\n\n');
            }
            return '';
        }

        // Display spotlight content in the single editable view
        // Formatted like a final readable article - no H3 titles, flowing paragraphs, blue links
        function displaySpotlightReview(rawContent) {
            // Normalize the content first
            const content = normalizeSpotlightContent(rawContent);

            // Headline - editable (convert **text** to bold)
            let headlineText = content.subheader || 'Untitled Spotlight';
            headlineText = headlineText.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            document.getElementById('spotlightHeadlineEditable').innerHTML = headlineText;

            // Build editable article body - flowing paragraphs without H3 section titles
            const bodyEditable = document.getElementById('spotlightBodyEditable');
            let bodyHtml = '';

            // Helper to make links blue, convert markdown links, headers, and bold to HTML
            function stylizeLinks(text) {
                if (!text) return '';
                // Convert markdown headers ## and ### to bold - handle all positions
                // First handle ### (more specific)
                text = text.replace(/^###\s*(.+)$/gm, '<strong style="display: block; font-size: 16px; color: #282D3E; margin: 16px 0 8px 0;">$1</strong>');
                text = text.replace(/(?:>|\n)###\s*([^\n<]+)/g, '$&'.replace(/###\s*([^\n<]+)/, '<strong style="display: block; font-size: 16px; color: #282D3E; margin: 16px 0 8px 0;">$1</strong>'));
                // Then handle ## headers - at line start
                text = text.replace(/^##\s*(.+)$/gm, '<strong style="display: block; font-size: 17px; color: #282D3E; margin: 20px 0 10px 0;">$1</strong>');
                // Handle ## after newlines
                text = text.replace(/\n##\s*([^\n]+)/g, '\n<strong style="display: block; font-size: 17px; color: #282D3E; margin: 20px 0 10px 0;">$1</strong>');
                // Handle ## after closing HTML tags like </p>## or ><p>##
                text = text.replace(/>##\s*([^<\n]+)/g, '><strong style="display: block; font-size: 17px; color: #282D3E; margin: 20px 0 10px 0;">$1</strong>');
                // Convert markdown bold **text** to <strong> (must have content between)
                text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                // Clean up any stray ** that weren't part of a proper pair
                text = text.replace(/\*\*/g, '');
                // Convert markdown links [text](url) to HTML
                text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #0066cc; text-decoration: underline;">$1</a>');
                // Style any existing <a> tags with blue color
                text = text.replace(/<a\s+(?!style)/gi, '<a style="color: #0066cc; text-decoration: underline;" ');
                return text;
            }

            (content.h3s || []).forEach((h3, index) => {
                // NO H3 section titles - just flowing paragraphs
                let bodyText = h3.body || '';

                // SAFETY CHECK: If body still looks like JSON, extract text forcefully
                if (typeof bodyText === 'string' && (bodyText.includes('{"') || bodyText.includes('"subheader"') || bodyText.includes('"h3s"') || bodyText.includes('"body":'))) {
                    console.log('[Spotlight] Detected JSON in body, extracting text...');
                    try {
                        const parsed = JSON.parse(bodyText);
                        bodyText = extractTextFromObj(parsed);
                    } catch(e) {
                        // Not valid JSON, try regex extraction
                        const textMatches = bodyText.match(/"([^"]{30,})"/g);
                        if (textMatches) {
                            bodyText = textMatches.map(m => m.slice(1, -1)).filter(t => !t.includes('http') && !t.includes('"')).join(' ');
                        }
                    }
                } else if (typeof bodyText === 'object') {
                    // If body is still an object, extract text
                    bodyText = extractTextFromObj(bodyText);
                }

                // Check if body already contains HTML paragraph tags (from backend)
                if (typeof bodyText === 'string' && bodyText.includes('<p')) {
                    // Body is already HTML formatted - use directly
                    // Just ensure links are blue
                    bodyHtml += stylizeLinks(bodyText);
                } else {
                    // Plain text - wrap in paragraph and stylize links
                    const bodyContent = stylizeLinks(bodyText);
                    bodyHtml += `<p class="spotlight-section-body" data-index="${index}" contenteditable="true"
                        style="margin: 0 0 20px 0; font-size: 15px; line-height: 1.9; text-align: left; outline: none; cursor: text; color: #333;"
                        onfocus="this.style.background='#fafafa'" onblur="this.style.background='transparent'">${bodyContent}</p>`;
                }
            });

            // Wrap in editable container if HTML content
            if (bodyHtml) {
                bodyEditable.innerHTML = `<div contenteditable="true" style="outline: none;">${bodyHtml}</div>`;
            } else {
                bodyEditable.innerHTML = '<p style="color: #999;">No content sections available.</p>';
            }

            // Agent Takeaway - editable
            document.getElementById('spotlightTakeawayEditable').textContent = content.agent_takeaway || 'No takeaway provided.';

            // Sources - read only
            const sourcesEditable = document.getElementById('spotlightSourcesEditable');
            if (content.sources && content.sources.length > 0) {
                sourcesEditable.innerHTML = content.sources.map(source =>
                    `<a href="${source.url}" target="_blank" style="color: #008181; text-decoration: none; margin-right: 15px;">${source.title || source.publisher} ‚Üó</a>`
                ).join('');
            } else {
                sourcesEditable.innerHTML = '<span style="color: #999;">No sources listed</span>';
            }
        }

        // Save edits from the spotlight editable view back to spotlightGeneratedContent
        function saveSpotlightEdits() {
            // Save headline from contenteditable
            const headlineEl = document.getElementById('spotlightHeadlineEditable');
            if (headlineEl) {
                spotlightGeneratedContent.subheader = headlineEl.textContent.trim();
            }

            // Save H3 sections from contenteditable paragraphs
            // Titles are stored in data-title attribute (hidden from view)
            const h3Bodies = document.querySelectorAll('.spotlight-section-body');

            spotlightGeneratedContent.h3s = [];
            h3Bodies.forEach((bodyEl) => {
                spotlightGeneratedContent.h3s.push({
                    title: bodyEl.dataset.title || '',  // Preserve original title from data attribute
                    body: bodyEl.innerHTML.trim()  // Use innerHTML to preserve any links
                });
            });

            // If no .spotlight-section-body elements found, get content from the main container
            // This handles the case where body is already HTML formatted (with <p> tags)
            if (spotlightGeneratedContent.h3s.length === 0) {
                const bodyEditable = document.getElementById('spotlightBodyEditable');
                if (bodyEditable) {
                    const bodyContent = bodyEditable.innerHTML.trim();
                    if (bodyContent && !bodyContent.includes('No content sections available')) {
                        // Store as body field for cleanContentForDisplay to handle
                        spotlightGeneratedContent.body = bodyContent;
                        console.log('[Spotlight] Saved body from container:', bodyContent.substring(0, 100));
                    }
                }
            }

            // Save agent takeaway from contenteditable
            const takeawayEl = document.getElementById('spotlightTakeawayEditable');
            if (takeawayEl) {
                spotlightGeneratedContent.agent_takeaway = takeawayEl.textContent.trim();
            }

            console.log('[Spotlight] Edits saved:', spotlightGeneratedContent);
        }

        // ============================================================================
        // LEGACY SEARCH FUNCTIONS (kept for compatibility)
        // ============================================================================

        async function searchTopics() {
            showStep(2);

            try {
                const response = await fetch(`${API_BASE}/api/search-news`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        month: selectedMonth,
                        exclude_titles: shownNewsArticles
                    })
                });

                const data = await response.json();

                if (data.success) {
                    newsTopics = data.articles;
                    // Track these articles to avoid showing them again
                    newsTopics.forEach(article => {
                        if (!shownNewsArticles.includes(article.title)) {
                            shownNewsArticles.push(article.title);
                        }
                    });
                    displayNews();
                    showStep(3);
                } else {
                    throw new Error(data.error || 'Failed to load news');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('newsError').textContent = `Error: ${error.message}. Make sure the API server is running!`;
                document.getElementById('newsError').style.display = 'block';
                showStep(3);
            }
        }

        function displayNews() {
            const container = document.getElementById('newsTopics');
            container.innerHTML = '';

            newsTopics.forEach((topic, index) => {
                const card = document.createElement('div');
                card.className = 'topic-card';
                card.innerHTML = `
                    <div class="title">üì∞ ${topic.title}</div>
                    ${topic.age ? `<div style="color: #666; font-size: 0.85em; margin-top: 4px;">Published: ${topic.age}</div>` : ''}
                    <div class="description">${topic.description}</div>
                    ${topic.source_url ? `<a href="${topic.source_url}" target="_blank" class="source" onclick="event.stopPropagation()">Read source article ‚Üí</a>` : ''}
                `;
                card.onclick = () => selectNews(index, card);
                container.appendChild(card);
            });
        }

        function selectNews(index, element) {
            selectedNews = newsTopics[index];
            document.querySelectorAll('#newsTopics .topic-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('newsNextBtn').disabled = false;
        }

        async function loadTips() {
            showStep(4);

            try {
                const response = await fetch(`${API_BASE}/api/search-tips`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        month: selectedMonth,
                        exclude_titles: shownTipArticles
                    })
                });

                const data = await response.json();

                if (data.success) {
                    tipTopics = data.tips;
                    // Track these articles
                    tipTopics.forEach(tip => {
                        if (!shownTipArticles.includes(tip.title)) {
                            shownTipArticles.push(tip.title);
                        }
                    });
                    displayTips();
                    showStep(5);
                } else {
                    throw new Error(data.error || 'Failed to load tips');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('tipError').textContent = `Error: ${error.message}`;
                document.getElementById('tipError').style.display = 'block';
                showStep(5);
            }
        }

        function displayTips() {
            const container = document.getElementById('tipTopics');
            container.innerHTML = '';

            tipTopics.forEach((topic, index) => {
                const card = document.createElement('div');
                card.className = 'topic-card';
                card.innerHTML = `
                    <div class="title">üí° ${topic.title}</div>
                    ${topic.age ? `<div style="color: #666; font-size: 0.85em; margin-top: 4px;">Published: ${topic.age}</div>` : ''}
                    <div class="description">${topic.description}</div>
                    ${topic.source_url ? `<a href="${topic.source_url}" target="_blank" class="source" onclick="event.stopPropagation()">Read source article ‚Üí</a>` : ''}
                `;
                card.onclick = () => selectTip(index, card);
                container.appendChild(card);
            });
        }

        function selectTip(index, element) {
            selectedTip = tipTopics[index];
            document.querySelectorAll('#tipTopics .topic-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('tipNextBtn').disabled = false;
        }

        async function loadTrends() {
            showStep(6);
            document.getElementById('trendSeasonText').textContent = `Loading ${selectedSeason} trends...`;

            try {
                const response = await fetch(`${API_BASE}/api/get-trends`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        month: selectedMonth,
                        exclude_titles: shownTrendArticles
                    })
                });

                const data = await response.json();

                if (data.success) {
                    trendTopics = data.trends;
                    // Track these articles
                    trendTopics.forEach(trend => {
                        if (!shownTrendArticles.includes(trend.title)) {
                            shownTrendArticles.push(trend.title);
                        }
                    });
                    selectedSeason = data.season; // Update from server
                    document.getElementById('trendSeasonLabel').textContent = `Seasonal trends for ${selectedSeason}`;
                    displayTrends();
                    showStep(7);
                } else {
                    throw new Error(data.error || 'Failed to load trends');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('trendError').textContent = `Error: ${error.message}`;
                document.getElementById('trendError').style.display = 'block';
                showStep(7);
            }
        }

        function displayTrends() {
            const container = document.getElementById('trendTopics');
            container.innerHTML = '';

            trendTopics.forEach((topic, index) => {
                const card = document.createElement('div');
                card.className = 'topic-card';
                card.innerHTML = `
                    <div class="title">üìà ${topic.title}</div>
                    ${topic.age ? `<div style="color: #666; font-size: 0.85em; margin-top: 4px;">Published: ${topic.age}</div>` : ''}
                    <div class="description">${topic.description}</div>
                    ${topic.source_url ? `<a href="${topic.source_url}" target="_blank" class="source" onclick="event.stopPropagation()">Read source article ‚Üí</a>` : ''}
                `;
                card.onclick = () => selectTrend(index, card);
                container.appendChild(card);
            });
        }

        function selectTrend(index, element) {
            selectedTrend = trendTopics[index];
            document.querySelectorAll('#trendTopics .topic-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('trendNextBtn').disabled = false;
        }

        // Agent newsletter content variables
        let generatedIntroContent = null;
        let generatedClaimsContent = null;
        let generatedRoundupContent = null;  // Array of 5 bullet items
        let generatedSpotlightContent = null;
        let generatedSpotlightSubheader = null;  // Spotlight subheader from Step 2B
        let generatedTipsContent = null;  // Array of 5 tip items
        let generatedBriteSpotContent = null;

        // Track what has been generated to avoid re-triggering on back navigation
        let promptsAlreadyGenerated = false;
        let imagesAlreadyGenerated = false;
        let memeConceptGenerated = false;
        let memeImageGenerated = false;

        // Store meme concept data to preserve on back navigation
        let memeConceptData = {
            scene: '',
            topText: '',
            bottomText: ''
        };

        async function generateContent() {
            // STAGE 1: Research with GPT-5.2
            showStep(3); // Researching step

            // Update status indicators for agent newsletter sections
            const updateResearchStatus = (section, status, isActive = false) => {
                const el = document.getElementById(`research${section}Status`);
                if (el) {
                    const color = status === 'Done' ? '#10b981' : (isActive ? '#2563eb' : '#666');
                    const icon = status === 'Done' ? '‚úì' : (isActive ? '‚è≥' : '');
                    const icons = { Claims: 'üîç', Roundup: 'üì∞', Spotlight: '‚≠ê', Tips: 'üí°' };
                    el.innerHTML = `<span style="margin-right: 10px;">${icons[section] || 'üìù'}</span> ${section.toUpperCase()}: <span style="color: ${color};">${icon} ${status}</span>`;
                }
            };

            try {
                // Show research starting
                updateResearchStatus('Claims', 'Researching...', true);
                updateResearchStatus('Roundup', 'Waiting...');
                updateResearchStatus('Spotlight', 'Waiting...');
                updateResearchStatus('Tips', 'Waiting...');

                console.log('[Research] Starting GPT-5.2 research phase...');

                const researchResponse = await fetch(`${API_BASE}/api/research-articles`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        curious_claims_topic: selectedClaims,
                        roundup_topics: selectedRoundup,
                        spotlight_content: spotlightGeneratedContent,  // Pass pre-generated spotlight content
                        agent_tips_topics: selectedTips
                    })
                });

                const researchData = await researchResponse.json();

                if (!researchData.success) {
                    throw new Error(researchData.error || 'Failed to research articles');
                }

                console.log('[Research] GPT-5.2 research complete:', researchData.research);

                // Update status to show research complete
                updateResearchStatus('Claims', 'Done');
                updateResearchStatus('Roundup', 'Done');
                updateResearchStatus('Spotlight', 'Done');
                updateResearchStatus('Tips', 'Done');

                // Brief pause to show completion
                await new Promise(resolve => setTimeout(resolve, 500));

                // STAGE 2: Write with Opus 4.5
                showStep(4); // Writing step

                console.log('[Writing] Starting Opus 4.5 writing phase...');

                // Get Brite Spot content from Step 1
                const briteSpotInputEl = document.getElementById('briteSpotInput');
                const briteSpotText = briteSpotInputEl ? briteSpotInputEl.value.trim() : '';
                const introInputEl = document.getElementById('introInput');
                const introText = introInputEl ? introInputEl.value.trim() : '';

                const contentResponse = await fetch(`${API_BASE}/api/generate-content`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        month: selectedMonth,
                        research: researchData.research,
                        brite_spot_topic: briteSpotText,
                        intro_content: introText
                    })
                });

                const data = await contentResponse.json();

                if (data.success) {
                    console.log('[Writing] Content generated:', data.content);

                    // Store generated content - map to agent newsletter sections
                    generatedIntroContent = data.content.introduction;
                    generatedClaimsContent = data.content.curious_claims;
                    generatedRoundupContent = data.content.roundup;
                    // Use Step 2B spotlight if backend didn't return it
                    generatedSpotlightContent = data.content.spotlight || spotlightGeneratedContent;
                    generatedSpotlightSubheader = data.content.spotlight_subheader || (spotlightGeneratedContent?.subheader || 'Industry Spotlight');
                    generatedTipsContent = data.content.agent_tips;
                    // DON'T use backend-generated brite_spot - use Step 1 input directly
                    // generatedBriteSpotContent stays null so briteSpotRewritten/briteSpotContent is used
                    generatedBriteSpotContent = null;

                    console.log('Generated content sections:', Object.keys(data.content));

                    // Display content
                    displayGeneratedContent();

                    // Move to review step
                    showStep(5); // Review Content step
                } else {
                    throw new Error(data.error || 'Failed to generate content');
                }
            } catch (error) {
                console.error('Error:', error);
                alert(`Error: ${error.message}. Make sure the API server is running!`);
                showStep('2-research'); // Go back to Research Dashboard
            }
        }

        function displayGeneratedContent() {
            const container = document.getElementById('generatedContent');

            // Helper function to recursively extract all text from any object structure
            function extractTextFromObject(obj, depth = 0) {
                if (depth > 5) return ''; // Prevent infinite recursion
                if (!obj) return '';
                if (typeof obj === 'string') return obj;
                if (typeof obj === 'number') return '';
                if (Array.isArray(obj)) {
                    return obj.map(item => extractTextFromObject(item, depth + 1)).filter(t => t.length > 10).join('\n\n');
                }
                if (typeof obj === 'object') {
                    // Priority keys for content
                    const priorityKeys = ['body', 'content', 'text', 'paragraph', 'summary', 'description', 'intro', 'tip'];
                    for (const key of priorityKeys) {
                        if (obj[key] && typeof obj[key] === 'string' && obj[key].length > 20) {
                            return obj[key];
                        }
                    }
                    // Try all string values
                    const texts = [];
                    for (const [key, val] of Object.entries(obj)) {
                        // Skip keys that are metadata
                        if (['subheader', 'h3', 'title', 'heading', 'url', 'source', 'link', 'id', 'type'].includes(key)) continue;
                        const extracted = extractTextFromObject(val, depth + 1);
                        if (extracted && extracted.length > 20) texts.push(extracted);
                    }
                    return texts.join('\n\n');
                }
                return '';
            }

            // Helper function to clean content for display and style links blue
            function cleanContentForDisplay(content, sectionType = null) {
                if (!content) return 'Content not available';

                let contentStr;

                // Handle spotlight object structure: { subheader, h3s: [{ h3, body }] }
                if (typeof content === 'object' && content !== null && !Array.isArray(content)) {
                    if (content.h3s && Array.isArray(content.h3s) && content.h3s.length > 0) {
                        // Spotlight format - extract body paragraphs from h3s array with proper spacing
                        let paragraphs = [];
                        content.h3s.forEach(h3Item => {
                            const bodyText = h3Item.body || h3Item.content || h3Item.text || '';
                            if (bodyText) {
                                // Check if already HTML formatted
                                if (typeof bodyText === 'string' && (bodyText.includes('<p') || bodyText.includes('<div'))) {
                                    paragraphs.push(bodyText);  // Use directly
                                } else {
                                    paragraphs.push(`<p style="margin: 0 0 16px 0; line-height: 1.7;">${bodyText}</p>`);
                                }
                            }
                        });
                        contentStr = paragraphs.join('');
                    } else if (content.body) {
                        // Check if body is already HTML formatted (contains <p> or <div> tags)
                        if (typeof content.body === 'string' && (content.body.includes('<p') || content.body.includes('<div'))) {
                            contentStr = content.body;  // Use directly without re-wrapping
                        } else {
                            contentStr = `<p style="margin: 0 0 16px 0; line-height: 1.7;">${content.body}</p>`;
                        }
                    } else if (content.content) {
                        contentStr = `<p style="margin: 0 0 16px 0; line-height: 1.7;">${content.content}</p>`;
                    } else if (content.text) {
                        contentStr = `<p style="margin: 0 0 16px 0; line-height: 1.7;">${content.text}</p>`;
                    } else if (content.sections && Array.isArray(content.sections)) {
                        // Handle sections array format
                        let paragraphs = [];
                        content.sections.forEach(section => {
                            const text = section.body || section.content || section.text || '';
                            if (text) paragraphs.push(`<p style="margin: 0 0 16px 0; line-height: 1.7;">${text}</p>`);
                        });
                        contentStr = paragraphs.join('');
                    } else {
                        // Use recursive extraction - NEVER return JSON
                        const extracted = extractTextFromObject(content);
                        if (extracted && extracted.length > 20) {
                            contentStr = extracted.split('\n\n').map(p =>
                                `<p style="margin: 0 0 16px 0; line-height: 1.7;">${p}</p>`
                            ).join('');
                        } else {
                            contentStr = '<p style="margin: 0 0 16px 0; line-height: 1.7; color: #999;">Content could not be parsed. Please try regenerating.</p>';
                        }
                    }
                } else if (typeof content === 'string') {
                    contentStr = content;
                } else if (Array.isArray(content)) {
                    // Handle array of items
                    contentStr = content.map(item => {
                        if (typeof item === 'string') return `<p style="margin: 0 0 16px 0; line-height: 1.7;">${item}</p>`;
                        const text = extractTextFromObject(item);
                        return text ? `<p style="margin: 0 0 16px 0; line-height: 1.7;">${text}</p>` : '';
                    }).filter(p => p).join('');
                } else {
                    contentStr = '<p style="margin: 0 0 16px 0; line-height: 1.7; color: #999;">Content could not be parsed.</p>';
                }

                // Fix white text color
                contentStr = contentStr.replace(/color:\s*#ffffff;?/gi, 'color: #1f2937;');

                // Convert markdown headers ## to bold text
                // Handle ### first (more specific), then ##
                contentStr = contentStr.replace(/^###\s*(.+)$/gm, '<strong style="font-size: 16px; color: #282D3E;">$1</strong>');
                contentStr = contentStr.replace(/^##\s*(.+)$/gm, '<strong style="font-size: 17px; color: #282D3E;">$1</strong>');
                // Also handle ## after newlines (not just line start)
                contentStr = contentStr.replace(/\n##\s*([^\n]+)/g, '\n<strong style="font-size: 17px; color: #282D3E;">$1</strong>');
                // Handle ## after closing HTML tags like </p>## or >##
                contentStr = contentStr.replace(/>##\s*([^<\n]+)/g, '><strong style="font-size: 17px; color: #282D3E;">$1</strong>');
                // Convert markdown bold **text** to <strong>
                contentStr = contentStr.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                // Clean up any stray ** that weren't part of a proper pair
                contentStr = contentStr.replace(/\*\*/g, '');

                // Convert markdown links [text](url) to HTML links first
                contentStr = contentStr.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

                // Style all links blue - first remove any existing color styles on links, then add blue
                contentStr = contentStr.replace(/<a\s+([^>]*?)style="[^"]*"([^>]*?)>/gi, '<a $1$2>'); // Remove existing styles
                contentStr = contentStr.replace(/<a\s+/gi, '<a style="color: #0066cc; text-decoration: underline;" ');

                return contentStr;
            }

            // Get content as strings
            let introContent = cleanContentForDisplay(generatedIntroContent);
            let claimsContent = cleanContentForDisplay(generatedClaimsContent);
            // Spotlight: use generatedSpotlightContent OR fall back to Step 2B spotlightGeneratedContent
            let spotlightDataForDisplay = generatedSpotlightContent || spotlightGeneratedContent || null;
            let spotlightContent = cleanContentForDisplay(spotlightDataForDisplay);

            // Get Brite Spot content - try multiple sources (now paragraph + bullets)
            let briteSpotParagraph = briteSpotContent || '';
            let briteSpotBulletsList = briteSpotBullets || [];

            // Build combined Brite Spot display with paragraph and bullets
            let briteSpotDisplayContent = '';
            if (briteSpotParagraph) {
                briteSpotDisplayContent = `<p style="margin: 0 0 12px 0;">${briteSpotParagraph}</p>`;
            }
            if (briteSpotBulletsList.length > 0) {
                briteSpotDisplayContent += '<ul style="margin: 0; padding-left: 20px;">';
                briteSpotBulletsList.forEach(bullet => {
                    briteSpotDisplayContent += `<li style="margin-bottom: 6px;">${bullet}</li>`;
                });
                briteSpotDisplayContent += '</ul>';
            }
            // Fallback to old generated content if no new paragraph/bullets
            if (!briteSpotDisplayContent) {
                briteSpotDisplayContent = cleanContentForDisplay(generatedBriteSpotContent || briteSpotRewritten || '');
            }

            // Get header intro from Step 1 input
            let headerIntroDisplay = headerIntroContent || document.getElementById('headerIntroInput')?.value?.trim() || '';

            let html = '';

            // BRITECO BRIEF HEADER INTRO SECTION (if available)
            if (headerIntroDisplay) {
                html += '<div style="margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px;">';
                html += '<h3 style="margin: 0 0 5px 0; color: #008181;">BriteCo Brief Intro</h3>';
                html += `<div id="headerIntroContentBox" contenteditable="true" style="outline: none; color: #555; font-size: 14px; line-height: 1.6;">${headerIntroDisplay}</div>`;
                html += `<button class="btn-secondary btn" style="font-size: 12px; padding: 6px 12px; margin-top: 8px;" onclick="editSection('headerIntro')">Edit</button>`;
                html += `<button class="btn-secondary btn save-section-btn" style="font-size: 12px; padding: 6px 12px; margin-top: 8px; margin-left: 8px;" onclick="saveSection('headerIntro')">üíæ Save</button>`;
                html += `</div>`;
            }

            // INTRODUCTION SECTION removed per user request - BriteCo Brief Intro from Step 1 is used instead

            // BRITE SPOT SECTION (if available)
            if (briteSpotDisplayContent && briteSpotDisplayContent !== 'Content not available') {
                html += '<div style="margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px;">';
                html += '<h3 style="margin: 0 0 5px 0; color: #008181;">The Brite Spot</h3>';
                html += `<div id="briteSpotContentBox" contenteditable="true" style="outline: none; color: #555; font-size: 14px; line-height: 1.6;">${briteSpotDisplayContent}</div>`;
                html += `<button class="btn-secondary btn" style="font-size: 12px; padding: 6px 12px; margin-top: 8px;" onclick="editSection('briteSpot')">Edit</button>`;
                html += `<button class="btn-secondary btn save-section-btn" style="font-size: 12px; padding: 6px 12px; margin-top: 8px; margin-left: 8px;" onclick="saveSection('briteSpot')">üíæ Save</button>`;
                html += `</div>`;
            }

            // CURIOUS CLAIMS SECTION
            html += '<div style="margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px;">';
            html += '<h3 style="margin: 0 0 5px 0; color: #008181;">Curious Claims</h3>';
            html += `<h4 style="margin: 0 0 8px 0; color: #1f2937; font-size: 16px;">${selectedClaims?.title || 'Curious Claims'}</h4>`;
            html += `<div id="claimsContentBox" contenteditable="true" style="outline: none; color: #555; font-size: 14px; line-height: 1.6;">${claimsContent}</div>`;
            html += `<button class="btn-secondary btn" style="font-size: 12px; padding: 6px 12px; margin-top: 8px;" onclick="editSection('claims')">Edit</button>`;
            html += `<button class="btn-secondary btn save-section-btn" style="font-size: 12px; padding: 6px 12px; margin-top: 8px; margin-left: 8px;" onclick="saveSection('claims')">üíæ Save</button>`;
            html += `</div>`;

            // Helper to make links blue in any text (defined early for use in all sections)
            function styleLinksBlueEarly(text) {
                if (!text) return '';
                // Convert markdown links [text](url) to HTML
                text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
                // Remove existing styles on links
                text = text.replace(/<a\s+([^>]*?)style="[^"]*"([^>]*?)>/gi, '<a $1$2>');
                // Add blue styling
                text = text.replace(/<a\s+/gi, '<a style="color: #0066cc; text-decoration: underline;" ');
                return text;
            }

            // NEWS ROUNDUP SECTION (5 bullets)
            html += '<div style="margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px;">';
            html += '<h3 style="margin: 0 0 5px 0; color: #008181;">Insurance News Roundup</h3>';
            html += '<ul id="roundupContentBox" contenteditable="true" style="outline: none; color: #555; font-size: 14px; line-height: 1.6; padding-left: 20px;">';
            if (Array.isArray(generatedRoundupContent)) {
                generatedRoundupContent.forEach(item => {
                    const itemText = styleLinksBlueEarly(item.summary || item);
                    html += `<li style="margin-bottom: 8px;">${itemText}</li>`;
                });
            } else {
                html += `<li>${styleLinksBlueEarly(generatedRoundupContent) || 'News roundup content'}</li>`;
            }
            html += '</ul>';
            html += `<button class="btn-secondary btn" style="font-size: 12px; padding: 6px 12px; margin-top: 8px;" onclick="editSection('roundup')">Edit</button>`;
            html += `<button class="btn-secondary btn save-section-btn" style="font-size: 12px; padding: 6px 12px; margin-top: 8px; margin-left: 8px;" onclick="saveSection('roundup')">üíæ Save</button>`;
            html += `</div>`;

            // INSURNEWS SPOTLIGHT SECTION
            html += '<div style="margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px;">';
            html += '<h3 style="margin: 0 0 5px 0; color: #008181;">InsurNews Spotlight</h3>';
            html += `<h4 style="margin: 0 0 8px 0; color: #1f2937; font-size: 16px;">${generatedSpotlightSubheader || 'Industry Spotlight'}</h4>`;
            html += `<div id="spotlightContentBox" contenteditable="true" style="outline: none; color: #555; font-size: 14px; line-height: 1.6;">${spotlightContent}</div>`;
            html += `<button class="btn-secondary btn" style="font-size: 12px; padding: 6px 12px; margin-top: 8px;" onclick="editSection('spotlight')">Edit</button>`;
            html += `<button class="btn-secondary btn save-section-btn" style="font-size: 12px; padding: 6px 12px; margin-top: 8px; margin-left: 8px;" onclick="saveSection('spotlight')">üíæ Save</button>`;
            html += `</div>`;

            // Helper to make links blue in any text
            function styleLinksBlue(text) {
                if (!text) return '';
                // Convert markdown links [text](url) to HTML
                text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
                // Remove existing styles on links
                text = text.replace(/<a\s+([^>]*?)style="[^"]*"([^>]*?)>/gi, '<a $1$2>');
                // Add blue styling
                text = text.replace(/<a\s+/gi, '<a style="color: #0066cc; text-decoration: underline;" ');
                return text;
            }

            // AGENT ADVANTAGE SECTION (intro + 5 tips from single article)
            html += '<div style="margin-bottom: 20px;">';
            html += '<h3 style="margin: 0 0 5px 0; color: #008181;">Agent Advantage</h3>';
            html += '<div id="tipsContentBox" contenteditable="true" style="outline: none; color: #555; font-size: 14px; line-height: 1.6;">';
            // Handle new format: { intro, tips: [{ title, tip }] }
            if (generatedTipsContent && generatedTipsContent.intro) {
                html += `<p style="margin-bottom: 15px;">${styleLinksBlue(generatedTipsContent.intro)}</p>`;
                html += '<ol style="padding-left: 20px; margin: 0;">';
                (generatedTipsContent.tips || []).forEach(item => {
                    const title = item.title ? `<strong>${item.title}:</strong> ` : '';
                    const tipText = styleLinksBlue(item.tip || item);
                    html += `<li style="margin-bottom: 10px;">${title}${tipText}</li>`;
                });
                html += '</ol>';
            } else if (Array.isArray(generatedTipsContent)) {
                // Old format: array of tips
                html += '<ol style="padding-left: 20px; margin: 0;">';
                generatedTipsContent.forEach(item => {
                    const title = item.title ? `<strong>${item.title}:</strong> ` : '';
                    const tipText = styleLinksBlue(item.tip || item);
                    html += `<li style="margin-bottom: 8px;">${title}${tipText}</li>`;
                });
                html += '</ol>';
            } else {
                html += `<p>${styleLinksBlue(generatedTipsContent) || 'Agent tips content'}</p>`;
            }
            html += '</div>';
            html += `<button class="btn-secondary btn" style="font-size: 12px; padding: 6px 12px; margin-top: 8px;" onclick="editSection('tips')">Edit</button>`;
            html += `<button class="btn-secondary btn save-section-btn" style="font-size: 12px; padding: 6px 12px; margin-top: 8px; margin-left: 8px;" onclick="saveSection('tips')">üíæ Save</button>`;
            html += `</div>`;

            container.innerHTML = html;
        }

        function editSection(sectionType) {
            const boxId = `${sectionType}ContentBox`;
            const box = document.getElementById(boxId);
            if (box) {
                box.focus();
                // Highlight the section briefly
                box.style.border = '2px solid #2563eb';
                box.style.padding = '10px';
                box.style.borderRadius = '4px';
                setTimeout(() => {
                    box.style.border = 'none';
                    box.style.padding = '0';
                }, 2000);
            }
        }

        function saveSection(sectionType) {
            const boxId = `${sectionType}ContentBox`;
            const box = document.getElementById(boxId);
            if (!box) return;

            const content = box.innerHTML;

            // Update the corresponding global variable based on section type
            switch(sectionType) {
                case 'headerIntro':
                    headerIntroContent = content;
                    break;
                case 'briteSpot':
                    briteSpotContent = content;
                    briteSpotRewritten = content;
                    generatedBriteSpotContent = content;
                    break;
                case 'claims':
                    generatedClaimsContent = content;
                    break;
                case 'roundup':
                    // Parse list items back to array
                    const listItems = box.querySelectorAll('li');
                    generatedRoundupContent = Array.from(listItems).map(li => li.innerHTML);
                    break;
                case 'spotlight':
                    generatedSpotlightContent = content;
                    spotlightGeneratedContent = content;
                    break;
                case 'tips':
                    generatedTipsContent = content;
                    break;
            }

            // Visual feedback - green border flash
            box.style.border = '2px solid #10b981';
            box.style.padding = '10px';
            box.style.borderRadius = '4px';
            box.style.background = '#ecfdf5';

            // Find the save button and update text briefly
            const saveBtn = box.parentElement.querySelector('.save-section-btn');
            if (saveBtn) {
                const originalText = saveBtn.textContent;
                saveBtn.textContent = '‚úì Saved!';
                saveBtn.style.background = '#10b981';
                saveBtn.style.borderColor = '#10b981';
                saveBtn.style.color = 'white';
                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    saveBtn.style.background = '';
                    saveBtn.style.borderColor = '';
                    saveBtn.style.color = '';
                }, 1500);
            }

            setTimeout(() => {
                box.style.border = 'none';
                box.style.padding = '0';
                box.style.background = 'transparent';
            }, 1500);

            console.log(`[Save] ${sectionType} section saved`);
        }

        async function checkBrandGuidelines() {
            try {
                showStep(6); // Brand Check loading screen

                // Get the edited content from the contenteditable divs
                // Use different variable names to avoid shadowing outer scope variables
                const briteSpotText = document.getElementById('briteSpotContentBox')?.innerHTML || briteSpotRewritten || briteSpotContent || '';
                const claimsText = document.getElementById('claimsContentBox')?.innerHTML || '';
                const roundupText = document.getElementById('roundupContentBox')?.innerHTML || '';
                const spotlightText = document.getElementById('spotlightContentBox')?.innerHTML || '';
                const tipsText = document.getElementById('tipsContentBox')?.innerHTML || '';

                const response = await fetch(`${API_BASE}/api/brand-check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        brite_spot_content: briteSpotText,
                        claims_content: claimsText,
                        roundup_content: roundupText,
                        spotlight_content: spotlightText,
                        tips_content: tipsText
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayBrandCheckResults({
                        passed: data.passed,
                        suggestions: data.check_results?.suggestions || []
                    });
                    showStep(7); // Check Results
                } else {
                    alert('Error checking brand guidelines: ' + (data.error || 'Unknown error'));
                    showStep(5); // Go back to Review Content
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error checking brand guidelines: ' + error.message);
                showStep(5); // Go back to Review Content
            }
        }

        function displayBrandCheckResults(results) {
            const container = document.getElementById('brandCheckResults');
            const suggestions = results.suggestions || [];

            let html = '';

            if (suggestions.length === 0) {
                // No issues found
                html += `<div style="text-align: center; padding: 40px; background: #10b98120; border-radius: 8px; margin-bottom: 20px;">`;
                html += `<h2 style="margin: 0; color: #10b981; font-size: 36px;">‚úÖ Looks Great!</h2>`;
                html += `<p style="margin: 10px 0 0 0; color: #666;">No brand guideline issues found. Your content is ready to go!</p>`;
                html += `</div>`;
            } else {
                // Show header
                html += `<div style="text-align: center; padding: 20px; background: #fef3c7; border-radius: 8px; margin-bottom: 20px;">`;
                html += `<h2 style="margin: 0; color: #f59e0b; font-size: 32px;">üìù Suggested Changes</h2>`;
                html += `<p style="margin: 10px 0 0 0; color: #666;">Yellow highlights show what needs changing. Green highlights show suggested replacements.</p>`;
                html += `</div>`;
            }

            // Get the full newsletter content with highlighting (matching venue-voice approach)
            const briteSpotContent = highlightContent(
                document.getElementById('briteSpotContentBox')?.innerHTML || '',
                suggestions.filter(s => s.section === 'brite_spot')
            );
            const claimsContent = highlightContent(
                document.getElementById('claimsContentBox')?.innerHTML || '',
                suggestions.filter(s => s.section === 'claims')
            );
            const roundupContent = highlightContent(
                document.getElementById('roundupContentBox')?.innerHTML || '',
                suggestions.filter(s => s.section === 'roundup')
            );
            const spotlightContent = highlightContent(
                document.getElementById('spotlightContentBox')?.innerHTML || '',
                suggestions.filter(s => s.section === 'spotlight')
            );
            const tipsContent = highlightContent(
                document.getElementById('tipsContentBox')?.innerHTML || '',
                suggestions.filter(s => s.section === 'tips')
            );

            // Display full newsletter with highlights
            html += '<h3 style="margin: 30px 0 15px 0; color: #272d3f;">‚ú® The Brite Spot</h3>';
            html += `<div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">`;
            html += briteSpotContent || '<p style="color: #999;">No content</p>';
            html += `</div>`;

            html += '<h3 style="margin: 30px 0 15px 0; color: #272d3f;">üîç Curious Claims</h3>';
            html += `<div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">`;
            html += claimsContent || '<p style="color: #999;">No content</p>';
            html += `</div>`;

            html += '<h3 style="margin: 30px 0 15px 0; color: #272d3f;">üì∞ Insurance News Roundup</h3>';
            html += `<div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">`;
            html += roundupContent || '<p style="color: #999;">No content</p>';
            html += `</div>`;

            html += '<h3 style="margin: 30px 0 15px 0; color: #272d3f;">‚≠ê InsurNews Spotlight</h3>';
            html += `<div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">`;
            html += spotlightContent || '<p style="color: #999;">No content</p>';
            html += `</div>`;

            html += '<h3 style="margin: 30px 0 15px 0; color: #272d3f;">üí° Agent Advantage</h3>';
            html += `<div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">`;
            html += tipsContent || '<p style="color: #999;">No content</p>';
            html += `</div>`;

            // If there are suggestions, show the legend
            if (suggestions.length > 0) {
                html += `<div style="margin-top: 30px; padding: 15px; background: #f9fafb; border-radius: 8px; border: 2px dashed #e5e7eb;">`;
                html += `<h4 style="margin: 0 0 10px 0; color: #666;">Legend:</h4>`;
                html += `<div style="display: flex; gap: 20px; flex-wrap: wrap;">`;
                html += `<div style="display: flex; align-items: center; gap: 8px;">`;
                html += `<div style="width: 20px; height: 20px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 4px;"></div>`;
                html += `<span style="font-size: 14px; color: #666;">Current text (needs changing)</span>`;
                html += `</div>`;
                html += `<div style="display: flex; align-items: center; gap: 8px;">`;
                html += `<div style="width: 20px; height: 20px; background: #d1fae5; border: 2px solid #10b981; border-radius: 4px;"></div>`;
                html += `<span style="font-size: 14px; color: #666;">Suggested replacement</span>`;
                html += `</div>`;
                html += `</div>`;

                // Show issue count summary
                html += `<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">`;
                html += `<strong style="color: #f59e0b;">${suggestions.length} issue${suggestions.length === 1 ? '' : 's'} found</strong> - `;
                html += `Click Accept or Ignore on each highlighted change.`;
                html += `</div>`;
                html += `</div>`;
            }

            container.innerHTML = html;
        }

        // Store current suggestions for bulk actions
        let currentSuggestions = [];

        function acceptAllSuggestions() {
            // Find all suggestion cards and click their accept buttons
            document.querySelectorAll('[id^="suggestion-"]').forEach(card => {
                const acceptBtn = card.querySelector('button:first-of-type');
                if (acceptBtn) acceptBtn.click();
            });
        }

        function ignoreAllSuggestions() {
            // Find all suggestion cards and click their ignore buttons
            document.querySelectorAll('[id^="suggestion-"]').forEach(card => {
                const ignoreBtn = card.querySelector('button:last-of-type');
                if (ignoreBtn) ignoreBtn.click();
            });
        }

        function highlightContent(content, suggestions) {
            if (suggestions.length === 0) {
                return content;
            }

            let highlighted = content;

            // Apply highlighting for each suggestion with Accept/Ignore buttons
            suggestions.forEach((suggestion, index) => {
                const original = suggestion.original;
                const suggested = suggestion.suggested;
                const reason = suggestion.reason;
                const section = suggestion.section;

                // Create unique ID for this suggestion
                const suggestionId = `suggestion-${section}-${index}`;

                // Create the highlighted HTML with Accept/Ignore buttons
                const highlightedText = `<span id="${suggestionId}" style="position: relative; display: inline-block; margin: 4px 0;">
                    <span style="background: #fef3c7; border-bottom: 3px solid #f59e0b; padding: 2px 4px; text-decoration: line-through;"
                          title="${reason}">${original}</span>
                    <span style="background: #d1fae5; border-bottom: 3px solid #10b981; padding: 2px 4px; margin-left: 4px; font-weight: 600;"
                          title="${reason}">${suggested}</span>
                    <span style="display: inline-block; margin-left: 8px;">
                        <button onclick="acceptSuggestion('${suggestionId}', '${escapeForAttribute(original)}', '${escapeForAttribute(suggested)}', '${section}')"
                                style="background: #10b981; color: white; border: none; padding: 2px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-right: 4px;"
                                title="Accept this change">‚úì Accept</button>
                        <button onclick="ignoreSuggestion('${suggestionId}')"
                                style="background: #ef4444; color: white; border: none; padding: 2px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;"
                                title="Ignore this suggestion">‚úó Ignore</button>
                    </span>
                </span>`;

                // Replace the original text with highlighted version
                // Use a case-insensitive search to find the text
                const regex = new RegExp(escapeRegExp(original), 'gi');
                highlighted = highlighted.replace(regex, highlightedText);
            });

            return highlighted;
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function escapeForAttribute(string) {
            return string.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }

        function acceptSuggestion(suggestionId, original, suggested, section) {
            // Map section names to content box IDs
            const sectionToContentBox = {
                'brite_spot': 'briteSpotContentBox',
                'claims': 'claimsContentBox',
                'roundup': 'roundupContentBox',
                'spotlight': 'spotlightContentBox',
                'tips': 'tipsContentBox'
            };

            // Decode HTML entities for comparison
            const decodedOriginal = original.replace(/&quot;/g, '"').replace(/&#39;/g, "'").replace(/&amp;/g, "&").replace(/\\'/g, "'");
            const decodedSuggested = suggested.replace(/&quot;/g, '"').replace(/&#39;/g, "'").replace(/&amp;/g, "&").replace(/\\'/g, "'");

            // Get the content box for this section and update it
            const contentBoxId = sectionToContentBox[section] || `${section}ContentBox`;
            const contentBox = document.getElementById(contentBoxId);

            if (contentBox) {
                // Replace the original text with suggested text in the content box
                let content = contentBox.innerHTML;
                // Use a regex to handle case variations
                const regex = new RegExp(escapeRegExp(decodedOriginal), 'gi');
                const newContent = content.replace(regex, decodedSuggested);
                contentBox.innerHTML = newContent;
                console.log(`[Brand Check] Updated ${contentBoxId}: "${decodedOriginal}" ‚Üí "${decodedSuggested}"`);
            }

            // Replace the highlighted suggestion span with just the suggested text in the display
            const suggestionElement = document.getElementById(suggestionId);
            if (suggestionElement) {
                // Replace the entire suggestion span with just the accepted text (styled as accepted)
                const acceptedSpan = document.createElement('span');
                acceptedSpan.style.cssText = 'background: #d1fae5; padding: 2px 4px; border-radius: 2px;';
                acceptedSpan.textContent = decodedSuggested;
                suggestionElement.replaceWith(acceptedSpan);
            }

            // Show success message
            const toast = document.createElement('div');
            toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999;';
            toast.textContent = '‚úì Change accepted';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);

            // Update remaining count
            updateSuggestionsCount();
        }

        function updateSuggestionsCount() {
            const remaining = document.querySelectorAll('[id^="suggestion-"]').length;
            const countEl = document.querySelector('#brandCheckResults .buttons span, #brandCheckResults > div:last-child span');
            if (countEl && countEl.textContent.includes('suggestion')) {
                countEl.textContent = `${remaining} suggestion${remaining !== 1 ? 's' : ''} remaining`;
            }
            // If no suggestions left, show success
            if (remaining === 0) {
                const container = document.getElementById('brandCheckResults');
                const successHtml = `<div style="text-align: center; padding: 40px; background: #10b98120; border-radius: 8px; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #10b981; font-size: 36px;">‚úÖ All Suggestions Resolved!</h2>
                    <p style="margin: 10px 0 0 0; color: #666;">Your content is now ready to continue.</p>
                </div>`;
                container.innerHTML = successHtml;
            }
        }

        function ignoreSuggestion(suggestionId) {
            // Get the suggestion element
            const suggestionElement = document.getElementById(suggestionId);
            if (!suggestionElement) return;

            // Get the original text (the strikethrough part) to preserve it
            const originalSpan = suggestionElement.querySelector('span[style*="line-through"]');
            const originalText = originalSpan ? originalSpan.textContent : '';

            // Replace the entire suggestion span with just the original text (styled normally)
            const preservedSpan = document.createElement('span');
            preservedSpan.textContent = originalText;
            suggestionElement.replaceWith(preservedSpan);

            // Update the count
            updateSuggestionsCount();

            // Show info message
            const toast = document.createElement('div');
            toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #6b7280; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999;';
            toast.textContent = 'Suggestion ignored - original text kept';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // Legacy ignoreSuggestion for inline suggestions (if any)
        function ignoreSuggestionLegacy(suggestionId) {
            // Get the suggestion element (inline highlight)
            const suggestionElement = document.getElementById(suggestionId);
            if (!suggestionElement) return;

            // Get the original text (the strikethrough part)
            const originalSpan = suggestionElement.querySelector('span[style*="line-through"]');
            if (!originalSpan) return;

            const originalText = originalSpan.textContent;

            // Replace the entire suggestion span with just the original text
            const parent = suggestionElement.parentElement;
            const textNode = document.createTextNode(originalText);
            parent.replaceChild(textNode, suggestionElement);

            // Show info message
            const toast = document.createElement('div');
            toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #6b7280; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999;';
            toast.textContent = 'Suggestion ignored';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // Store generated images
        let generatedImages = {
            meme: null,
            briteSpot: null,
            claims: null,
            spotlight: null,
            tips: null
        };

        // Helper to extract readable text from content objects
        function extractContentText(content) {
            if (!content) return '';

            // If it has raw JSON, parse it
            if (content.raw) {
                try {
                    const cleaned = content.raw.replace(/```json\n/g, '').replace(/\n```/g, '');
                    const parsed = JSON.parse(cleaned);

                    // Extract text based on structure
                    if (parsed.short_version) {
                        return `${parsed.short_version} ${parsed.whats_happening || ''} ${parsed.why_matters || ''}`;
                    } else if (parsed.content) {
                        // New single paragraph format for tip/trend
                        return parsed.content;
                    } else if (parsed.intro) {
                        return `${parsed.intro} ${(parsed.steps || []).join(' ')}`;
                    } else if (parsed.overview) {
                        return `${parsed.overview} ${(parsed.examples || []).join(' ')} ${parsed.opportunity || ''}`;
                    }
                    return JSON.stringify(parsed);
                } catch (e) {
                    return content.raw.substring(0, 500);
                }
            }

            // Direct text content
            if (typeof content === 'string') return content;

            // Extract text based on content structure (for parsed JSON)
            if (content.short_version) {
                // News article
                return `${content.short_version} ${content.whats_happening || ''} ${content.why_matters || ''}`;
            }
            if (content.content) {
                // New single paragraph format for tip/trend
                return content.content;
            }
            if (content.intro) {
                // Tip (old format)
                const stepsText = (content.steps || []).join(' ');
                return `${content.intro} ${stepsText} ${content.pro_tip || ''}`;
            }
            if (content.overview) {
                // Trend (old format)
                const examplesText = (content.examples || []).join(' ');
                return `${content.overview} ${examplesText} ${content.opportunity || ''}`;
            }

            return JSON.stringify(content).substring(0, 500);
        }

        function exportBrandCheckResults() {
            const resultsContainer = document.getElementById('brandCheckResults');
            if (!resultsContainer) {
                alert('No brand check results to export');
                return;
            }

            // Get the text content (strip HTML for clean copy)
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = resultsContainer.innerHTML;

            // Remove buttons and interactive elements
            tempDiv.querySelectorAll('button').forEach(btn => btn.remove());

            const textContent = tempDiv.innerText || tempDiv.textContent;

            // Copy to clipboard
            navigator.clipboard.writeText(textContent).then(() => {
                alert('‚úì Brand check results copied to clipboard!');
            }).catch(err => {
                // Fallback: create downloadable text file
                const blob = new Blob([textContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `brand-check-results-${selectedMonth}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('‚úì Brand check results downloaded!');
            });
        }

        // Toggle email input visibility for Google Docs export
        document.addEventListener('DOMContentLoaded', function() {
            const checkbox = document.getElementById('sendDocLinkEmail');
            const emailContainer = document.getElementById('docEmailInputContainer');
            if (checkbox && emailContainer) {
                checkbox.addEventListener('change', function() {
                    emailContainer.style.display = this.checked ? 'block' : 'none';
                });
            }
        });

        // Store last exported doc URL for email sending
        let lastExportedDocUrl = '';
        let lastExportedMonth = '';
        let lastExportedYear = '';

        async function exportToGoogleDocs() {
            const btn = document.getElementById('exportDocsBtn');
            const btnText = document.getElementById('exportDocsBtnText');
            const resultDiv = document.getElementById('exportDocsResult');
            const emailSection = document.getElementById('emailAfterExportSection');

            // Show loading state
            btn.disabled = true;
            btnText.textContent = 'Exporting...';
            resultDiv.style.display = 'none';
            emailSection.style.display = 'none';

            try {
                // Gather all newsletter content from editable boxes (user may have edited)
                const spotlightBox = document.getElementById('spotlightContentBox');
                let spotlightExport = null;

                // Try Step 5 editable box first
                if (spotlightBox && spotlightBox.innerHTML && spotlightBox.innerHTML.trim() !== '' && !spotlightBox.innerHTML.includes('Content not available')) {
                    spotlightExport = {
                        subheader: generatedSpotlightSubheader || (spotlightGeneratedContent?.subheader || 'Industry Spotlight'),
                        body: spotlightBox.innerHTML
                    };
                }
                // Fall back to Step 4 generated content
                if (!spotlightExport && generatedSpotlightContent) {
                    spotlightExport = generatedSpotlightContent;
                }
                // Fall back to Step 2B generated content
                if (!spotlightExport && spotlightGeneratedContent) {
                    spotlightExport = spotlightGeneratedContent;
                }

                console.log('[Export] Spotlight export data:', spotlightExport);

                // Get BriteCo Brief Intro - check Step 5 box first, then saved content, then Step 1 input
                const headerIntroExport = document.getElementById('headerIntroContentBox')?.innerHTML
                    || headerIntroContent
                    || document.getElementById('headerIntroInput')?.value?.trim()
                    || '';

                const content = {
                    header_intro: headerIntroExport,
                    introduction: document.getElementById('introContentBox')?.innerHTML || generatedIntroContent || '',
                    brite_spot: document.getElementById('briteSpotContentBox')?.innerHTML || briteSpotRewritten || briteSpotContent || '',
                    curious_claims: document.getElementById('claimsContentBox')?.innerHTML || generatedClaimsContent || '',
                    roundup: document.getElementById('roundupContentBox')?.innerHTML || generatedRoundupContent || '',
                    spotlight: spotlightExport,
                    agent_tips: generatedTipsContent || ''
                };

                // Format month for title: "2026 January - Agent Newsletter"
                const monthCapitalized = selectedMonth ? selectedMonth.charAt(0).toUpperCase() + selectedMonth.slice(1) : '';
                const year = new Date().getFullYear();
                const title = `${year} ${monthCapitalized} - Agent Newsletter`;

                // Store for email sending later
                lastExportedMonth = monthCapitalized;
                lastExportedYear = year;

                const response = await fetch(`${API_BASE}/api/export-to-docs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        title: title,
                        month: monthCapitalized,
                        year: year,
                        send_email: false,  // Don't send email during export
                        recipients: []
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Store the doc URL for later email sending
                    lastExportedDocUrl = data.doc_url;
                    console.log('[Export] Success! Doc URL:', data.doc_url);

                    resultDiv.style.display = 'block';
                    resultDiv.style.background = '#d1fae5';
                    resultDiv.style.border = '1px solid #10b981';

                    // Build the link HTML only if we have a valid doc_url
                    const docLinkHtml = data.doc_url
                        ? `<a href="${data.doc_url}" target="_blank" style="display: inline-block; margin-top: 12px; padding: 10px 20px; background: #4285f4; color: white; text-decoration: none; border-radius: 6px; font-size: 14px; font-weight: 600;">
                            Open in Google Docs
                        </a>
                        <p style="margin: 10px 0 0 0; font-size: 12px; color: #065f46; word-break: break-all;">
                            <strong>Link:</strong> ${data.doc_url}
                        </p>`
                        : '<p style="margin: 10px 0 0 0; font-size: 14px; color: #b45309;">Link not available - check console for details.</p>';

                    resultDiv.innerHTML = `
                        <p style="margin: 0 0 8px 0; font-weight: 600; color: #065f46; font-size: 16px;">Export Successful!</p>
                        <p style="margin: 0; font-size: 14px; color: #047857;">
                            Your newsletter has been exported to Google Docs.
                        </p>
                        ${docLinkHtml}
                    `;

                    // Show the email section
                    emailSection.style.display = 'block';
                } else {
                    resultDiv.style.display = 'block';
                    resultDiv.style.background = '#fee2e2';
                    resultDiv.style.border = '1px solid #ef4444';
                    resultDiv.innerHTML = `
                        <p style="margin: 0; font-weight: 600; color: #991b1b;">Export Failed</p>
                        <p style="margin: 5px 0 0 0; font-size: 14px; color: #b91c1c;">${data.error || 'Unknown error'}</p>
                    `;
                }
            } catch (error) {
                console.error('Export error:', error);
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fee2e2';
                resultDiv.style.border = '1px solid #ef4444';
                resultDiv.innerHTML = `
                    <p style="margin: 0; font-weight: 600; color: #991b1b;">Export Failed</p>
                    <p style="margin: 5px 0 0 0; font-size: 14px; color: #b91c1c;">${error.message}</p>
                `;
            } finally {
                btn.disabled = false;
                btnText.textContent = 'üìÑ Export to Google Docs';
            }
        }

        // Send email with the exported doc link (called after successful export)
        async function sendExportEmail() {
            if (!lastExportedDocUrl) {
                alert('Please export to Google Docs first');
                return;
            }

            const btn = document.getElementById('sendExportEmailBtn');
            const btnText = document.getElementById('sendExportEmailBtnText');
            const resultDiv = document.getElementById('emailSendResult');

            // Gather selected recipients from checkboxes
            let recipients = [];
            document.querySelectorAll('.docRecipientCheckbox:checked').forEach(cb => {
                recipients.push(cb.value);
            });

            // Add additional emails if provided
            const additionalEmails = document.getElementById('docAdditionalEmails')?.value.trim() || '';
            if (additionalEmails) {
                const extras = additionalEmails.split(',').map(e => e.trim()).filter(e => e.includes('@'));
                recipients = recipients.concat(extras);
            }

            if (recipients.length === 0) {
                alert('Please select at least one recipient or add an email address');
                return;
            }

            // Show loading state
            btn.disabled = true;
            btnText.textContent = 'Sending...';
            resultDiv.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/api/send-doc-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        doc_url: lastExportedDocUrl,
                        month: lastExportedMonth,
                        year: lastExportedYear,
                        recipients: recipients
                    })
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.style.display = 'block';
                    resultDiv.style.background = '#d1fae5';
                    resultDiv.style.border = '1px solid #10b981';
                    resultDiv.innerHTML = `
                        <p style="margin: 0; font-weight: 600; color: #065f46;">‚úì Email sent to ${recipients.length} recipient${recipients.length > 1 ? 's' : ''}!</p>
                    `;
                } else {
                    resultDiv.style.display = 'block';
                    resultDiv.style.background = '#fee2e2';
                    resultDiv.style.border = '1px solid #ef4444';
                    resultDiv.innerHTML = `
                        <p style="margin: 0; font-weight: 600; color: #991b1b;">Email Failed</p>
                        <p style="margin: 5px 0 0 0; font-size: 14px; color: #b91c1c;">${data.error || 'Unknown error'}</p>
                    `;
                }
            } catch (error) {
                console.error('Email error:', error);
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fee2e2';
                resultDiv.style.border = '1px solid #ef4444';
                resultDiv.innerHTML = `
                    <p style="margin: 0; font-weight: 600; color: #991b1b;">Email Failed</p>
                    <p style="margin: 5px 0 0 0; font-size: 14px; color: #b91c1c;">${error.message}</p>
                `;
            } finally {
                btn.disabled = false;
                btnText.textContent = '‚úâÔ∏è Send Email';
            }
        }

        function exportAllCopy() {
            // Gather all newsletter content
            const newsTitle = selectedNews?.title || '';
            const newsContent = cleanContent(generatedNewsContent);

            // Use AI-generated short titles if available
            const tipTitle = generatedTipTitle || selectedTip?.title || '';
            const tipContent = cleanContent(generatedTipContent);

            const trendTitle = generatedTrendTitle || selectedTrend?.title || '';
            const trendContent = cleanContent(generatedTrendContent);

            // Create HTML document for Word-compatible output
            const htmlDoc = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Newsletter Content - ${selectedMonth}</title>
    <style>
        body {
            font-family: 'Calibri', 'Arial', sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            color: #333;
        }
        h1 {
            color: #272d3f;
            border-bottom: 3px solid #008181;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        h2 {
            color: #008181;
            margin-top: 40px;
            margin-bottom: 15px;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        h3 {
            color: #272d3f;
            margin-top: 10px;
            margin-bottom: 15px;
            font-size: 22px;
        }
        p {
            margin-bottom: 15px;
        }
        .section {
            margin-bottom: 50px;
            page-break-inside: avoid;
        }
        .meta {
            color: #666;
            font-size: 14px;
            margin-bottom: 30px;
        }
        hr {
            border: none;
            border-top: 1px solid #e5e7eb;
            margin: 40px 0;
        }
    </style>
</head>
<body>
    <h1>Newsletter Content - ${selectedMonth.charAt(0).toUpperCase() + selectedMonth.slice(1)}</h1>
    <p class="meta">Generated: ${new Date().toLocaleDateString()}</p>

    <div class="section">
        <h2>üì∞ News You Can Use</h2>
        <h3>${newsTitle}</h3>
        <div>${newsContent}</div>
    </div>

    <hr>

    <div class="section">
        <h2>üí° BriteCo Insight</h2>
        <h3>${tipTitle}</h3>
        <div>${tipContent}</div>
    </div>

    <hr>

    <div class="section">
        <h2>üìà Trend Alert</h2>
        <h3>${trendTitle}</h3>
        <div>${trendContent}</div>
    </div>
</body>
</html>
            `.trim();

            // Create Word-compatible HTML file (.doc extension opens in Word)
            const blob = new Blob([htmlDoc], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `newsletter-copy-${selectedMonth}.doc`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('‚úì Newsletter copy exported as Word document!');
        }

        async function generateImages(forceRegenerate = false) {
            // Check if prompts already exist and we're not forcing regeneration
            if (promptsAlreadyGenerated && !forceRegenerate) {
                console.log('[Navigation] Prompts already generated, showing existing prompts');
                showStep(8); // Just show the Edit Image Prompts step
                document.getElementById('promptGenerationLoading').style.display = 'none';
                document.getElementById('promptEditing').style.display = 'block';
                return;
            }

            try {
                // STEP 1: Generate prompts only
                showStep(8); // Edit Image Prompts step
                document.getElementById('promptGenerationLoading').style.display = 'block';
                document.getElementById('promptEditing').style.display = 'none';

                // Extract content text for each section
                const briteSpotText = briteSpotRewritten || briteSpotContent || '';
                const claimsText = extractContentText(generatedClaimsContent);
                const spotlightText = extractContentText(generatedSpotlightContent);
                // Handle new format { intro, tips: [...] } or old array format
                let tipsText = '';
                if (generatedTipsContent && generatedTipsContent.intro) {
                    tipsText = generatedTipsContent.intro + ' ' + (generatedTipsContent.tips || []).map(t => t.tip || t).join(' ');
                } else if (Array.isArray(generatedTipsContent)) {
                    tipsText = generatedTipsContent.map(t => t.tip || t).join(' ');
                } else {
                    tipsText = extractContentText(generatedTipsContent);
                }

                // DEBUG: Log what content was extracted
                console.log('[FRONTEND DEBUG] ===== CONTENT EXTRACTION =====');
                console.log('[FRONTEND DEBUG] briteSpotContent:', briteSpotText?.substring(0, 300));
                console.log('[FRONTEND DEBUG] generatedClaimsContent:', claimsText?.substring(0, 300));
                console.log('[FRONTEND DEBUG] generatedSpotlightContent:', spotlightText?.substring(0, 300));
                console.log('[FRONTEND DEBUG] generatedTipsContent:', tipsText?.substring(0, 300));

                const sections = {
                    briteSpot: { title: 'The Brite Spot', content: briteSpotText, month: selectedMonth },
                    claims: { title: selectedClaims?.title || 'Curious Claims', content: claimsText, month: selectedMonth },
                    spotlight: { title: generatedSpotlightSubheader || 'InsurNews Spotlight', content: spotlightText, month: selectedMonth },
                    tips: { title: 'Agent Advantage', content: tipsText, month: selectedMonth }
                };

                console.log('[FRONTEND DEBUG] ===== SECTIONS BEING SENT TO API =====');
                console.log('[FRONTEND DEBUG] Brite Spot title:', sections.briteSpot.title);
                console.log('[FRONTEND DEBUG] Claims title:', sections.claims.title);
                console.log('[FRONTEND DEBUG] Spotlight title:', sections.spotlight.title);
                console.log('[FRONTEND DEBUG] Tips title:', sections.tips.title);
                console.log('[FRONTEND DEBUG] Full sections object:', JSON.stringify(sections, null, 2));

                // Call API to generate prompts
                const response = await fetch(`${API_BASE}/api/generate-image-prompts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sections })
                });

                const data = await response.json();

                console.log('[FRONTEND DEBUG] Received prompts from API:', data.prompts);

                if (!data.success) {
                    alert('Error generating image prompts: ' + (data.error || 'Unknown error'));
                    showStep(7); // Back to Check Results
                    return;
                }

                // Display prompts in textareas
                // Store base prompts (without style modifiers)
                basePrompts.briteSpot = data.prompts.briteSpot?.prompt || data.prompts.briteSpot || '';
                basePrompts.claims = data.prompts.claims?.prompt || data.prompts.claims || '';
                basePrompts.spotlight = data.prompts.spotlight?.prompt || data.prompts.spotlight || '';
                basePrompts.tips = data.prompts.tips?.prompt || data.prompts.tips || '';

                document.getElementById('briteSpotImagePromptText').value = basePrompts.briteSpot;
                document.getElementById('claimsImagePromptText').value = basePrompts.claims;
                document.getElementById('spotlightImagePromptText').value = basePrompts.spotlight;
                document.getElementById('tipsImagePromptText').value = basePrompts.tips;

                console.log('[FRONTEND DEBUG] Set briteSpotImagePromptText to:', basePrompts.briteSpot);
                console.log('[FRONTEND DEBUG] Set claimsImagePromptText to:', basePrompts.claims);
                console.log('[FRONTEND DEBUG] Set spotlightImagePromptText to:', basePrompts.spotlight);
                console.log('[FRONTEND DEBUG] Set tipsImagePromptText to:', basePrompts.tips);

                // Show article titles
                document.getElementById('briteSpotPromptArticle').textContent = `For: The Brite Spot`;
                document.getElementById('claimsPromptArticle').textContent = `For: ${selectedClaims?.title || 'Curious Claims'}`;
                document.getElementById('spotlightPromptArticle').textContent = `For: ${generatedSpotlightSubheader || 'InsurNews Spotlight'}`;
                document.getElementById('tipsPromptArticle').textContent = `For: Agent Advantage Tips`;

                // Apply the default style (photorealistic) to all prompts on initial load
                // This ensures the style modifier is added even without user interaction
                updatePromptWithStyle('briteSpot');
                updatePromptWithStyle('claims');
                updatePromptWithStyle('spotlight');
                updatePromptWithStyle('tips');

                // Mark prompts as generated
                promptsAlreadyGenerated = true;

                // Show editing UI
                document.getElementById('promptGenerationLoading').style.display = 'none';
                document.getElementById('promptEditing').style.display = 'block';
            } catch (error) {
                console.error('Error:', error);
                alert('Error generating prompts: ' + error.message);
                showStep(7); // Back to Check Results
            }
        }

        // Store base prompts for each section (without style modifiers)
        let basePrompts = {
            briteSpot: '',
            claims: '',
            spotlight: '',
            tips: ''
        };

        function updatePromptWithStyle(section) {
            const styleSelect = document.getElementById(`${section}ImageStyle`);
            const promptTextarea = document.getElementById(`${section}ImagePromptText`);

            if (!styleSelect || !promptTextarea) {
                console.log(`[IMAGE STYLE] Elements not found for section: ${section}`);
                return;
            }

            const style = styleSelect.value;

            // Get base prompt - prefer stored basePrompts, fall back to textarea value
            let basePrompt = basePrompts[section];
            if (!basePrompt || basePrompt.trim() === '') {
                basePrompt = promptTextarea.value;
                // Also store it for future use
                basePrompts[section] = basePrompt;
            }

            console.log(`[IMAGE STYLE] Section: ${section}, Style: ${style}, Base prompt length: ${basePrompt.length}`);

            // Remove any existing style modifiers (more comprehensive matching)
            basePrompt = basePrompt
                .replace(/,?\s*realistic\s+(photo|photography|image)/gi, '')
                .replace(/,?\s*photorealistic/gi, '')
                .replace(/,?\s*professional\s+(photography|magazine\s+photography|architectural\s+photography)/gi, '')
                .replace(/,?\s*high-end\s+(photography|quality|magazine)/gi, '')
                .replace(/,?\s*magazine\s+(quality|photography|style)/gi, '')
                .replace(/,?\s*AI\s+generated(\s+art)?/gi, '')
                .replace(/,?\s*digital\s+art(\s+style)?/gi, '')
                .replace(/,?\s*generative\s+art/gi, '')
                .replace(/,?\s*cartoon(\s+illustration)?/gi, '')
                .replace(/,?\s*illustration/gi, '')
                .replace(/,?\s*illustrated/gi, '')
                .replace(/,?\s*hand-drawn(\s+style)?/gi, '')
                .replace(/,?\s*comic\s+style/gi, '')
                .replace(/,?\s*infographic(\s+design)?/gi, '')
                .replace(/,?\s*data\s+visualization/gi, '')
                .replace(/,?\s*graphic\s+design/gi, '')
                .replace(/,?\s*flat\s+(design|graphic)/gi, '')
                .replace(/,\s*,/g, ',')  // Remove double commas
                .replace(/,\s*$/g, '')    // Remove trailing comma
                .trim();

            // Add style modifier based on selection
            let styleModifier = '';
            switch(style) {
                case 'photorealistic':
                    styleModifier = '. Professional photorealistic photography, high-end magazine quality, natural lighting';
                    break;
                case 'sketch':
                    styleModifier = '. Sketch illustration style, hand-drawn pencil or ink, artistic linework';
                    break;
                case 'watercolor':
                    styleModifier = '. Watercolor painting style, soft edges, artistic brushstrokes, elegant and romantic';
                    break;
                case 'modern-flat':
                    styleModifier = '. Modern flat design, minimalist geometric shapes, bold colors, clean aesthetic';
                    break;
                case 'magazine':
                    styleModifier = '. Magazine editorial photography, professional styling, high-fashion aesthetic';
                    break;
                case 'cartoon':
                    styleModifier = '. Cartoon illustration style, colorful hand-drawn design, friendly and playful';
                    break;
                case 'infographic':
                    styleModifier = '. Infographic design style, clean flat graphics, data visualization aesthetic';
                    break;
            }

            // Update textarea with new prompt (use period instead of comma to separate instructions clearly)
            const finalPrompt = basePrompt + styleModifier;
            promptTextarea.value = finalPrompt;
            console.log(`[IMAGE STYLE] Final prompt for ${section}: ${finalPrompt.substring(0, 100)}...`);
        }

        // Helper function to go back to prompts without regenerating
        function goBackToPrompts() {
            showStep(8);
            // Ensure prompts editing UI is visible
            document.getElementById('promptGenerationLoading').style.display = 'none';
            document.getElementById('promptEditing').style.display = 'block';
        }

        // Helper function to go back to meme concept with state preserved
        function goBackToMemeConceptWithState() {
            showStep('10_5');
            // Restore the saved values if they exist
            if (memeConceptData.scene) {
                document.getElementById('memeScenePrompt').value = memeConceptData.scene;
                document.getElementById('memeTopText').value = memeConceptData.topText;
                document.getElementById('memeBottomText').value = memeConceptData.bottomText;
            }
        }

        // Helper function to go back to article images without regenerating
        function goBackToArticleImages() {
            showStep(10);
            displayImages(); // Ensure images are displayed
        }

        async function generateImagesFromPrompts(forceRegenerate = false) {
            // Check if images already exist and we're not forcing regeneration
            if (imagesAlreadyGenerated && !forceRegenerate && generatedImages.briteSpot && generatedImages.claims && generatedImages.spotlight && generatedImages.tips) {
                console.log('[Navigation] Images already generated, showing existing images');
                displayImages();
                showStep(10);
                return;
            }

            try {
                // Show loading overlay on Step 13 instead of changing steps
                document.getElementById('promptGenerationLoading').style.display = 'block';
                document.getElementById('promptGenerationLoading').innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <h3>Generating Images...</h3>
                        <p style="color: #666;">Using Nano Banana (Gemini) to create article-specific images...</p>
                        <p style="color: #999; font-size: 14px; margin-top: 10px;">This may take 30-60 seconds for 4 images...</p>
                    </div>
                `;
                document.getElementById('promptEditing').style.display = 'none';

                // Read prompts from textareas
                const prompts = {
                    briteSpot: document.getElementById('briteSpotImagePromptText').value,
                    claims: document.getElementById('claimsImagePromptText').value,
                    spotlight: document.getElementById('spotlightImagePromptText').value,
                    tips: document.getElementById('tipsImagePromptText').value
                };

                console.log('[IMAGE GEN] Sending prompts to Nano Banana:', prompts);

                // Extract content text for sections (needed by API)
                const briteSpotText = briteSpotRewritten || briteSpotContent || '';
                const claimsText = extractContentText(generatedClaimsContent);
                const spotlightText = extractContentText(generatedSpotlightContent);
                // Handle new format { intro, tips: [...] } or old array format
                let tipsText = '';
                if (generatedTipsContent && generatedTipsContent.intro) {
                    tipsText = generatedTipsContent.intro + ' ' + (generatedTipsContent.tips || []).map(t => t.tip || t).join(' ');
                } else if (Array.isArray(generatedTipsContent)) {
                    tipsText = generatedTipsContent.map(t => t.tip || t).join(' ');
                } else {
                    tipsText = extractContentText(generatedTipsContent);
                }

                const sections = {
                    briteSpot: { title: 'The Brite Spot', content: briteSpotText, month: selectedMonth },
                    claims: { title: selectedClaims?.title || 'Curious Claims', content: claimsText, month: selectedMonth },
                    spotlight: { title: generatedSpotlightSubheader || 'InsurNews Spotlight', content: spotlightText, month: selectedMonth },
                    tips: { title: 'Agent Advantage', content: tipsText, month: selectedMonth }
                };

                // Call API to generate images
                const response = await fetch(`${API_BASE}/api/generate-images`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sections: sections,
                        prompts: prompts,
                        month: selectedMonth
                    })
                });

                const data = await response.json();

                console.log('[IMAGE GEN] Received images:', data);

                if (!data.success) {
                    alert('Error generating images: ' + (data.error || 'Unknown error'));
                    document.getElementById('promptGenerationLoading').style.display = 'none';
                    document.getElementById('promptEditing').style.display = 'block';
                    return;
                }

                // Store images with their prompts
                generatedImages.briteSpot = { url: data.images.briteSpot, prompt: prompts.briteSpot };
                generatedImages.claims = { url: data.images.claims, prompt: prompts.claims };
                generatedImages.spotlight = { url: data.images.spotlight, prompt: prompts.spotlight };
                generatedImages.tips = { url: data.images.tips, prompt: prompts.tips };

                // Mark images as generated
                imagesAlreadyGenerated = true;

                console.log('[IMAGE GEN] Images stored successfully');

                // Display images and go to Step 10 (Review Images)
                displayImages();
                showStep(10);
            } catch (error) {
                console.error('Error:', error);
                alert('Error generating images: ' + error.message);
                showStep(8); // Back to Edit Prompts
            }
        }

        async function generateMemePrompt(forceRegenerate = false) {
            // Check if meme concept already exists and we're not forcing regeneration
            if (memeConceptGenerated && !forceRegenerate && memeConceptData.scene) {
                console.log('[Navigation] Meme concept already generated, showing existing concept');
                showStep('10_5');
                // Restore the saved values
                document.getElementById('memeScenePrompt').value = memeConceptData.scene;
                document.getElementById('memeTopText').value = memeConceptData.topText;
                document.getElementById('memeBottomText').value = memeConceptData.bottomText;
                return;
            }

            try {
                // Show loading screen first
                showStep('10_4'); // Generating Meme Concept loading

                // Wait a tiny bit for UI to update
                await new Promise(resolve => setTimeout(resolve, 100));

                // Gather newsletter content
                const newsContent = extractContentText(cleanContent(generatedNewsContent));
                const tipContent = extractContentText(cleanContent(generatedTipContent));
                const trendContent = extractContentText(cleanContent(generatedTrendContent));

                console.log('Calling Claude API to generate meme concept...');
                console.log('News content:', newsContent.substring(0, 100));

                const response = await fetch(`${API_BASE}/api/generate-meme-prompt`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sections: {
                            news: { content: newsContent },
                            tip: { content: tipContent },
                            trend: { content: trendContent }
                        },
                        month: selectedMonth
                    })
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (data.success) {
                    console.log('‚úì Claude generated meme concept successfully');
                    console.log('Scene:', data.scene);
                    console.log('Top text:', data.text_top);
                    console.log('Bottom text:', data.text_bottom);

                    // Store meme concept data
                    memeConceptData.scene = data.scene || '';
                    memeConceptData.topText = data.text_top || '';
                    memeConceptData.bottomText = data.text_bottom || '';
                    memeConceptGenerated = true;

                    // Show step 10_5 with the results
                    showStep('10_5');

                    // Fill in the form fields with generated content
                    document.getElementById('memeScenePrompt').value = memeConceptData.scene;
                    document.getElementById('memeTopText').value = memeConceptData.topText;
                    document.getElementById('memeBottomText').value = memeConceptData.bottomText;
                } else {
                    throw new Error(data.error || 'Failed to generate meme prompt');
                }

            } catch (error) {
                console.error('Error generating meme prompt:', error);

                // Show step 10_5 even on error
                showStep('10_5');

                alert('Error generating meme concept: ' + error.message);
                // Set default values
                document.getElementById('memeScenePrompt').value = 'Insurance agent looking stressed during open enrollment';
                document.getElementById('memeTopText').value = 'INSURANCE SEASON';
                document.getElementById('memeBottomText').value = "IT'S HAPPENING";
            }
        }

        async function proceedToMemeGeneration(forceRegenerate = false) {
            // Check if meme image already exists and we're not forcing regeneration
            if (memeImageGenerated && !forceRegenerate && generatedImages.meme && generatedImages.meme.url) {
                console.log('[Navigation] Meme already generated, showing existing meme');
                showStep(11);
                displayImages(); // This will show the existing meme
                return;
            }

            try {
                // Get the edited values from the form
                const scenePrompt = document.getElementById('memeScenePrompt').value;
                const topText = document.getElementById('memeTopText').value;
                const bottomText = document.getElementById('memeBottomText').value;

                // Navigate to Step 11 (Meme Generation)
                showStep(11);

                // Show loading state
                const memePreview = document.getElementById('memePreview');
                memePreview.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div class="spinner" style="margin: 0 auto 20px;"></div>
                        <div style="color: #666;">Generating meme with your concept...</div>
                    </div>
                `;

                // Generate meme with the custom prompt and text overlay
                const response = await fetch(`${API_BASE}/api/generate-meme`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: scenePrompt,
                        text_top: topText.toUpperCase(),
                        text_bottom: bottomText.toUpperCase(),
                        month: selectedMonth
                    })
                });

                const data = await response.json();

                console.log('Meme generation response:', data);

                if (data.success && data.url) {
                    generatedImages.meme = {
                        url: data.url,
                        prompt: scenePrompt,
                        text_top: topText.toUpperCase(),
                        text_bottom: bottomText.toUpperCase(),
                        textSize: 32,
                        textColor: '#FFFFFF'
                    };

                    // Mark meme as generated
                    memeImageGenerated = true;

                    // Update meme prompt field on Step 16
                    document.getElementById('memePrompt').value = scenePrompt;

                    // Display the generated meme
                    displayImages();
                } else {
                    throw new Error(data.error || 'Failed to generate meme');
                }

            } catch (error) {
                console.error('Error generating meme:', error);
                document.getElementById('memePreview').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc2626;">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚ùå</div>
                        <div>Error: ${error.message}</div>
                        <button class="btn-secondary btn" onclick="proceedToMemeGeneration(true)" style="margin-top: 20px;">üîÑ Try Again</button>
                    </div>
                `;
            }
        }

        async function generateMeme(showLoadingOverStep16 = false) {
            try {
                if (showLoadingOverStep16) {
                    // Show loading overlay on Step 16
                    const memePreview = document.getElementById('memePreview');
                    memePreview.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div class="spinner" style="margin: 0 auto 20px;"></div>
                            <h3 style="color: #333; margin: 0 0 10px 0;">Generating Meme...</h3>
                            <p style="color: #666; margin: 0;">Using Nano Banana (Gemini) to create a fun monthly meme...</p>
                            <p style="color: #999; font-size: 14px; margin-top: 10px;">Estimated time: ~15-20 seconds</p>
                        </div>
                    `;
                }

                const response = await fetch(`${API_BASE}/api/generate-meme`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        month: selectedMonth
                    })
                });

                const data = await response.json();

                if (data.success) {
                    generatedImages.meme = {
                        url: data.url,
                        prompt: data.prompt,  // Store the prompt for editing
                        text_top: data.text_top || '',
                        text_bottom: data.text_bottom || ''
                    };

                    // Update display if we're showing loading
                    if (showLoadingOverStep16) {
                        displayImages();
                    }
                } else {
                    console.error('Error generating meme:', data.error);
                    if (showLoadingOverStep16) {
                        document.getElementById('memePreview').innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #dc2626;">
                                <p>Error generating meme. Please try again.</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error generating meme:', error);
                if (showLoadingOverStep16) {
                    document.getElementById('memePreview').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc2626;">
                            <p>Error generating meme: ${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        async function regenerateImage(imageType) {
            try {
                // Show loading in the specific preview
                // For meme, use 'memePreview', for others use '{type}ImagePreview'
                const previewId = imageType === 'meme' ? 'memePreview' : `${imageType}ImagePreview`;
                const preview = document.getElementById(previewId);

                if (!preview) {
                    console.error(`[REGENERATE ERROR] Preview element not found: ${previewId}`);
                    alert(`Error: Preview element ${previewId} not found. Are you on the correct step?`);
                    return;
                }

                preview.innerHTML = `
                    <div style="text-align: center; color: #999;">
                        <div class="spinner" style="margin: 0 auto 10px;"></div>
                        <div>Regenerating...</div>
                    </div>
                `;

                if (imageType === 'meme') {
                    // Get custom prompt from textarea
                    const promptTextarea = document.getElementById('memePrompt');
                    const customPrompt = promptTextarea ? promptTextarea.value.trim() : '';

                    if (customPrompt) {
                        console.log('[REGENERATE] Calling API to regenerate meme with custom prompt:', customPrompt);
                        // Use custom prompt for meme regeneration
                        const response = await fetch(`${API_BASE}/api/generate-meme`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                month: selectedMonth,
                                customPrompt: customPrompt
                            })
                        });

                        const data = await response.json();
                        if (data.success) {
                            // Store meme with URL, prompt, and text overlay
                            generatedImages.meme = {
                                url: data.url,
                                prompt: data.prompt,
                                text_top: data.text_top || '',
                                text_bottom: data.text_bottom || ''
                            };
                            console.log('[REGENERATE] Successfully regenerated meme');
                        } else {
                            throw new Error(data.error || 'Failed to regenerate meme');
                        }
                    } else {
                        console.log('[REGENERATE] No custom prompt, using default meme generation');
                        await generateMeme();
                    }
                } else {
                    // Get custom prompt from textarea for section images
                    const promptTextarea = document.getElementById(`${imageType}Prompt`);
                    const customPrompt = promptTextarea ? promptTextarea.value.trim() : '';

                    if (!customPrompt) {
                        alert('Please enter a prompt to regenerate the image.');
                        preview.innerHTML = `<div style="text-align: center; color: #dc2626;">No prompt provided</div>`;
                        return;
                    }

                    // Regenerate section image with custom prompt
                    // Map section types to their content sources
                    let section = { title: imageType, season: '' };
                    let sectionContentObj = null;

                    switch(imageType) {
                        case 'briteSpot':
                            section = { title: 'Brite Spot', season: '' };
                            sectionContentObj = generatedBriteSpotContent || briteSpotContent || '';
                            break;
                        case 'claims':
                            section = selectedClaims || { title: 'Curious Claims', season: '' };
                            sectionContentObj = generatedClaimsContent || '';
                            break;
                        case 'spotlight':
                            section = { title: generatedSpotlightSubheader || 'InsurNews Spotlight', season: '' };
                            sectionContentObj = generatedSpotlightContent || spotlightGeneratedContent || '';
                            break;
                        case 'tips':
                            section = { title: 'Agent Advantage', season: '' };
                            sectionContentObj = generatedTipsContent || '';
                            break;
                        case 'news':
                            section = selectedNews || { title: 'News', season: '' };
                            sectionContentObj = generatedNewsContent || '';
                            break;
                        case 'tip':
                            section = selectedTip || { title: 'Tip', season: '' };
                            sectionContentObj = generatedTipContent || '';
                            break;
                        default:
                            section = selectedTrend || { title: imageType, season: '' };
                            sectionContentObj = generatedTrendContent || '';
                    }

                    // Use same extraction helper as generateImages
                    function extractContentText(content) {
                        if (!content) return '';
                        if (content.raw) {
                            try {
                                const cleaned = content.raw.replace(/```json\n/g, '').replace(/\n```/g, '');
                                const parsed = JSON.parse(cleaned);
                                if (parsed.short_version) return `${parsed.short_version} ${parsed.whats_happening || ''} ${parsed.why_matters || ''}`;
                                if (parsed.content) return parsed.content;
                                if (parsed.intro) return `${parsed.intro} ${(parsed.steps || []).join(' ')}`;
                                if (parsed.overview) return `${parsed.overview} ${(parsed.trends || []).map(t => t.description || '').join(' ')}`;
                                return JSON.stringify(parsed);
                            } catch (e) {
                                return content.raw.substring(0, 500);
                            }
                        }
                        if (typeof content === 'string') return content;
                        if (content.content) return content.content;
                        if (content.short_version) return `${content.short_version} ${content.whats_happening || ''} ${content.why_matters || ''}`;
                        return JSON.stringify(content).substring(0, 500);
                    }

                    const sectionContent = extractContentText(sectionContentObj);

                    console.log(`[REGENERATE] Calling API to regenerate ${imageType} with custom prompt:`, customPrompt);

                    const response = await fetch(`${API_BASE}/api/generate-images`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            month: selectedMonth,
                            sections: {
                                [imageType]: {
                                    title: section.title,
                                    content: sectionContent,
                                    month: selectedMonth,
                                    season: section.season
                                }
                            },
                            prompts: { [imageType]: customPrompt }
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Store image with URL and prompt structure
                        generatedImages[imageType] = {
                            url: data.images[imageType],
                            prompt: customPrompt
                        };
                        console.log(`[REGENERATE] Successfully regenerated ${imageType} image`);
                    } else {
                        throw new Error(data.error || 'Failed to regenerate image');
                    }
                }

                // Redisplay images
                displayImages();
            } catch (error) {
                console.error('Error regenerating image:', error);
                alert('Error regenerating image: ' + error.message);
            }
        }

        function displayImages() {
            // Display meme with draggable text boxes
            if (generatedImages.meme) {
                document.getElementById('memePreview').innerHTML = `
                    <div id="meme-preview-container" style="position: relative; display: inline-block; max-width: 100%;">
                        <img id="meme-preview-img" src="${generatedImages.meme.url}" alt="Monthly Meme" style="max-width: 100%; border-radius: 8px; display: block;" />
                        <div id="meme-text-boxes-container" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;">
                            <!-- Text boxes will be rendered here -->
                        </div>
                    </div>
                    <p style="background: #f0fdf4; padding: 0.75rem; border-radius: 8px; margin-top: 0.75rem; color: #047857; font-size: 0.9rem; text-align: center;">
                        <strong>Drag to move</strong> | <strong>Drag corners to resize</strong> | <strong>Click to select</strong>
                    </p>
                `;
                document.getElementById('memePrompt').value = generatedImages.meme.prompt || '';

                // Add text overlay controls if they don't exist
                if (!document.getElementById('memeTextControls')) {
                    const promptContainer = document.getElementById('memePrompt').parentElement;
                    const textControlsHTML = `
                        <div id="memeTextControls" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0; color: #374151;">Text Overlay Settings</h4>
                                <button onclick="addMemeTextBox()" class="btn btn-secondary" style="padding: 8px 16px; background: #018181; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    + Add Text Box
                                </button>
                            </div>

                            <div id="meme-text-box-tabs" style="display: flex; gap: 0.5rem; margin-bottom: 15px; flex-wrap: wrap;">
                                <!-- Text box tabs will be rendered here -->
                            </div>

                            <div id="meme-text-box-controls">
                                <p style="color: #999; text-align: center; padding: 20px;">Click "Add Text Box" to add text to your meme</p>
                            </div>
                        </div>
                    `;
                    promptContainer.insertAdjacentHTML('beforeend', textControlsHTML);
                }

                // Render text boxes after a brief delay to ensure DOM is ready
                setTimeout(() => {
                    renderAllMemeTextBoxes();
                    renderMemeTextBoxControls();
                }, 100);
            }

            // Display Brite Spot image
            if (generatedImages.briteSpot) {
                document.getElementById('briteSpotImagePreview').innerHTML = `
                    <img src="${generatedImages.briteSpot.url}" alt="Brite Spot Image" style="max-width: 100%; border-radius: 8px;" />
                `;
                document.getElementById('briteSpotPrompt').value = generatedImages.briteSpot.prompt || '';
            }

            // Display Claims image
            if (generatedImages.claims) {
                document.getElementById('claimsImagePreview').innerHTML = `
                    <img src="${generatedImages.claims.url}" alt="Curious Claims Image" style="max-width: 100%; border-radius: 8px;" />
                `;
                document.getElementById('claimsPrompt').value = generatedImages.claims.prompt || '';
            }

            // Display Spotlight image
            if (generatedImages.spotlight) {
                document.getElementById('spotlightImagePreview').innerHTML = `
                    <img src="${generatedImages.spotlight.url}" alt="Spotlight Image" style="max-width: 100%; border-radius: 8px;" />
                `;
                document.getElementById('spotlightPrompt').value = generatedImages.spotlight.prompt || '';
            }

            // Display Tips image
            if (generatedImages.tips) {
                document.getElementById('tipsImagePreview').innerHTML = `
                    <img src="${generatedImages.tips.url}" alt="Agent Advantage Image" style="max-width: 100%; border-radius: 8px;" />
                `;
                document.getElementById('tipsPrompt').value = generatedImages.tips.prompt || '';
            }
        }

        // Export image as download
        function exportImage(imageType) {
            const imageData = generatedImages[imageType];
            if (!imageData || !imageData.url) {
                alert('No image to export. Please generate an image first.');
                return;
            }

            // Create a temporary link and trigger download
            const link = document.createElement('a');
            link.href = imageData.url;
            link.download = `${imageType}-image-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Resize image with quality options
        async function resizeImage(imageType) {
            const imageData = generatedImages[imageType];
            if (!imageData || !imageData.url) {
                alert('No image to resize. Please generate an image first.');
                return;
            }

            // Ask user for size preference
            const size = prompt('Choose image size:\n1 = 1K (1024√ó1024)\n2 = 2K (2048√ó2048)\n3 = 4K (4096√ó4096)\n\nEnter 1, 2, or 3:', '1');

            if (!size || !['1', '2', '3'].includes(size)) {
                return; // User cancelled or invalid input
            }

            const dimensions = {
                '1': 1024,
                '2': 2048,
                '3': 4096
            };

            const targetSize = dimensions[size];

            // For now, just show info since backend needs to handle actual resizing
            alert(`Image will be resized to ${targetSize}√ó${targetSize}.\n\nNote: This feature requires backend implementation for proper image scaling.`);

            // TODO: Call backend API to resize image
            // const response = await fetch(`${API_BASE}/api/resize-image`, {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify({
            //         image_data: imageData.url,
            //         size: targetSize
            //     })
            // });
        }

        // ============================================================================
        // MEME DRAGGABLE TEXT BOX FUNCTIONS
        // ============================================================================

        function addMemeTextBox() {
            const newTextBox = {
                text: 'NEW TEXT',
                x: 50,
                y: 20 + (memeTextOverlays.length * 25) % 60, // Stagger vertically
                fontSize: 32,
                textColor: '#FFFFFF',
                fontFamily: 'Impact',
                textShadow: true
            };

            memeTextOverlays.push(newTextBox);
            selectedMemeTextBox = memeTextOverlays.length - 1;

            renderAllMemeTextBoxes();
            renderMemeTextBoxControls();
        }

        function deleteMemeTextBox(boxIndex) {
            if (memeTextOverlays.length <= 1) {
                // Clear the last text box instead of deleting
                memeTextOverlays[0].text = '';
                selectedMemeTextBox = 0;
            } else {
                memeTextOverlays.splice(boxIndex, 1);
                if (selectedMemeTextBox >= memeTextOverlays.length) {
                    selectedMemeTextBox = memeTextOverlays.length - 1;
                }
            }

            renderAllMemeTextBoxes();
            renderMemeTextBoxControls();
        }

        function selectMemeTextBox(boxIndex) {
            selectedMemeTextBox = boxIndex;
            renderAllMemeTextBoxes();
            renderMemeTextBoxControls();
        }

        function renderMemeTextBoxControls() {
            const controlsContainer = document.getElementById('meme-text-box-controls');
            const tabsContainer = document.getElementById('meme-text-box-tabs');

            if (!controlsContainer || !tabsContainer) return;

            if (memeTextOverlays.length === 0 || selectedMemeTextBox < 0 || selectedMemeTextBox >= memeTextOverlays.length) {
                tabsContainer.innerHTML = '';
                controlsContainer.innerHTML = `
                    <p style="color: #999; text-align: center; padding: 20px;">Click "Add Text Box" to add text to your meme</p>
                `;
                return;
            }

            const box = memeTextOverlays[selectedMemeTextBox];

            // Render tabs
            tabsContainer.innerHTML = memeTextOverlays.map((b, i) => `
                <button onclick="selectMemeTextBox(${i})"
                        style="padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.85rem; cursor: pointer;
                               background: ${i === selectedMemeTextBox ? '#018181' : '#f3f4f6'};
                               color: ${i === selectedMemeTextBox ? 'white' : '#374151'};
                               border: 2px solid ${i === selectedMemeTextBox ? '#018181' : '#e5e7eb'};">
                    Text ${i + 1}
                </button>
            `).join('');

            // Render controls for selected text box
            controlsContainer.innerHTML = `
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #374151;">Text Content:</label>
                <textarea id="meme-overlay-text"
                       placeholder="Enter your text..."
                       rows="2"
                       style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; margin-bottom: 15px; font-size: 14px; font-family: inherit; text-transform: uppercase;"
                       oninput="updateSelectedMemeTextBox()">${box.text}</textarea>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #374151; font-size: 0.9rem;">Font</label>
                        <select id="meme-overlay-font" onchange="updateSelectedMemeTextBox()"
                                style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.9rem;">
                            <option value="Impact" ${box.fontFamily === 'Impact' ? 'selected' : ''}>Impact (Classic Meme)</option>
                            <option value="Arial Black" ${box.fontFamily === 'Arial Black' ? 'selected' : ''}>Arial Black</option>
                            <option value="Comic Sans MS" ${box.fontFamily === 'Comic Sans MS' ? 'selected' : ''}>Comic Sans</option>
                            <option value="Helvetica" ${box.fontFamily === 'Helvetica' ? 'selected' : ''}>Helvetica</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #374151; font-size: 0.9rem;">Text Color</label>
                        <input type="color" id="meme-overlay-color" value="${box.textColor}"
                               onchange="updateSelectedMemeTextBox()"
                               style="width: 100%; height: 38px; padding: 4px; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="meme-overlay-shadow" ${box.textShadow ? 'checked' : ''} onchange="updateSelectedMemeTextBox()"
                               style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 600; color: #374151;">Text Shadow (Meme Style)</span>
                    </label>
                </div>

                <button onclick="deleteMemeTextBox(${selectedMemeTextBox})" class="btn btn-secondary"
                        style="width: 100%; padding: 10px; color: #dc2626; border: 2px solid #dc2626; background: white; border-radius: 6px; cursor: pointer;">
                    Delete This Text Box
                </button>
            `;
        }

        function updateSelectedMemeTextBox() {
            if (selectedMemeTextBox < 0 || selectedMemeTextBox >= memeTextOverlays.length) return;

            const box = memeTextOverlays[selectedMemeTextBox];
            box.text = document.getElementById('meme-overlay-text')?.value.toUpperCase() || '';
            box.fontFamily = document.getElementById('meme-overlay-font')?.value || 'Impact';
            box.textColor = document.getElementById('meme-overlay-color')?.value || '#FFFFFF';
            box.textShadow = document.getElementById('meme-overlay-shadow')?.checked ?? true;

            renderAllMemeTextBoxes();
        }

        function renderAllMemeTextBoxes() {
            const container = document.getElementById('meme-text-boxes-container');
            if (!container) return;

            container.innerHTML = '';

            memeTextOverlays.forEach((box, boxIdx) => {
                if (!box.text) return;

                const isSelected = boxIdx === selectedMemeTextBox;
                const shadowStyle = box.textShadow
                    ? 'text-shadow: 2px 2px 4px black, -2px -2px 4px black, 2px -2px 4px black, -2px 2px 4px black;'
                    : '';

                const textBoxEl = document.createElement('div');
                textBoxEl.className = 'meme-draggable-text-box';
                textBoxEl.dataset.boxIndex = boxIdx;
                textBoxEl.style.cssText = `
                    position: absolute;
                    top: ${box.y}%;
                    left: ${box.x}%;
                    transform: translate(-50%, -50%);
                    cursor: move;
                    pointer-events: auto;
                    ${isSelected ? 'outline: 3px dashed #018181; outline-offset: 4px;' : ''}
                `;

                textBoxEl.innerHTML = `
                    <div style="display: inline-block; padding: 5px 15px; text-align: center; position: relative;">
                        <p style="color: ${box.textColor}; font-family: '${box.fontFamily}', Impact, sans-serif; font-size: ${box.fontSize}px; font-weight: bold; margin: 0; line-height: 1.2; text-transform: uppercase; ${shadowStyle} white-space: pre-line;">${box.text}</p>
                        ${isSelected ? `
                            <div class="meme-resize-handle meme-resize-br" style="position: absolute; bottom: -8px; right: -8px; width: 16px; height: 16px; background: #018181; border-radius: 50%; cursor: se-resize; border: 2px solid white;"></div>
                            <div class="meme-resize-handle meme-resize-bl" style="position: absolute; bottom: -8px; left: -8px; width: 16px; height: 16px; background: #018181; border-radius: 50%; cursor: sw-resize; border: 2px solid white;"></div>
                            <div class="meme-resize-handle meme-resize-tr" style="position: absolute; top: -8px; right: -8px; width: 16px; height: 16px; background: #018181; border-radius: 50%; cursor: ne-resize; border: 2px solid white;"></div>
                            <div class="meme-resize-handle meme-resize-tl" style="position: absolute; top: -8px; left: -8px; width: 16px; height: 16px; background: #018181; border-radius: 50%; cursor: nw-resize; border: 2px solid white;"></div>
                        ` : ''}
                    </div>
                `;

                container.appendChild(textBoxEl);

                // Setup drag and resize handlers
                setupMemeTextBoxHandlers(textBoxEl, boxIdx);
            });
        }

        function setupMemeTextBoxHandlers(element, boxIndex) {
            const container = document.getElementById('meme-preview-container');
            if (!container) return;

            let isDragging = false;
            let isResizing = false;
            let resizeDirection = '';
            let startX, startY, startLeft, startTop, startFontSize;

            // Click to select
            element.addEventListener('click', (e) => {
                if (!isResizing) {
                    selectMemeTextBox(boxIndex);
                }
            });

            // Drag to move
            element.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('meme-resize-handle')) {
                    // Start resizing
                    isResizing = true;
                    resizeDirection = e.target.classList.contains('meme-resize-br') ? 'br' :
                                     e.target.classList.contains('meme-resize-bl') ? 'bl' :
                                     e.target.classList.contains('meme-resize-tr') ? 'tr' : 'tl';
                    startX = e.clientX;
                    startY = e.clientY;
                    startFontSize = memeTextOverlays[boxIndex].fontSize;
                } else {
                    // Start dragging
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    startLeft = memeTextOverlays[boxIndex].x;
                    startTop = memeTextOverlays[boxIndex].y;
                }
                e.preventDefault();
                e.stopPropagation();
            });

            const handleMouseMove = (e) => {
                if (isDragging) {
                    const rect = container.getBoundingClientRect();
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;

                    let newX = startLeft + (deltaX / rect.width) * 100;
                    let newY = startTop + (deltaY / rect.height) * 100;

                    newX = Math.max(5, Math.min(95, newX));
                    newY = Math.max(5, Math.min(95, newY));

                    memeTextOverlays[boxIndex].x = newX;
                    memeTextOverlays[boxIndex].y = newY;

                    element.style.left = newX + '%';
                    element.style.top = newY + '%';
                } else if (isResizing) {
                    const deltaY = e.clientY - startY;
                    const deltaX = e.clientX - startX;

                    // Calculate resize based on diagonal movement
                    let delta = 0;
                    if (resizeDirection === 'br') delta = (deltaX + deltaY) / 3;
                    else if (resizeDirection === 'bl') delta = (-deltaX + deltaY) / 3;
                    else if (resizeDirection === 'tr') delta = (deltaX - deltaY) / 3;
                    else delta = (-deltaX - deltaY) / 3;

                    const newFontSize = Math.max(16, Math.min(80, startFontSize + delta));
                    memeTextOverlays[boxIndex].fontSize = Math.round(newFontSize);

                    renderAllMemeTextBoxes();
                }
            };

            const handleMouseUp = () => {
                isDragging = false;
                isResizing = false;
            };

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }

        // Legacy function for backwards compatibility
        function updateMemeText() {
            // This function is kept for backwards compatibility
            // The new system uses draggable text boxes
            renderAllMemeTextBoxes();
        }

        // Handle meme upload
        function handleMemeUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageUrl = e.target.result;
                generatedImages.meme = {
                    url: imageUrl,
                    prompt: 'Uploaded custom meme',
                    text_top: '',
                    text_bottom: '',
                    textSize: 32,
                    textColor: '#FFFFFF'
                };

                // Use displayImages() to show with text overlay capability
                displayImages();

                alert('‚úì Meme uploaded successfully! You can add text overlays below.');
            };
            reader.readAsDataURL(file);
        }

        async function searchWebMeme() {
            try {
                // Show loading in preview
                document.getElementById('memePreview').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div class="spinner" style="margin: 0 auto 10px;"></div>
                        <div>Searching web for wedding memes...</div>
                    </div>
                `;

                // Call backend to search for memes via Google Images API or similar
                const response = await fetch(`${API_BASE}/api/search-memes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        month: selectedMonth,
                        query: 'wedding meme funny'
                    })
                });

                const data = await response.json();

                if (data.success && data.images && data.images.length > 0) {
                    // Show first 6 results in a grid
                    const images = data.images.slice(0, 6);
                    document.getElementById('memePreview').innerHTML = `
                        <div style="padding: 15px;">
                            <h4 style="margin: 0 0 10px 0;">Select a meme:</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                ${images.map((img, i) => `
                                    <div onclick="selectSearchedMeme('${img.url.replace(/'/g, "\\'")}', '${img.title.replace(/'/g, "\\'")}', '${img.source || ''}')"
                                         style="cursor: pointer; border: 2px solid #e5e7eb; border-radius: 8px; overflow: hidden; transition: all 0.2s;"
                                         onmouseover="this.style.borderColor='#008181'"
                                         onmouseout="this.style.borderColor='#e5e7eb'">
                                        <img src="${img.thumbnail || img.url}" alt="${img.title}" style="width: 100%; height: 100px; object-fit: cover;" />
                                        <div style="padding: 5px; font-size: 10px; text-align: center; background: white;">${img.title.substring(0, 25)}...</div>
                                    </div>
                                `).join('')}
                            </div>
                            <p style="margin-top: 10px; font-size: 12px; color: #666;">Click an image to select it</p>
                        </div>
                    `;
                } else {
                    document.getElementById('memePreview').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>No memes found. Try generating with AI or uploading your own!</p>
                            <button class="btn-secondary btn" onclick="regenerateImage('meme')" style="margin-top: 10px;">Generate with AI Instead</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error searching memes:', error);
                alert('Failed to search for memes. Please try generating with AI or upload your own.');
            }
        }

        function selectSearchedMeme(url, title, source) {
            generatedImages.meme = {
                url: url,
                prompt: title,
                source: source || 'Web search',
                text_top: '',
                text_bottom: '',
                textSize: 32,
                textColor: '#FFFFFF'
            };

            // Use displayImages() to show with text overlay capability
            displayImages();

            document.getElementById('memePrompt').value = title;

            alert('‚úì Meme selected! You can add text overlays below.');
        }

        async function searchWeddingMemes() {
            try {
                const searchResults = document.getElementById('memeSearchResults');
                const gallery = document.getElementById('memeGallery');

                // Show loading
                searchResults.style.display = 'block';
                gallery.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner" style="margin: 0 auto;"></div><div style="margin-top: 10px;">Searching for wedding memes...</div></div>';

                // Call backend to search for memes
                const response = await fetch(`${API_BASE}/api/search-memes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ month: selectedMonth })
                });

                const data = await response.json();

                if (data.success && data.images && data.images.length > 0) {
                    // Display meme options
                    gallery.innerHTML = data.images.map((img, index) => `
                        <div onclick="selectMemeFromGallery('${img.url.replace(/'/g, "\\'")}', '${img.title.replace(/'/g, "\\'")})" style="cursor: pointer; border: 2px solid #e5e7eb; border-radius: 8px; overflow: hidden; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            <img src="${img.thumbnail || img.url}" alt="${img.title}" style="width: 100%; height: 150px; object-fit: cover;" />
                            <div style="padding: 5px; font-size: 11px; text-align: center; background: white;">${img.title.substring(0, 30)}...</div>
                        </div>
                    `).join('');
                } else {
                    gallery.innerHTML = '<p style="text-align: center; color: #666;">No memes found. Try uploading your own or generating one!</p>';
                }
            } catch (error) {
                console.error('Error searching memes:', error);
                alert('Error searching for memes. Please try again or upload your own.');
            }
        }

        function selectMemeFromGallery(url, title) {
            generatedImages.meme = {
                url: url,
                prompt: `Selected meme: ${title}`,
                text_top: '',
                text_bottom: '',
                textSize: 32,
                textColor: '#FFFFFF'
            };

            // Use displayImages() to show with text overlay capability
            displayImages();

            document.getElementById('memeSearchResults').style.display = 'none';
            showToast('‚úì Meme selected! You can add text overlays.');
        }

        // Toggle HTML code view
        function toggleHTMLView() {
            const codeView = document.getElementById('htmlCodeView');
            const btn = document.getElementById('htmlViewBtn');

            if (codeView.style.display === 'none') {
                // Generate and show HTML
                const html = generateNewsletterHTML();
                document.getElementById('htmlCode').textContent = html;
                codeView.style.display = 'block';
                btn.textContent = 'üëÅÔ∏è Hide HTML Code';
            } else {
                codeView.style.display = 'none';
                btn.textContent = 'üìù View HTML Code';
            }
        }

        // Copy HTML code to clipboard
        function copyHTMLCode() {
            const html = getFinalNewsletterHTML();
            navigator.clipboard.writeText(html).then(() => {
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999;';
                toast.textContent = '‚úì HTML copied to clipboard!';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            }).catch(err => {
                alert('Failed to copy HTML: ' + err);
            });
        }

        // Generate newsletter HTML
        function showNewsletterPreview() {
            try {
                // Get subject line and preheader
                const subjectLine = document.getElementById('finalSubjectLine')?.value || 'Your Monthly Newsletter';
                const preheader = document.getElementById('finalPreheader')?.value || 'Latest insights inside';

                // Generate HTML and populate preview
                console.log('[PREVIEW] Generating newsletter HTML...');
                const html = generateNewsletterHTML();
                console.log('[PREVIEW] HTML generated, length:', html.length);

                // Populate preview
                document.getElementById('newsletterPreview').innerHTML = html;
                document.getElementById('htmlCode').textContent = html;

                // Populate subject and preheader displays
                document.getElementById('previewSubjectLine').textContent = subjectLine;
                document.getElementById('previewPreheader').textContent = preheader;

                // Enable inline editing
                setTimeout(() => {
                    enableNewsletterEditing();
                }, 100);

                showStep(13); // Preview step
            } catch (error) {
                console.error('[PREVIEW ERROR]', error);
                alert('Error generating preview: ' + error.message + '\n\nPlease check browser console for details.');
            }
        }

        // Briteco Newsletter Template Generator (NEW BriteCo Brief Template - Jan 2026)
        // Based on "good" email template with proper table structure, VML fallbacks, borders, and WordPress assets
        function generateBritecoHTML(data) {
            // Extract all content from data object - Agent Newsletter 7-section template
            const {
                preheader = '',
                subjectLine = 'The BriteCo Brief',
                introText = '',
                introCTAUrl = 'https://brite.co/agents',
                introCTAText = 'Learn More',
                briteSpotText = '',
                briteSpotImage = '',
                briteSpotBullets = [],
                claimsText = '',
                claimsImage = '',
                roundupItems = [],
                spotlightSubheader = '',
                spotlightText = '',
                spotlightImage = '',
                spotlightH2s = [],
                tipsImage = '',
                tipsIntro = '',
                tipsItems = [],
                ctaUrl = 'https://brite.co/agents',
                ctaText = 'Partner With Us'
            } = data;

            // WordPress hosted assets - matching Ontraport template
            const assets = {
                logo: 'https://brite.co/wp-content/uploads/2025/09/briteco-logo-1.png',
                logoFooter: 'https://brite.co/wp-content/uploads/2025/09/footer-logo.png',
                heroBg: 'https://brite.co/wp-content/uploads/2025/09/section-1-bg.png',
                briteSpotBanner: 'https://brite.co/wp-content/uploads/2025/09/brite-spot-1.png',
                curiousClaimsBanner: 'https://brite.co/wp-content/uploads/2025/09/cusrious-claims.png',
                newsRoundupBanner: 'https://brite.co/wp-content/uploads/2025/09/news-roundup.png',
                spotlightBanner: 'https://brite.co/wp-content/uploads/2025/09/spotlight.png',
                agentAdvantageBanner: 'https://brite.co/wp-content/uploads/2025/09/agent-advantage.png',
                ctaBg: 'https://brite.co/wp-content/uploads/2025/09/section-bg.png',
                checkmark: 'https://brite.co/wp-content/uploads/2025/09/tickk.png',
                blankImage: 'https://brite.co/wp-content/uploads/2025/09/blank-image.png'
            };

            // Helper to format claims text with proper paragraph spacing
            const formatClaimsText = (text) => {
                if (!text) return '';
                // If text already has <p> tags, ensure they have proper margins
                if (text.includes('<p')) {
                    // Replace existing <p> tags with properly styled ones
                    return text.replace(/<p([^>]*)>/gi, '<p$1 style="margin: 0 0 16px 0; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 15px; line-height: 26px; font-weight: 400; color: #3B3B3B;">');
                }
                // If plain text, split by double newlines and wrap in paragraphs
                const paragraphs = text.split(/\n\n+/).filter(p => p.trim());
                if (paragraphs.length > 1) {
                    return paragraphs.map(p =>
                        `<p style="margin: 0 0 16px 0; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 15px; line-height: 26px; font-weight: 400; color: #3B3B3B;">${p.trim()}</p>`
                    ).join('');
                }
                // Single paragraph
                return `<p style="margin: 0; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 15px; line-height: 26px; font-weight: 400; color: #3B3B3B;">${text}</p>`;
            };

            // Helper to generate bullet items with teal circles
            const generateBulletItems = (items) => {
                if (!items || !Array.isArray(items) || items.length === 0) return '';
                return `<table border="0" cellpadding="0" cellspacing="0" role="presentation" width="100%">
                    <tbody>
                    ${items.map(item => `
                    <tr>
                        <td style="padding-top: 6px;" valign="top" width="20">
                            <table border="0" cellpadding="0" cellspacing="0" role="presentation">
                                <tbody>
                                    <tr>
                                        <td style="width: 10px; height: 10px; background-color: #31D7CA; border-radius: 50%; font-size: 1px; line-height: 1px;">&nbsp;</td>
                                    </tr>
                                </tbody>
                            </table>
                        </td>
                        <td style="padding-bottom: 10px; padding-left: 10px;" valign="top">
                            <p class="dark-text-secondary" style="margin: 0; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 15px; line-height: 24px; font-weight: 400; color: #3B3B3B;">${item}</p>
                        </td>
                    </tr>
                    `).join('')}
                    </tbody>
                </table>`;
            };

            // Helper to generate news roundup items with checkmarks
            const generateRoundupItems = (items) => {
                if (!items || !Array.isArray(items) || items.length === 0) return '';
                return items.map((item, index) => `
                    <tr>
                        <td style="padding-right: 12px; padding-top: 2px;" valign="top" width="32">
                            <img alt="" src="${assets.checkmark}" style="display: block; width: 24px; height: auto;" width="24" />
                        </td>
                        <td style="padding-bottom: ${index === items.length - 1 ? '0' : '16px'};" valign="top">
                            <p class="dark-text-secondary" style="margin: 0; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 15px; line-height: 24px; font-weight: 400; color: #3B3B3B;">${item.summary || item}</p>
                        </td>
                    </tr>
                `).join('');
            };

            // Helper to strip markdown headers (## or ###) from text
            const stripMarkdownHeaders = (text) => {
                if (!text) return '';
                return text.replace(/^#{1,3}\s*/, '').trim();
            };

            // Helper to generate spotlight H2 sections (using H3 content from generated spotlight)
            const generateSpotlightH2s = (h2s) => {
                if (!h2s || !Array.isArray(h2s) || h2s.length === 0) return '';
                return h2s.map(section => `
                    <tr>
                        <td style="padding-top: 20px;">
                            <h3 class="dark-text" style="margin: 0 0 10px 0; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 18px; line-height: 24px; font-weight: 600; color: #282D3E;">${stripMarkdownHeaders(section.h3 || section.title || '')}</h3>
                            <p class="dark-text-secondary" style="margin: 0; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 26px; font-weight: 400; color: #3B3B3B;">${section.body || section.content || ''}</p>
                        </td>
                    </tr>
                `).join('');
            };

            // Helper to generate agent advantage tips with checkmarks and titles
            const generateTipsItems = (items) => {
                if (!items || !Array.isArray(items) || items.length === 0) return '';
                return items.map((item, index) => `
                    <tr>
                        <td style="padding-right: 12px; padding-top: 2px;" valign="top" width="32">
                            <img alt="" src="${assets.checkmark}" style="display: block; width: 24px; height: auto;" width="24" />
                        </td>
                        <td style="padding-bottom: ${index === items.length - 1 ? '0' : '18px'};" valign="top">
                            <p class="dark-text" style="margin: 0 0 4px 0; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 22px; font-weight: 600; color: #008181;">${item.title || ''}</p>
                            <p class="dark-text-secondary" style="margin: 0; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 15px; line-height: 24px; font-weight: 400; color: #3B3B3B;">${item.tip || item.description || item}</p>
                        </td>
                    </tr>
                `).join('');
            };

            // BriteCo Brief Email Template with proper structure, borders, spacers, and VML
            const template = `<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="x-apple-disable-message-reformatting">
<meta name="format-detection" content="telephone=no,address=no,email=no,date=no,url=no">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark">
<title>The BriteCo Brief</title>
<!--[if mso]>
<noscript>
<xml>
<o:OfficeDocumentSettings>
<o:AllowPNG/>
<o:PixelsPerInch>96</o:PixelsPerInch>
</o:OfficeDocumentSettings>
</xml>
</noscript>
<style>
td, th, p, a, li, span { font-family: Arial, Helvetica, sans-serif !important; }
</style>
<![endif]-->
<style>
:root { color-scheme: light dark; supported-color-schemes: light dark; }
html, body { margin: 0 auto !important; padding: 0 !important; height: 100% !important; width: 100% !important; }
* { -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%; }
div[style*="margin: 16px 0"] { margin: 0 !important; }
table, td { mso-table-lspace: 0pt !important; mso-table-rspace: 0pt !important; }
table { border-spacing: 0 !important; border-collapse: collapse !important; table-layout: fixed !important; margin: 0 auto !important; }
img { -ms-interpolation-mode: bicubic; border: 0; height: auto; line-height: 100%; outline: none; text-decoration: none; }
a { text-decoration: none; color: #008181; }
a[x-apple-data-detectors] { color: inherit !important; text-decoration: none !important; font-size: inherit !important; font-family: inherit !important; font-weight: inherit !important; line-height: inherit !important; }
.button-link { transition: all 100ms ease-in; }
.button-link:hover { background-color: #FF9933 !important; }

/* Dark mode styles */
@media (prefers-color-scheme: dark) {
.email-bg { background-color: #1a1a1a !important; }
.section-bg { background-color: #2d2d2d !important; }
.section-border { border-color: #444444 !important; }
.dark-text { color: #ffffff !important; }
.dark-text-secondary { color: #cccccc !important; }
.dark-text-muted { color: #999999 !important; }
}
[data-ogsc] .email-bg { background-color: #1a1a1a !important; }
[data-ogsc] .section-bg { background-color: #2d2d2d !important; }
[data-ogsc] .section-border { border-color: #444444 !important; }
[data-ogsc] .dark-text { color: #ffffff !important; }
[data-ogsc] .dark-text-secondary { color: #cccccc !important; }
[data-ogsc] .dark-text-muted { color: #999999 !important; }

/* Mobile styles */
@media screen and (max-width: 600px) {
.mobile-full { width: 100% !important; max-width: 100% !important; }
.mobile-padding { padding-left: 20px !important; padding-right: 20px !important; }
.mobile-stack { display: block !important; width: 100% !important; max-width: 100% !important; }
.mobile-stack-padding { padding-right: 0 !important; padding-bottom: 15px !important; }
.mobile-center { text-align: center !important; }
.mobile-img-full { width: 100% !important; height: auto !important; max-width: 100% !important; }
.mobile-hide { display: none !important; }
.mobile-spacer { height: 15px !important; }
}
</style>
</head>
<body width="100%" style="margin: 0; padding: 0 !important; mso-line-height-rule: exactly; background-color: #ffffff;" class="email-bg">

<!-- Preheader -->
<div style="display: none; max-height: 0px; overflow: hidden;">${preheader}</div>
<div style="display: none; max-height: 0px; overflow: hidden;">&#847;&zwnj;&nbsp;&#847;&zwnj;&nbsp;&#847;&zwnj;&nbsp;&#847;&zwnj;&nbsp;&#847;&zwnj;&nbsp;&#847;&zwnj;&nbsp;&#847;&zwnj;&nbsp;&#847;&zwnj;&nbsp;</div>

<div role="article" aria-roledescription="email" aria-label="${subjectLine}" lang="en" style="font-size: 16px; font-family: Montserrat, Helvetica, Arial, sans-serif; background-color: #ffffff;">
<!--[if mso | IE]>
<table role="presentation" border="0" cellpadding="0" cellspacing="0" width="100%" style="background-color: #ffffff;">
<tr>
<td align="center">
<![endif]-->

<!-- Outer Container -->
<table align="center" role="presentation" cellspacing="0" cellpadding="0" border="0" width="580" style="margin: 0 auto; max-width: 580px;" class="mobile-full">

<!-- Top Spacer -->
<tr><td style="height: 20px; font-size: 1px; line-height: 1px;">&nbsp;</td></tr>

<!-- HEADER WITH LOGO -->
<tr>
<td style="background-color: #ffffff; padding: 25px 45px; text-align: center; border: 1px solid #282D3E; border-bottom: none;" class="mobile-padding">
<a href="https://brite.co" target="_blank">
<img src="${assets.logo}" width="140" alt="BriteCo" style="width: 140px; max-width: 140px; height: auto; display: block; margin: 0 auto;">
</a>
</td>
</tr>

<!-- HERO SECTION - Light background with geometric pattern -->
<tr>
<td style="border: 1px solid #282D3E; border-top: none;" class="section-border">
<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="background-color: #EDF5F5; background-image: url('${assets.heroBg}'); background-repeat: repeat; background-position: center;">
<tr>
<td style="padding: 50px 45px; text-align: center;" class="mobile-padding">
<h1 style="margin: 0 0 20px 0; font-family: Georgia, serif; font-size: 32px; line-height: 38px; font-weight: 700; color: #008181; font-style: italic;">The BriteCo Brief</h1>
${introText ? `<p style="margin: 0 0 28px 0; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 15px; line-height: 24px; font-weight: 400; color: #555555;">${introText}</p>` : ''}
<!--[if mso]>
<v:roundrect xmlns:v="urn:schemas-microsoft-com:vml" xmlns:w="urn:schemas-microsoft-com:office:word" href="${introCTAUrl}" style="height:46px;v-text-anchor:middle;width:200px;" arcsize="50%" strokecolor="#FE8916" fillcolor="#FE8916">
<w:anchorlock/>
<center style="color:#ffffff;font-family:Arial,sans-serif;font-size:14px;font-weight:bold;">${introCTAText.toUpperCase()}</center>
</v:roundrect>
<![endif]-->
<!--[if !mso]><!-->
<a href="${introCTAUrl}" style="display: inline-block; background-color: #FE8916; color: #ffffff; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 13px; font-weight: 700; padding: 14px 28px; text-decoration: none; border-radius: 25px; text-transform: uppercase; letter-spacing: 0.5px;" class="button-link">${introCTAText}</a>
<!--<![endif]-->
</td>
</tr>
</table>
</td>
</tr>

<!-- 25px Spacer -->
<tr><td style="height: 25px; font-size: 1px; line-height: 1px;" class="mobile-spacer">&nbsp;</td></tr>

<!-- SECTION: BRITE SPOT - Image on RIGHT -->
<tr>
<td style="border: 1px solid #282D3E;" class="section-border">
<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
<!-- Section Banner -->
<tr>
<td>
<img src="${assets.briteSpotBanner}" width="580" alt="The Brite Spot" style="width: 100%; max-width: 580px; height: auto; display: block;" class="mobile-img-full">
</td>
</tr>
<!-- Section Content - Text LEFT, Image RIGHT -->
<tr>
<td style="background-color: #ffffff; padding: 35px 45px;" class="mobile-padding section-bg">
<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
<tr>
<td valign="top" class="mobile-stack" style="padding-right: 25px;">
${briteSpotText ? `<p class="dark-text-secondary" style="margin: 0 0 18px 0; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 15px; line-height: 26px; font-weight: 400; color: #3B3B3B;">${briteSpotText}</p>` : ''}
${generateBulletItems(briteSpotBullets)}
</td>
<td width="180" valign="top" class="mobile-stack">
<img src="${briteSpotImage || assets.blankImage}" width="180" alt="Brite Spot" style="width: 180px; max-width: 180px; height: auto; display: block; border-radius: 4px;" class="mobile-img-full">
</td>
</tr>
</table>
</td>
</tr>
</table>
</td>
</tr>

<!-- 25px Spacer -->
<tr><td style="height: 25px; font-size: 1px; line-height: 1px;" class="mobile-spacer">&nbsp;</td></tr>

<!-- SECTION: CURIOUS CLAIMS - Image on LEFT -->
<tr>
<td style="border: 1px solid #282D3E;" class="section-border">
<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
<!-- Section Banner -->
<tr>
<td>
<img src="${assets.curiousClaimsBanner}" width="580" alt="Curious Claims" style="width: 100%; max-width: 580px; height: auto; display: block;" class="mobile-img-full">
</td>
</tr>
<!-- Section Content - Image LEFT, Text RIGHT -->
<tr>
<td style="background-color: #ffffff; padding: 35px 45px;" class="mobile-padding section-bg">
<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
<tr>
<td width="180" valign="top" class="mobile-stack mobile-stack-padding" style="padding-right: 35px;">
<img src="${claimsImage || assets.blankImage}" width="180" alt="Curious Claims" style="width: 180px; max-width: 180px; height: auto; display: block; border-radius: 4px; margin-bottom: 15px;" class="mobile-img-full">
</td>
<td valign="top" class="mobile-stack">
<div class="dark-text-secondary claims-content" style="font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 15px; line-height: 26px; font-weight: 400; color: #3B3B3B;">${formatClaimsText(claimsText)}</div>
</td>
</tr>
</table>
</td>
</tr>
</table>
</td>
</tr>

<!-- 25px Spacer -->
<tr><td style="height: 25px; font-size: 1px; line-height: 1px;" class="mobile-spacer">&nbsp;</td></tr>

<!-- SECTION: NEWS ROUNDUP -->
<tr>
<td style="border: 1px solid #282D3E;" class="section-border">
<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
<!-- Section Banner -->
<tr>
<td>
<img src="${assets.newsRoundupBanner}" width="580" alt="News Roundup" style="width: 100%; max-width: 580px; height: auto; display: block;" class="mobile-img-full">
</td>
</tr>
<!-- Section Content -->
<tr>
<td style="background-color: #ffffff; padding: 35px 45px;" class="mobile-padding section-bg">
<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
<tbody>
${generateRoundupItems(roundupItems)}
</tbody>
</table>
</td>
</tr>
</table>
</td>
</tr>

<!-- 25px Spacer -->
<tr><td style="height: 25px; font-size: 1px; line-height: 1px;" class="mobile-spacer">&nbsp;</td></tr>

<!-- SECTION: INSURNEWS SPOTLIGHT - Full width image layout -->
<tr>
<td style="border: 1px solid #282D3E;" class="section-border">
<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
<!-- Section Banner -->
<tr>
<td>
<img src="${assets.spotlightBanner}" width="580" alt="InsurNews Spotlight" style="width: 100%; max-width: 580px; height: auto; display: block;" class="mobile-img-full">
</td>
</tr>
<!-- Section Content -->
<tr>
<td style="background-color: #ffffff; padding: 35px 45px;" class="mobile-padding section-bg">
<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
<!-- Subheader/Title -->
${spotlightSubheader ? `
<tr>
<td>
<h3 class="dark-text" style="margin: 0 0 20px 0; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 18px; line-height: 26px; font-weight: 700; color: #282D3E;">${spotlightSubheader}</h3>
</td>
</tr>
` : ''}
<!-- Full-width Image -->
<tr>
<td style="padding-bottom: 25px;">
<img src="${spotlightImage || assets.blankImage}" width="490" alt="Spotlight" style="width: 100%; max-width: 490px; height: auto; display: block; border-radius: 4px;" class="mobile-img-full">
</td>
</tr>
<!-- Full width story content -->
<tr>
<td>
${spotlightText ? `<p class="dark-text-secondary" style="margin: 0 0 20px 0; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 15px; line-height: 26px; font-weight: 400; color: #3B3B3B;">${spotlightText}</p>` : ''}
${spotlightH2s && spotlightH2s.length > 0 ? spotlightH2s.map(section => `
<h3 class="dark-text" style="margin: 20px 0 12px 0; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 18px; line-height: 26px; font-weight: 600; color: #282D3E;">${stripMarkdownHeaders(section.h3 || section.title || '')}</h3>
<p class="dark-text-secondary" style="margin: 0 0 20px 0; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 15px; line-height: 26px; font-weight: 400; color: #3B3B3B;">${section.body || section.content || ''}</p>
`).join('') : ''}
</td>
</tr>
</table>
</td>
</tr>
</table>
</td>
</tr>

<!-- 25px Spacer -->
<tr><td style="height: 25px; font-size: 1px; line-height: 1px;" class="mobile-spacer">&nbsp;</td></tr>

<!-- SECTION: AGENT ADVANTAGE - Two column intro + full width tips -->
<tr>
<td style="border: 1px solid #282D3E;" class="section-border">
<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
<!-- Section Banner -->
<tr>
<td>
<img src="${assets.agentAdvantageBanner}" width="580" alt="Agent Advantage" style="width: 100%; max-width: 580px; height: auto; display: block;" class="mobile-img-full">
</td>
</tr>
<!-- Section Content -->
<tr>
<td style="background-color: #ffffff; padding: 35px 45px;" class="mobile-padding section-bg">
<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
<!-- Two column intro: Text LEFT, Image RIGHT -->
<tr>
<td valign="top" class="mobile-stack" style="padding-right: 25px;">
${tipsIntro ? `<p class="dark-text-secondary" style="margin: 0; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 15px; line-height: 26px; font-weight: 400; color: #3B3B3B;">${tipsIntro}</p>` : ''}
</td>
<td width="180" valign="top" class="mobile-stack mobile-stack-padding">
<img src="${tipsImage || assets.blankImage}" width="180" alt="Agent Advantage" style="width: 180px; max-width: 180px; height: auto; display: block; border-radius: 4px; margin-bottom: 15px;" class="mobile-img-full">
</td>
</tr>
<!-- Tips with checkmarks -->
<tr>
<td colspan="2" style="padding-top: 25px;">
<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
<tbody>
${generateTipsItems(tipsItems)}
</tbody>
</table>
</td>
</tr>
</table>
</td>
</tr>
</table>
</td>
</tr>

<!-- 25px Spacer -->
<tr><td style="height: 25px; font-size: 1px; line-height: 1px;" class="mobile-spacer">&nbsp;</td></tr>

<!-- CTA SECTION - "Wait Before You Go..." with teal background + pattern -->
<tr>
<td align="center" style="border: 1px solid #282D3E;" class="section-border">
<!--[if mso]>
<v:rect xmlns:v="urn:schemas-microsoft-com:vml" fill="true" stroke="false" style="width:580px;">
<v:fill type="tile" src="${assets.ctaBg}" color="#008181"/>
<v:textbox style="mso-fit-shape-to-text:true" inset="0,0,0,0">
<![endif]-->
<div style="background-color: #008181; background-image: url('${assets.ctaBg}'); background-repeat: repeat; background-position: center;">
<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
<tr>
<td style="padding: 45px 45px; text-align: center;" class="mobile-padding">
<h2 style="margin: 0 0 12px 0; font-family: Georgia, serif; font-size: 26px; line-height: 32px; font-weight: 700; color: #ffffff; font-style: italic;">Wait Before You Go...</h2>
<p style="margin: 0 0 24px 0; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 24px; font-weight: 400; color: #ffffff;">Earn 12% recurring commissions on every policy</p>
<!--[if mso]>
<v:roundrect xmlns:v="urn:schemas-microsoft-com:vml" xmlns:w="urn:schemas-microsoft-com:office:word" href="${ctaUrl}" style="height:46px;v-text-anchor:middle;width:200px;" arcsize="50%" strokecolor="#FE8916" fillcolor="#FE8916">
<w:anchorlock/>
<center style="color:#ffffff;font-family:Arial,sans-serif;font-size:13px;font-weight:bold;">${ctaText.toUpperCase()}</center>
</v:roundrect>
<![endif]-->
<!--[if !mso]><!-->
<a href="${ctaUrl}" style="display: inline-block; background-color: #FE8916; color: #ffffff; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 13px; font-weight: 700; padding: 14px 28px; text-decoration: none; border-radius: 25px; text-transform: uppercase; letter-spacing: 0.5px;" class="button-link">${ctaText}</a>
<!--<![endif]-->
</td>
</tr>
</table>
</div>
<!--[if mso]>
</v:textbox>
</v:rect>
<![endif]-->
</td>
</tr>

<!-- 25px Spacer -->
<tr><td style="height: 25px; font-size: 1px; line-height: 1px;" class="mobile-spacer">&nbsp;</td></tr>

<!-- FOOTER - White background -->
<tr>
<td style="background-color: #ffffff; padding: 30px 45px; text-align: center; border: 1px solid #282D3E;" class="mobile-padding">
<a href="https://brite.co" target="_blank">
<img src="${assets.logoFooter}" width="80" alt="BriteCo" style="width: 80px; max-width: 80px; height: auto; display: block; margin: 0 auto 15px auto;">
</a>
<p style="margin: 0 0 10px 0; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 13px; line-height: 20px; font-weight: 400; color: #555555;">
805 Greenwood St Evanston IL 60201
</p>
<p style="margin: 0; font-family: Montserrat, Helvetica, Arial, sans-serif; font-size: 13px; line-height: 20px; font-weight: 400;">
<a href="https://brite.co" style="color: #008181; text-decoration: none;">Brite.Co</a>
</p>
</td>
</tr>

<!-- Bottom Spacer -->
<tr><td style="height: 20px; font-size: 1px; line-height: 1px;">&nbsp;</td></tr>

</table>

<!--[if mso | IE]>
</td>
</tr>
</table>
<![endif]-->
</div>

</body>
</html>
`;

            // Return the template with all values interpolated
            return template;
        }

        // Helper to convert markdown to HTML (links, bold, headers)
        function convertMarkdownLinksToHTML(text) {
            if (!text) return text;
            // Convert markdown headers ## and ### to bold - handle line start
            text = text.replace(/^###\s*(.+)$/gm, '<strong style="font-size: 16px; color: #282D3E;">$1</strong>');
            text = text.replace(/^##\s*(.+)$/gm, '<strong style="font-size: 17px; color: #282D3E;">$1</strong>');
            // Also handle ## after newlines (not just line start)
            text = text.replace(/\n##\s*([^\n]+)/g, '\n<strong style="font-size: 17px; color: #282D3E;">$1</strong>');
            // Handle ## after closing HTML tags like </p>## or >##
            text = text.replace(/>##\s*([^<\n]+)/g, '><strong style="font-size: 17px; color: #282D3E;">$1</strong>');
            // Convert markdown bold **text** to <strong>
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            // Clean up any stray ** that weren't part of a proper pair
            text = text.replace(/\*\*/g, '');
            // Convert [text](url) to <a href="url">text</a>
            return text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #008181; text-decoration: underline;">$1</a>');
        }

        function generateNewsletterHTML() {
            // Get subject line and preheader
            const subjectLine = document.getElementById('finalSubjectLine')?.value || 'The BriteCo Brief';
            const preheader = document.getElementById('finalPreheader')?.value || 'Your monthly P&C insurance insights';

            // Get introduction content from Newsletter Header Intro (page 1 box 1)
            // Try: 1) Step 5 editable box, 2) saved headerIntroContent, 3) page 1 input
            const introText = document.getElementById('headerIntroContentBox')?.innerText
                || headerIntroContent
                || document.getElementById('headerIntroInput')?.value?.trim()
                || '';

            // Get Brite Spot content (paragraph + bullets from Step 1)
            // Try to get from Step 1 inputs first, then fall back to contenteditable box or generated content
            let briteSpotTextForTemplate = briteSpotContent || '';
            let briteSpotBulletsForTemplate = briteSpotBullets || [];

            // If no Step 1 content, try contenteditable box (may have been edited)
            if (!briteSpotTextForTemplate) {
                const contentBoxHtml = document.getElementById('briteSpotContentBox')?.innerHTML || generatedBriteSpotContent || '';
                // Extract paragraph from HTML if needed
                if (contentBoxHtml.includes('<p')) {
                    const match = contentBoxHtml.match(/<p[^>]*>([\s\S]*?)<\/p>/);
                    if (match) briteSpotTextForTemplate = match[1];
                } else {
                    briteSpotTextForTemplate = contentBoxHtml.replace(/<\/?[^>]+(>|$)/g, '');
                }
            }

            // Get claims content
            const claimsText = document.getElementById('claimsContentBox')?.innerHTML || generatedClaimsContent || '';

            // Get roundup content - array of news items
            let roundupItems = [];
            if (Array.isArray(generatedRoundupContent)) {
                roundupItems = generatedRoundupContent.map(item => ({
                    summary: typeof item === 'string' ? item : (item.summary || item.headline || item.text || '')
                }));
            }

            // Get spotlight content - with subheader and h3s structure
            const spotlightSubheader = generatedSpotlightSubheader || '';
            let spotlightText = '';
            let spotlightH2s = [];

            // Handle spotlight structured content { subheader, h3s: [...] }
            if (generatedSpotlightContent && typeof generatedSpotlightContent === 'object') {
                if (generatedSpotlightContent.h3s && Array.isArray(generatedSpotlightContent.h3s)) {
                    spotlightH2s = generatedSpotlightContent.h3s;
                }
                if (generatedSpotlightContent.body) {
                    spotlightText = generatedSpotlightContent.body;
                }
            } else {
                spotlightText = document.getElementById('spotlightContentBox')?.innerHTML || generatedSpotlightContent || '';
            }

            // Get tips content - array of tips with titles
            let tipsIntro = '';
            let tipsItems = [];

            if (generatedTipsContent) {
                if (generatedTipsContent.intro) {
                    tipsIntro = generatedTipsContent.intro;
                }
                if (generatedTipsContent.tips && Array.isArray(generatedTipsContent.tips)) {
                    tipsItems = generatedTipsContent.tips.map(tip => ({
                        title: tip.title || '',
                        tip: tip.tip || tip.description || (typeof tip === 'string' ? tip : '')
                    }));
                } else if (Array.isArray(generatedTipsContent)) {
                    tipsItems = generatedTipsContent.map(tip => ({
                        title: tip.title || '',
                        tip: tip.tip || tip.description || (typeof tip === 'string' ? tip : '')
                    }));
                }
            }

            // Build data object for template - convert markdown links to HTML
            const data = {
                preheader,
                subjectLine,
                introText: convertMarkdownLinksToHTML(introText),
                introCTAUrl: 'https://brite.co/agents',
                introCTAText: 'Learn More',
                briteSpotText: convertMarkdownLinksToHTML(briteSpotTextForTemplate),
                briteSpotImage: generatedImages.briteSpot?.url || '',
                briteSpotBullets: briteSpotBulletsForTemplate.map(b => convertMarkdownLinksToHTML(b)),
                claimsText: convertMarkdownLinksToHTML(claimsText),
                claimsImage: generatedImages.claims?.url || '',
                roundupItems: roundupItems.map(item => ({
                    summary: convertMarkdownLinksToHTML(item.summary)
                })),
                spotlightSubheader,
                spotlightText: convertMarkdownLinksToHTML(spotlightText),
                spotlightImage: generatedImages.spotlight?.url || '',
                spotlightH2s: spotlightH2s.map(h2 => ({
                    ...h2,
                    body: convertMarkdownLinksToHTML(h2.body || h2.content || '')
                })),
                tipsImage: generatedImages.tips?.url || '',
                tipsIntro: convertMarkdownLinksToHTML(tipsIntro),
                tipsItems: tipsItems.map(tip => ({
                    title: tip.title,
                    tip: convertMarkdownLinksToHTML(tip.tip)
                })),
                ctaUrl: 'https://brite.co/agents',
                ctaText: 'Partner With Us'
            };

            // Call template function with data object
            return generateBritecoHTML(data);
        }

        // Send test email
        async function sendTestEmail() {
            const testEmail = document.getElementById('testEmail').value.trim();

            if (!testEmail) {
                alert('Please enter a test email address');
                return;
            }

            if (!testEmail.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }

            try {
                const html = generateNewsletterHTML();

                const response = await fetch(`${API_BASE}/api/send-test-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: testEmail,
                        html: html
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úì Test email sent successfully to ' + testEmail);
                } else {
                    alert('Error sending test email: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error sending test email: ' + error.message);
            }
        }

        // Push to Ontraport
        async function pushToOntraport(event) {
            const subject = document.getElementById('subject').value.trim();

            if (!subject) {
                alert('‚ö†Ô∏è Please enter a subject line before pushing to Ontraport');
                return;
            }

            // Show loading state
            const originalButton = event.target;
            const originalText = originalButton.innerHTML;
            originalButton.innerHTML = '‚è≥ Pushing to Ontraport...';
            originalButton.disabled = true;

            try {
                console.log('[ONTRAPORT] Getting final newsletter HTML...');
                const html = getFinalNewsletterHTML();

                console.log('[ONTRAPORT] Sending to backend...');
                const response = await fetch(`${API_BASE}/api/push-to-ontraport`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        html: html,
                        subject: subject,
                        month: selectedMonth
                    })
                });

                const data = await response.json();
                console.log('[ONTRAPORT] Response:', data);

                if (data.success) {
                    // Simple success message
                    alert('‚úÖ Successfully pushed to Ontraport!');
                    console.log('‚úÖ Ontraport campaign created:', data);
                } else {
                    alert('‚ùå Error pushing to Ontraport:\n\n' + (data.error || 'Unknown error'));
                    console.error('‚ùå Ontraport error:', data);
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('‚ùå Error pushing to Ontraport:\n\n' + error.message);
            } finally {
                // Restore button state
                originalButton.innerHTML = originalText;
                originalButton.disabled = false;
            }
        }

        function showPreview() {
            // Build the complete newsletter HTML
            const newsContent = document.getElementById('newsContentBox')?.innerHTML || '';
            const tipContent = document.getElementById('tipContentBox')?.innerHTML || '';
            const trendContent = document.getElementById('trendContentBox')?.innerHTML || '';

            let html = `
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto;">
                    <!-- Meme with text overlay -->
                    ${generatedImages.meme ? `
                        <div style="margin-bottom: 30px; text-align: center; position: relative; display: inline-block; width: 100%;">
                            <div style="position: relative; display: inline-block; max-width: 100%;">
                                <img src="${generatedImages.meme.url}" alt="Monthly Meme" style="max-width: 100%; border-radius: 8px; display: block;" />
                                ${generatedImages.meme.text_top ? `<div style="position: absolute; top: 20px; left: 0; right: 0; text-align: center; color: ${generatedImages.meme.textColor || '#FFFFFF'}; font-family: Impact, Arial Black, sans-serif; font-size: ${generatedImages.meme.textSize || 32}px; font-weight: bold; text-transform: uppercase; text-shadow: 2px 2px 4px black, -2px -2px 4px black, 2px -2px 4px black, -2px 2px 4px black; padding: 0 10px; line-height: 1.2;">${generatedImages.meme.text_top}</div>` : ''}
                                ${generatedImages.meme.text_bottom ? `<div style="position: absolute; bottom: 20px; left: 0; right: 0; text-align: center; color: ${generatedImages.meme.textColor || '#FFFFFF'}; font-family: Impact, Arial Black, sans-serif; font-size: ${generatedImages.meme.textSize || 32}px; font-weight: bold; text-transform: uppercase; text-shadow: 2px 2px 4px black, -2px -2px 4px black, 2px -2px 4px black, -2px 2px 4px black; padding: 0 10px; line-height: 1.2;">${generatedImages.meme.text_bottom}</div>` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <!-- News Section -->
                    <div style="margin-bottom: 30px;">
                        <h2 style="color: #1a1a1a; margin-bottom: 15px;">üì∞ News You Can Use</h2>
                        ${generatedImages.news ? `
                            <img src="${generatedImages.news.url}" alt="News Image" style="max-width: 100%; border-radius: 8px; margin-bottom: 15px;" />
                        ` : ''}
                        <div style="background: #f9fafb; padding: 20px; border-radius: 8px;">
                            ${newsContent}
                        </div>
                    </div>

                    <!-- Tip Section -->
                    <div style="margin-bottom: 30px;">
                        <h2 style="color: #1a1a1a; margin-bottom: 15px;">üí° Tip of the Month</h2>
                        ${generatedImages.tip ? `
                            <img src="${generatedImages.tip.url}" alt="Tip Image" style="max-width: 100%; border-radius: 8px; margin-bottom: 15px;" />
                        ` : ''}
                        <div style="background: #f9fafb; padding: 20px; border-radius: 8px;">
                            ${tipContent}
                        </div>
                    </div>

                    <!-- Trend Section -->
                    <div style="margin-bottom: 30px;">
                        <h2 style="color: #1a1a1a; margin-bottom: 15px;">üìà Trend Watch</h2>
                        ${generatedImages.trend ? `
                            <img src="${generatedImages.trend.url}" alt="Trend Image" style="max-width: 100%; border-radius: 8px; margin-bottom: 15px;" />
                        ` : ''}
                        <div style="background: #f9fafb; padding: 20px; border-radius: 8px;">
                            ${trendContent}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('newsletterPreview').innerHTML = html;
            showStep(13); // Preview step
        }

        // Save edited subject line back to state
        function saveSubjectEdit(element) {
            const newSubject = element.textContent.trim();
            if (newSubject && newSubject !== 'Your subject line will appear here') {
                document.getElementById('finalSubjectLine').value = newSubject;
                console.log('[EDIT] Subject line updated:', newSubject);
            }
        }

        // Save edited preheader back to state
        function savePreheaderEdit(element) {
            const newPreheader = element.textContent.trim();
            if (newPreheader && newPreheader !== 'Your preheader will appear here') {
                document.getElementById('finalPreheader').value = newPreheader;
                console.log('[EDIT] Preheader updated:', newPreheader);
            }
        }

        // Make newsletter content editable after it's rendered
        function enableNewsletterEditing() {
            // Add contenteditable to text elements in the preview
            const preview = document.getElementById('newsletterPreview');
            if (!preview) return;

            // Make all paragraph and div text content editable
            const textElements = preview.querySelectorAll('p, div[style*="font-size"]');
            textElements.forEach(el => {
                // Skip elements that are just containers
                if (el.children.length > 0 && el.textContent.trim().length < 50) return;

                el.setAttribute('contenteditable', 'true');
                el.style.cursor = 'text';
                el.style.transition = 'background-color 0.2s';

                // Visual feedback on focus
                el.addEventListener('focus', () => {
                    el.style.backgroundColor = '#fef3c7';
                    el.style.outline = '2px solid #f59e0b';
                });

                el.addEventListener('blur', () => {
                    el.style.backgroundColor = '';
                    el.style.outline = '';

                    // Save changes back by regenerating HTML
                    console.log('[EDIT] Content updated, regenerating HTML...');
                    updateNewsletterHTML();
                });
            });

            console.log('[EDIT] Enabled editing on', textElements.length, 'elements');
        }

        // Global variable to store edited HTML
        let savedEditedHTML = null;

        // Update the stored HTML after edits
        function updateNewsletterHTML() {
            const preview = document.getElementById('newsletterPreview');
            if (!preview) return;

            const updatedHTML = preview.innerHTML;
            document.getElementById('htmlCode').textContent = updatedHTML;
            savedEditedHTML = updatedHTML;

            console.log('[EDIT] HTML updated with edited content');
        }

        // Save preview edits (called by Save Changes button)
        function savePreviewEdits() {
            const preview = document.getElementById('newsletterPreview');
            if (!preview) {
                alert('No preview to save!');
                return;
            }

            // Store the edited HTML
            savedEditedHTML = preview.innerHTML;
            document.getElementById('htmlCode').textContent = savedEditedHTML;

            // Show success indicator
            const status = document.getElementById('saveStatus');
            status.style.display = 'inline';
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);

            console.log('[SAVE] Preview edits saved to HTML, length:', savedEditedHTML.length);
        }

        // Get the final HTML (edited or generated)
        function getFinalNewsletterHTML() {
            if (savedEditedHTML) {
                console.log('[HTML] Using saved edited HTML');
                return savedEditedHTML;
            }
            console.log('[HTML] No edits saved, generating fresh HTML');
            return generateNewsletterHTML();
        }

        async function sendTestEmail() {
            const email = prompt('Enter email address for test:');
            if (!email) return;

            try {
                const newsletterHTML = document.getElementById('newsletterPreview').innerHTML;

                const response = await fetch(`${API_BASE}/api/send-test-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        html: newsletterHTML,
                        month: selectedMonth
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`Test email sent to ${email}!\n\nNote: ${data.note || 'Email sent successfully'}`);
                } else {
                    alert('Error sending test email: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error sending test email: ' + error.message);
            }
        }

        function refreshNews() {
            searchTopics();
        }

        function refreshTips() {
            loadTips();
        }

        function refreshTrends() {
            loadTrends();
        }

        function addCustomNews() {
            const url = document.getElementById('newsUrlInput').value.trim();
            const title = document.getElementById('newsTitleInput').value.trim();
            const description = document.getElementById('newsDescInput').value.trim();

            if (!url || !title || !description) {
                alert('Please fill in all fields (URL, title, and description)');
                return;
            }

            // Create custom article object
            const customArticle = {
                title: title,
                description: description,
                source_url: url
            };

            // Add to newsTopics array and display
            newsTopics.unshift(customArticle);
            displayNews();

            // Clear inputs
            document.getElementById('newsUrlInput').value = '';
            document.getElementById('newsTitleInput').value = '';
            document.getElementById('newsDescInput').value = '';

            // Show success message
            alert('‚úì Custom article added! Select it from the list above.');
        }

        function addCustomTip() {
            const url = document.getElementById('tipUrlInput').value.trim();
            const title = document.getElementById('tipTitleInput').value.trim();
            const description = document.getElementById('tipDescInput').value.trim();

            if (!url || !title || !description) {
                alert('Please fill in all fields (URL, title, and description)');
                return;
            }

            // Create custom tip object
            const customTip = {
                title: title,
                description: description,
                source_url: url
            };

            // Add to tipTopics array and display
            tipTopics.unshift(customTip);
            displayTips();

            // Clear inputs
            document.getElementById('tipUrlInput').value = '';
            document.getElementById('tipTitleInput').value = '';
            document.getElementById('tipDescInput').value = '';

            // Show success message
            alert('‚úì Custom tip added! Select it from the list above.');
        }

        function addCustomTrend() {
            const url = document.getElementById('trendUrlInput').value.trim();
            const title = document.getElementById('trendTitleInput').value.trim();
            const description = document.getElementById('trendDescInput').value.trim();

            if (!url || !title || !description) {
                alert('Please fill in all fields (URL, title, and description)');
                return;
            }

            // Create custom trend object
            const customTrend = {
                title: title,
                description: description,
                source_url: url,
                season: selectedSeason
            };

            // Add to trendTopics array and display
            trendTopics.unshift(customTrend);
            displayTrends();

            // Clear inputs
            document.getElementById('trendUrlInput').value = '';
            document.getElementById('trendTitleInput').value = '';
            document.getElementById('trendDescInput').value = '';

            // Show success message
            alert('‚úì Custom trend added! Select it from the list above.');
        }

        // Wrapper to generate with selected tone
        function generateWithSelectedTone() {
            const tone = document.getElementById('subjectLineTone').value;
            document.getElementById('toneSelection').style.display = 'none';
            generateSubjectLineOptions(tone);
        }

        // Wrapper to regenerate with new tone
        function regenerateSubjectLines() {
            const tone = document.getElementById('regenerateTone').value;
            generateSubjectLineOptions(tone);
        }

        // Generate subject line and preheader options using Claude
        async function generateSubjectLineOptions(tone = 'professional') {
            try {
                document.getElementById('subjectLineLoading').style.display = 'block';
                document.getElementById('subjectLineOptions').style.display = 'none';

                // Gather all newsletter content using correct variable names
                const newsletterContent = {
                    month: selectedMonth,
                    claims: {
                        title: selectedClaims?.title || 'Curious Claims',
                        content: generatedClaimsContent || ''
                    },
                    spotlight: {
                        title: generatedSpotlightSubheader || 'Industry Spotlight',
                        content: generatedSpotlightContent || ''
                    },
                    tips: {
                        title: 'Agent Advantage',
                        content: generatedTipsContent || ''
                    }
                };

                // Call API to generate options with tone
                const response = await fetch(`${API_BASE}/api/generate-subject-options`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: newsletterContent,
                        tone: tone
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    alert('Error generating options: ' + (data.error || 'Unknown error'));
                    return;
                }

                // Display subject line options
                const subjectContainer = document.getElementById('subjectOptions');
                subjectContainer.innerHTML = '';
                data.subject_lines.forEach((subject, index) => {
                    const option = document.createElement('div');
                    option.className = 'topic-card';
                    option.style.cursor = 'pointer';
                    option.innerHTML = `<div class="title">${index + 1}. ${subject}</div>`;
                    option.onclick = () => {
                        document.getElementById('finalSubjectLine').value = subject;
                        document.querySelectorAll('#subjectOptions .topic-card').forEach(card => card.classList.remove('selected'));
                        option.classList.add('selected');
                    };
                    subjectContainer.appendChild(option);
                });

                // Display preheader options
                const preheaderContainer = document.getElementById('preheaderOptions');
                preheaderContainer.innerHTML = '';
                data.preheaders.forEach((preheader, index) => {
                    const option = document.createElement('div');
                    option.className = 'topic-card';
                    option.style.cursor = 'pointer';
                    option.innerHTML = `<div class="title">${index + 1}. ${preheader}</div>`;
                    option.onclick = () => {
                        document.getElementById('finalPreheader').value = preheader;
                        document.querySelectorAll('#preheaderOptions .topic-card').forEach(card => card.classList.remove('selected'));
                        option.classList.add('selected');
                    };
                    preheaderContainer.appendChild(option);
                });

                // Auto-select first options
                document.getElementById('finalSubjectLine').value = data.subject_lines[0];
                document.getElementById('finalPreheader').value = data.preheaders[0];

                // Show options
                document.getElementById('subjectLineLoading').style.display = 'none';
                document.getElementById('subjectLineOptions').style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                alert('Error generating options: ' + error.message);
            }
        }

        // =============================================================================
        // NEW 4-CARD RESEARCH DASHBOARD FUNCTIONS
        // =============================================================================

        function showResearchDashboard() {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            document.getElementById('step2-research').classList.add('active');
            updateProgress(2);
            // Initialize progress tracker
            updateSelectionProgress();
        }

        async function searchPerplexity() {
            const query = document.getElementById('perplexityQuery').value;
            const timeWindow = document.getElementById('perplexityTimeWindow').value;
            const resultsDiv = document.getElementById('perplexityResults');
            const currentTab = currentResearchSection;

            resultsDiv.innerHTML = '<div class="research-card-loading"><div class="spinner"></div><p>Searching with Perplexity AI & analyzing with GPT-5.2...</p></div>';

            try {
                const response = await fetch(`${API_BASE}/api/v2/search-perplexity`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, time_window: timeWindow, exclude_urls: [] })
                });
                const data = await response.json();

                if (data.success && data.results.length > 0) {
                    researchResults.perplexity = data.results;
                    // Store results for this specific tab
                    tabSearchState[currentTab].results.perplexity = data.results;

                    // Show queries header then three-section results
                    resultsDiv.innerHTML = '';
                    if (data.queries_used && data.queries_used.length > 0) {
                        const headerDiv = document.createElement('div');
                        headerDiv.style.cssText = 'font-size: 11px; color: #666; background: #f5f5f5; padding: 8px; margin-bottom: 10px; border-radius: 4px;';
                        headerDiv.innerHTML = `<strong>Queries:</strong> ${data.queries_used.join(' | ')}`;
                        resultsDiv.appendChild(headerDiv);
                    }
                    displayThreeSectionResults(data.results, resultsDiv, 'perplexity');
                    updateAllResults();

                    // Cache the HTML for this tab
                    tabSearchState[currentTab].htmlCache.perplexity = resultsDiv.innerHTML;
                } else {
                    const errorMsg = data.error || 'No results found. Try a different query.';
                    let html = '';
                    if (data.queries_used && data.queries_used.length > 0) {
                        html += `<div class="queries-used" style="font-size: 11px; color: #666; background: #f5f5f5; padding: 8px; margin-bottom: 10px; border-radius: 4px;">
                            <strong>Queries tried:</strong><br>${data.queries_used.join('<br>')}
                        </div>`;
                    }
                    html += `<p style="text-align: center; color: #999; padding: 20px;">${errorMsg}</p>`;
                    resultsDiv.innerHTML = html;
                }
            } catch (error) {
                console.error('Perplexity search error:', error);
                resultsDiv.innerHTML = `<p style="color: #c00; padding: 20px;">Error: ${error.message}</p>`;
            }
        }

        async function searchInsights() {
            const timeWindow = document.getElementById('insightTimeWindow').value;
            const resultsDiv = document.getElementById('insightResults');
            const currentTab = currentResearchSection;

            resultsDiv.innerHTML = '<div class="research-card-loading"><div class="spinner"></div><p>Analyzing all 8 market signals...</p></div>';

            try {
                const response = await fetch(`${API_BASE}/api/v2/search-insights`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ time_window: timeWindow, exclude_urls: [] })
                });
                const data = await response.json();

                if (data.success && data.results.length > 0) {
                    researchResults.insight = data.results;
                    // Store results for this specific tab
                    tabSearchState[currentTab].results.insight = data.results;

                    // Display with impact badges
                    displayInsightResults(data.results, resultsDiv, data.signals_searched);
                    updateAllResults();

                    // Cache the HTML for this tab
                    tabSearchState[currentTab].htmlCache.insight = resultsDiv.innerHTML;
                } else {
                    let msg = '<p style="text-align: center; color: #999; padding: 20px;">No insights found. Try again later.</p>';
                    if (data.signals_searched) {
                        msg = `<div style="font-size: 11px; color: #666; background: #f5f5f5; padding: 8px; margin-bottom: 10px; border-radius: 4px;"><strong>Signals searched:</strong> ${data.signals_searched.join(', ')}</div>` + msg;
                    }
                    resultsDiv.innerHTML = msg;
                }
            } catch (error) {
                console.error('Insight search error:', error);
                resultsDiv.innerHTML = `<p style="color: #c00; padding: 20px;">Error: ${error.message}</p>`;
            }
        }

        async function searchSources() {
            const query = document.getElementById('explorerQuery').value;
            const packCheckboxes = document.querySelectorAll('.explorerPack:checked');
            const sourcePacks = Array.from(packCheckboxes).map(cb => cb.value);
            const timeFrame = document.getElementById('explorerTimeFrame')?.value || '30d';
            const resultsDiv = document.getElementById('explorerResults');
            const currentTab = currentResearchSection;

            if (sourcePacks.length === 0) {
                resultsDiv.innerHTML = '<p style="color: #c00; padding: 20px;">Please select at least one source pack.</p>';
                return;
            }

            resultsDiv.innerHTML = '<div class="research-card-loading"><div class="spinner"></div><p>Searching sources & analyzing story angles...</p></div>';

            try {
                const response = await fetch(`${API_BASE}/api/v2/search-sources`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, source_packs: sourcePacks, time_window: timeFrame, exclude_urls: [] })
                });
                const data = await response.json();

                if (data.success && data.results.length > 0) {
                    researchResults.explorer = data.results;
                    // Store results for this specific tab
                    tabSearchState[currentTab].results.explorer = data.results;

                    displayExplorerResults(data.results, resultsDiv, data.queries_used);
                    updateAllResults();

                    // Cache the HTML for this tab
                    tabSearchState[currentTab].htmlCache.explorer = resultsDiv.innerHTML;
                } else {
                    let msg = '<p style="text-align: center; color: #999; padding: 20px;">No results found. Try different sources or keywords.</p>';
                    if (data.queries_used) {
                        msg = `<div style="font-size: 11px; color: #666; background: #f5f5f5; padding: 8px; margin-bottom: 10px; border-radius: 4px;"><strong>Queries tried:</strong><br>${data.queries_used.join('<br>')}</div>` + msg;
                    }
                    resultsDiv.innerHTML = msg;
                }
            } catch (error) {
                console.error('Source explorer error:', error);
                resultsDiv.innerHTML = `<p style="color: #c00; padding: 20px;">Error: ${error.message}</p>`;
            }
        }

        function displayInsightResults(results, container, signalsSearched = []) {
            container.innerHTML = '';

            // Show signals searched header
            if (signalsSearched && signalsSearched.length > 0) {
                const headerDiv = document.createElement('div');
                headerDiv.style.cssText = 'font-size: 11px; color: #666; background: #f5f5f5; padding: 8px; margin-bottom: 10px; border-radius: 4px;';
                headerDiv.innerHTML = `<strong>Analyzed:</strong> ${signalsSearched.map(s => s.replace('_', ' ')).join(', ')}`;
                container.appendChild(headerDiv);
            }

            // Use shared three-section display
            displayThreeSectionResults(results, container, 'insight');
        }

        // Display perplexity results - wrapper for re-rendering after adding custom links
        function displayPerplexityResults(results, container) {
            if (!container) return;
            container.innerHTML = '';
            displayThreeSectionResults(results, container, 'perplexity');
            // Update cache for current tab
            if (currentResearchSection && tabSearchState[currentResearchSection]) {
                tabSearchState[currentResearchSection].htmlCache.perplexity = container.innerHTML;
            }
        }

        // Shared display function for three-section card layout (used by Insight Builder and Perplexity)
        function displayThreeSectionResults(results, container, cardType) {
            // Impact badge colors
            const impactColors = {
                'HIGH': { bg: '#fee2e2', border: '#ef4444', text: '#b91c1c' },
                'MEDIUM': { bg: '#fef3c7', border: '#f59e0b', text: '#92400e' },
                'LOW': { bg: '#e5e7eb', border: '#9ca3af', text: '#4b5563' }
            };

            // Store results for selection
            researchResults[cardType] = results;
            updateAllResults();

            results.forEach((result, index) => {
                const impact = result.impact || 'MEDIUM';
                const colors = impactColors[impact] || impactColors['MEDIUM'];

                // Signal tags for insight builder
                const signalTags = (result.signals || []).map(s =>
                    `<span style="background: #e0e7ff; color: #3730a3; padding: 2px 6px; border-radius: 3px; font-size: 9px; margin-right: 3px;">${s.replace('_', ' ')}</span>`
                ).join('');

                // Extract the three sections
                const headline = result.headline || result.title || 'Untitled';
                const industryData = result.industry_data || result.snippet || result.description || '';
                const soWhat = result.so_what || result.agent_implications || '';

                const item = document.createElement('div');
                item.className = 'research-result-item';
                item.dataset.cardType = cardType;
                item.dataset.index = index;
                item.dataset.url = result.url || '';
                item.style.cssText = 'padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; background: #fff; cursor: pointer; position: relative;';
                item.innerHTML = `
                    <!-- Selection checkbox indicator -->
                    <div class="selection-indicator" style="position: absolute; top: 8px; right: 8px; width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; background: white; transition: all 0.2s;">
                        <svg class="check-icon" style="display: none; width: 14px; height: 14px; color: white;" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>

                    <!-- Header: Impact badge, signal tags, publisher, link -->
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px; flex-wrap: wrap; padding-right: 28px;">
                        <span style="background: ${colors.bg}; border: 1px solid ${colors.border}; color: ${colors.text}; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: bold;">${impact}</span>
                        ${signalTags}
                        <span style="margin-left: auto; font-size: 10px; color: #64748b;">${result.publisher || ''}</span>
                        ${result.url ? `<a href="${result.url}" target="_blank" style="font-size: 10px; color: #3b82f6; text-decoration: none; margin-left: 6px;" onclick="event.stopPropagation()">Source ‚Üí</a>` : ''}
                    </div>

                    <!-- Section 1: Headline -->
                    <div style="font-size: 13px; font-weight: 600; color: #1a1a1a; line-height: 1.3; margin-bottom: 8px;">
                        ${headline}
                    </div>

                    <!-- Section 2: Industry Data -->
                    ${industryData ? `
                    <div style="background: #f8fafc; border-left: 3px solid #3b82f6; padding: 6px 10px; margin-bottom: 8px; border-radius: 0 4px 4px 0;">
                        <div style="font-size: 9px; text-transform: uppercase; color: #64748b; font-weight: 600; margin-bottom: 2px;">Key Data</div>
                        <div style="font-size: 11px; color: #334155; line-height: 1.4;">${industryData}</div>
                    </div>
                    ` : ''}

                    <!-- Section 3: Why It Matters / So What -->
                    ${soWhat ? `
                    <div style="background: #f0fdf4; border-left: 3px solid #22c55e; padding: 6px 10px; border-radius: 0 4px 4px 0;">
                        <div style="font-size: 9px; text-transform: uppercase; color: #15803d; font-weight: 600; margin-bottom: 2px;">Action</div>
                        <div style="font-size: 11px; color: #166534; line-height: 1.4;">${soWhat}</div>
                    </div>
                    ` : ''}
                `;

                // Add click handler for selection
                item.onclick = () => selectResearchResult(cardType, index, item, result);
                container.appendChild(item);
            });
        }

        // Upload Link Modal Functions for Research Dashboard
        let addedCustomLinks = [];  // Track links added in current modal session

        // Map section keys to display names
        const sectionDisplayNames = {
            'claims': 'Curious Claims',
            'roundup': 'News Roundup',
            'spotlight': 'InsurNews Spotlight',
            'tips': 'Agent Advantage'
        };

        function showUploadLinkModal() {
            document.getElementById('uploadLinkModal').style.display = 'flex';
            document.getElementById('customLinkInput').value = '';
            document.getElementById('uploadLinkError').style.display = 'none';
            document.getElementById('addedLinksList').style.display = 'none';
            document.getElementById('addedLinksContainer').innerHTML = '';
            document.getElementById('addAnotherLinkSection').style.display = 'none';
            addedCustomLinks = [];

            // Update modal title with current section name
            const sectionName = sectionDisplayNames[currentResearchSection] || 'This Section';
            document.getElementById('modalSectionName').textContent = sectionName;

            document.getElementById('customLinkInput').focus();
        }

        function hideUploadLinkModal() {
            document.getElementById('uploadLinkModal').style.display = 'none';
            addedCustomLinks = [];
        }

        function updateAddedLinksList(title, url, linkIndex) {
            const listDiv = document.getElementById('addedLinksList');
            const container = document.getElementById('addedLinksContainer');
            listDiv.style.display = 'block';

            const linkItem = document.createElement('div');
            linkItem.id = `addedLink_${linkIndex}`;
            linkItem.style.cssText = 'padding: 6px 8px; margin-bottom: 4px; background: white; border-radius: 4px; font-size: 12px; display: flex; justify-content: space-between; align-items: center;';
            linkItem.innerHTML = `
                <span style="color: #374151; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 350px;" title="${url}">${title || url}</span>
                <button onclick="removeAddedLink(${linkIndex}, '${url}')" style="background: none; border: none; color: #dc2626; cursor: pointer; font-size: 16px; padding: 0 4px; line-height: 1;" title="Remove this link">&times;</button>
            `;
            container.appendChild(linkItem);
            addedCustomLinks.push({ title, url, index: linkIndex });

            // Show "Add another link" section after first link is added
            document.getElementById('addAnotherLinkSection').style.display = 'block';
        }

        function removeAddedLink(linkIndex, url) {
            // Remove from DOM
            const linkItem = document.getElementById(`addedLink_${linkIndex}`);
            if (linkItem) linkItem.remove();

            // Remove from addedCustomLinks array
            addedCustomLinks = addedCustomLinks.filter(link => link.index !== linkIndex);

            // Remove from researchResults.perplexity
            if (researchResults.perplexity) {
                researchResults.perplexity = researchResults.perplexity.filter(article => article.url !== url);
                // Re-render results
                const container = document.getElementById('perplexityResults');
                displayPerplexityResults(researchResults.perplexity, container);
            }

            // Hide the list if no more links
            if (addedCustomLinks.length === 0) {
                document.getElementById('addedLinksList').style.display = 'none';
                document.getElementById('addAnotherLinkSection').style.display = 'none';
            }
        }

        // Counter for unique link IDs
        let customLinkCounter = 0;

        // Update the Research Dashboard custom links indicator
        function updateResearchCustomLinksIndicator() {
            const indicator = document.getElementById('researchCustomLinksIndicator');
            const linksForSection = researchCustomLinks[currentResearchSection] || [];

            if (linksForSection.length > 0) {
                indicator.style.display = 'block';
                indicator.innerHTML = `<strong>üìé ${linksForSection.length} custom link${linksForSection.length > 1 ? 's' : ''} added</strong> for this section (shown first in results)`;
            } else {
                indicator.style.display = 'none';
            }
        }

        async function fetchCustomArticle() {
            const url = document.getElementById('customLinkInput').value.trim();
            const errorDiv = document.getElementById('uploadLinkError');
            const btn = document.getElementById('fetchArticleBtn');

            if (!url) {
                errorDiv.textContent = 'Please enter a URL';
                errorDiv.style.display = 'block';
                return;
            }

            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                errorDiv.textContent = 'Please enter a valid URL starting with http:// or https://';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 6px;"></span> Fetching...';

            try {
                const response = await fetch(`${API_BASE}/api/fetch-article`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: url,
                        section: currentResearchSection
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Add the article to the current results
                    const article = data.article;
                    article.isCustomLink = true;  // Mark as custom link

                    // Add to persistent custom links for this section
                    if (!researchCustomLinks[currentResearchSection]) {
                        researchCustomLinks[currentResearchSection] = [];
                    }
                    researchCustomLinks[currentResearchSection].push(article);

                    // Ensure perplexity array exists before adding
                    if (!researchResults.perplexity) {
                        researchResults.perplexity = [];
                    }

                    // Add to perplexity results (they'll appear at the top)
                    researchResults.perplexity.unshift(article);

                    // Re-render the results
                    const container = document.getElementById('perplexityResults');
                    displayPerplexityResults(researchResults.perplexity, container);

                    // Cache for this tab
                    tabSearchState[currentResearchSection].results.perplexity = researchResults.perplexity;
                    tabSearchState[currentResearchSection].htmlCache.perplexity = container.innerHTML;

                    // Update the custom links indicator
                    updateResearchCustomLinksIndicator();

                    // Update the added links list in modal (don't close - allow adding more)
                    customLinkCounter++;
                    updateAddedLinksList(article.title || 'Article', url, customLinkCounter);

                    // Clear input for next link
                    document.getElementById('customLinkInput').value = '';
                    document.getElementById('customLinkInput').focus();
                } else {
                    errorDiv.textContent = data.error || 'Failed to fetch article';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching article:', error);
                errorDiv.textContent = 'Error: ' + error.message;
                errorDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '+ Add This Link';
            }
        }

        // Fetch article from "Add another link" input
        async function fetchAnotherCustomArticle() {
            const url = document.getElementById('anotherLinkInput').value.trim();
            const errorDiv = document.getElementById('uploadLinkError');

            if (!url) {
                errorDiv.textContent = 'Please enter a URL';
                errorDiv.style.display = 'block';
                return;
            }

            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                errorDiv.textContent = 'Please enter a valid URL starting with http:// or https://';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/api/fetch-article`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: url,
                        section: currentResearchSection
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const article = data.article;

                    if (!researchResults.perplexity) {
                        researchResults.perplexity = [];
                    }

                    researchResults.perplexity.unshift(article);

                    const container = document.getElementById('perplexityResults');
                    displayPerplexityResults(researchResults.perplexity, container);

                    tabSearchState[currentResearchSection].results.perplexity = researchResults.perplexity;
                    tabSearchState[currentResearchSection].htmlCache.perplexity = container.innerHTML;

                    customLinkCounter++;
                    updateAddedLinksList(article.title || 'Article', url, customLinkCounter);

                    // Clear the "another link" input
                    document.getElementById('anotherLinkInput').value = '';
                } else {
                    errorDiv.textContent = data.error || 'Failed to fetch article';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching article:', error);
                errorDiv.textContent = 'Error: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        // Upload Link Modal Functions for Spotlight
        function showSpotlightUploadModal() {
            document.getElementById('spotlightUploadLinkModal').style.display = 'flex';
            document.getElementById('spotlightCustomLinkInput').value = '';
            document.getElementById('spotlightUploadLinkError').style.display = 'none';

            // Show existing custom links if any
            const listDiv = document.getElementById('spotlightAddedLinksList');
            const container = document.getElementById('spotlightAddedLinksContainer');
            if (spotlightCustomLinks.length > 0) {
                listDiv.style.display = 'block';
                container.innerHTML = '';
                spotlightCustomLinks.forEach(link => {
                    const linkItem = document.createElement('div');
                    linkItem.style.cssText = 'padding: 6px 8px; margin-bottom: 4px; background: white; border-radius: 4px; font-size: 12px; display: flex; justify-content: space-between; align-items: center;';
                    linkItem.innerHTML = `
                        <span style="color: #374151; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 400px;" title="${link.url || ''}">${link.title || 'Article'}</span>
                        <span style="color: #059669; font-size: 10px;">‚úì</span>
                    `;
                    container.appendChild(linkItem);
                });
            } else {
                listDiv.style.display = 'none';
                container.innerHTML = '';
            }

            document.getElementById('spotlightCustomLinkInput').focus();
        }

        function hideSpotlightUploadModal() {
            document.getElementById('spotlightUploadLinkModal').style.display = 'none';
        }

        function updateSpotlightAddedLinksList(title, url) {
            const listDiv = document.getElementById('spotlightAddedLinksList');
            const container = document.getElementById('spotlightAddedLinksContainer');
            listDiv.style.display = 'block';

            const linkItem = document.createElement('div');
            linkItem.style.cssText = 'padding: 6px 8px; margin-bottom: 4px; background: white; border-radius: 4px; font-size: 12px; display: flex; justify-content: space-between; align-items: center;';
            linkItem.innerHTML = `
                <span style="color: #374151; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 400px;" title="${url}">${title || url}</span>
                <span style="color: #059669; font-size: 10px;">‚úì</span>
            `;
            container.appendChild(linkItem);
        }

        async function fetchSpotlightCustomArticle() {
            const url = document.getElementById('spotlightCustomLinkInput').value.trim();
            const errorDiv = document.getElementById('spotlightUploadLinkError');
            const btn = document.getElementById('spotlightFetchArticleBtn');

            if (!url) {
                errorDiv.textContent = 'Please enter a URL';
                errorDiv.style.display = 'block';
                return;
            }

            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                errorDiv.textContent = 'Please enter a valid URL starting with http:// or https://';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 6px;"></span> Fetching...';

            try {
                const response = await fetch(`${API_BASE}/api/fetch-article`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: url,
                        section: 'spotlight'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Add the article to the spotlight perplexity results
                    const article = data.article;
                    article.isCustomLink = true;  // Mark as custom link

                    // Add to persistent custom links array (survives searches)
                    spotlightCustomLinks.push(article);

                    // Also add to current search results for immediate display
                    if (!spotlightSearchResults.perplexity) {
                        spotlightSearchResults.perplexity = [];
                    }
                    spotlightSearchResults.perplexity.unshift(article);

                    // Re-render with merged results (custom links first)
                    const mergedResults = [...spotlightCustomLinks, ...spotlightSearchResults.perplexity.filter(r => !r.isCustomLink)];

                    // Show custom links indicator in results
                    const resultsDiv = document.getElementById('spotlightPerplexityResults');
                    let customLinksIndicator = resultsDiv.querySelector('.custom-links-indicator');
                    if (!customLinksIndicator) {
                        customLinksIndicator = document.createElement('div');
                        customLinksIndicator.className = 'custom-links-indicator';
                        customLinksIndicator.style.cssText = 'font-size: 12px; color: #059669; background: #d1fae5; padding: 8px 12px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #10b981;';
                        resultsDiv.insertBefore(customLinksIndicator, resultsDiv.firstChild);
                    }
                    customLinksIndicator.innerHTML = `<strong>üìé ${spotlightCustomLinks.length} custom link${spotlightCustomLinks.length > 1 ? 's' : ''} added</strong> (shown first)`;

                    // Also update the main page indicator
                    const mainIndicator = document.getElementById('spotlightCustomLinksIndicatorMain');
                    if (mainIndicator) {
                        mainIndicator.style.display = 'block';
                        mainIndicator.innerHTML = `<strong>üìé ${spotlightCustomLinks.length} custom link${spotlightCustomLinks.length > 1 ? 's' : ''} added</strong> (shown first in results)`;
                    }

                    displaySpotlightResults(mergedResults, 'spotlightPerplexityResults', false);

                    // Update the added links list in modal (don't close - allow adding more)
                    updateSpotlightAddedLinksList(article.title || 'Article', url);

                    // Clear input for next link
                    document.getElementById('spotlightCustomLinkInput').value = '';
                    document.getElementById('spotlightCustomLinkInput').focus();
                } else {
                    errorDiv.textContent = data.error || 'Failed to fetch article';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching article:', error);
                errorDiv.textContent = 'Error: ' + error.message;
                errorDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '+ Add This Link';
            }
        }

        // Section-specific search defaults
        const sectionSearchDefaults = {
            claims: {
                perplexity: 'unusual insurance claim story lawsuit verdict weird bizarre',
                perplexityPlaceholder: 'e.g., strange claim, fraud case, odd payout...',
                explorer: 'bizarre insurance claim lawsuit settlement verdict',
                explorerPlaceholder: 'e.g., strange claim, fraud case, court ruling...'
            },
            roundup: {
                perplexity: 'P&C insurance news trends 2026',
                perplexityPlaceholder: 'e.g., property casualty news, market updates...',
                explorer: 'insurance industry news roundup',
                explorerPlaceholder: 'e.g., market news, regulatory updates...'
            },
            tips: {
                perplexity: 'insurance agent sales tips strategies 2026',
                perplexityPlaceholder: 'e.g., agent tips, sales strategies, client retention...',
                explorer: 'independent insurance agent advice',
                explorerPlaceholder: 'e.g., best practices, agency growth...'
            }
        };

        // Switch between research section tabs (CLAIMS, ROUNDUP, SPOTLIGHT, TIPS)
        function switchResearchTab(section) {
            currentResearchSection = section;

            // Update tab styling
            document.querySelectorAll('.research-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.section === section) {
                    tab.classList.add('active');
                }
            });

            // Update section label with section-specific instructions
            const labels = { claims: 'Curious Claims', roundup: 'News Roundup', tips: 'Agent Advantage' };
            const instructions = {
                claims: 'Search and select <strong>1 article</strong> below.',
                roundup: `Search and select <strong>5 articles</strong> below. (${selectedRoundup.length}/5 selected)`,
                tips: 'Search and select <strong>1 article</strong> below.'
            };
            document.getElementById('researchSectionLabel').innerHTML =
                `Researching for: <strong>${labels[section]}</strong> section. ${instructions[section]}`;

            // Update search inputs with section-specific defaults
            const defaults = sectionSearchDefaults[section];
            if (defaults) {
                const perplexityInput = document.getElementById('perplexityQuery');
                const explorerInput = document.getElementById('explorerQuery');

                if (perplexityInput) {
                    perplexityInput.value = defaults.perplexity;
                    perplexityInput.placeholder = defaults.perplexityPlaceholder;
                }
                if (explorerInput) {
                    explorerInput.value = defaults.explorer;
                    explorerInput.placeholder = defaults.explorerPlaceholder;
                }
            }

            // Restore cached search results for this tab (or show default placeholders)
            const tabState = tabSearchState[section];
            const perplexityResultsDiv = document.getElementById('perplexityResults');
            const insightResultsDiv = document.getElementById('insightResults');
            const explorerResultsDiv = document.getElementById('explorerResults');

            if (tabState.htmlCache.perplexity) {
                perplexityResultsDiv.innerHTML = tabState.htmlCache.perplexity;
                researchResults.perplexity = tabState.results.perplexity;
            } else {
                perplexityResultsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Enter a topic and search</p>';
                researchResults.perplexity = [];
            }

            if (tabState.htmlCache.insight) {
                insightResultsDiv.innerHTML = tabState.htmlCache.insight;
                researchResults.insight = tabState.results.insight;
            } else {
                insightResultsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Click to analyze all 8 market signals</p>';
                researchResults.insight = [];
            }

            if (tabState.htmlCache.explorer) {
                explorerResultsDiv.innerHTML = tabState.htmlCache.explorer;
                researchResults.explorer = tabState.results.explorer;
            } else {
                explorerResultsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Select source packs and search</p>';
                researchResults.explorer = [];
            }

            // Re-attach click handlers and highlight existing selections
            reattachResultClickHandlers();
            highlightExistingSelection(section);

            // Update custom links indicator for this tab
            updateResearchCustomLinksIndicator();

            // Update progress tracker and next button
            updateSelectionProgress();
        }

        // Re-attach click handlers to result items after restoring from cache
        function reattachResultClickHandlers() {
            // Get current results for each card type
            const allResults = {
                perplexity: researchResults.perplexity || [],
                insight: researchResults.insight || [],
                explorer: researchResults.explorer || []
            };

            document.querySelectorAll('.research-result-item').forEach(item => {
                const cardType = item.dataset.cardType;
                const index = parseInt(item.dataset.index, 10);
                const results = allResults[cardType] || [];
                const result = results[index];

                if (result) {
                    item.onclick = () => selectResearchResult(cardType, index, item, result);
                }
            });
        }

        // Highlight already-selected results when switching tabs
        function highlightExistingSelection(section) {
            // For roundup, highlight ALL selected items (multiple selections)
            if (section === 'roundup') {
                if (!selectedRoundup || selectedRoundup.length === 0) return;
                const selectedUrls = selectedRoundup.map(r => r.url);

                document.querySelectorAll('.research-result-item').forEach(item => {
                    if (selectedUrls.includes(item.dataset.url)) {
                        item.classList.add('selected');
                        item.style.borderColor = '#018181';
                        item.style.background = '#e6f4f4';
                        const indicator = item.querySelector('.selection-indicator');
                        if (indicator) {
                            indicator.style.background = '#018181';
                            indicator.style.borderColor = '#018181';
                            indicator.querySelector('.check-icon').style.display = 'block';
                        }
                    }
                });
                return;
            }

            // For single-select tabs (claims, spotlight, tips)
            const selected = section === 'claims' ? selectedClaims :
                             section === 'spotlight' ? selectedSpotlight : selectedTips;
            if (!selected || !selected.url) return;

            // Find and highlight the matching result card
            document.querySelectorAll('.research-result-item').forEach(item => {
                if (item.dataset.url === selected.url) {
                    item.classList.add('selected');
                    item.style.borderColor = '#018181';
                    item.style.background = '#e6f4f4';
                    const indicator = item.querySelector('.selection-indicator');
                    if (indicator) {
                        indicator.style.background = '#018181';
                        indicator.style.borderColor = '#018181';
                        indicator.querySelector('.check-icon').style.display = 'block';
                    }
                }
            });
        }

        // Update the selection progress tracker and Next button
        function updateSelectionProgress() {
            const hasClaims = selectedClaims !== null;
            const hasRoundup = selectedRoundup.length >= 5;  // Require 5 articles for roundup
            const hasTips = selectedTips !== null;  // Only 1 article for tips now
            const allSelected = hasClaims && hasRoundup && hasTips;

            // Update progress tracker items
            const claimsItem = document.getElementById('progressClaims');
            const roundupItem = document.getElementById('progressRoundup');
            const tipsItem = document.getElementById('progressTips');

            // Update completed states
            if (claimsItem) {
                claimsItem.classList.toggle('completed', hasClaims);
                claimsItem.classList.toggle('active', currentResearchSection === 'claims');
                document.getElementById('checkClaims').textContent = hasClaims ? '‚úì' : '';
            }
            if (roundupItem) {
                roundupItem.classList.toggle('completed', hasRoundup);
                roundupItem.classList.toggle('active', currentResearchSection === 'roundup');
                document.getElementById('checkRoundup').textContent = hasRoundup ? '‚úì' : `${selectedRoundup.length}/5`;
            }
            if (tipsItem) {
                tipsItem.classList.toggle('completed', hasTips);
                tipsItem.classList.toggle('active', currentResearchSection === 'tips');
                document.getElementById('checkTips').textContent = hasTips ? '‚úì' : '';
            }

            // Update tab checkmarks
            document.getElementById('claimsTabCheck').style.display = hasClaims ? 'inline' : 'none';
            document.getElementById('roundupTabCheck').style.display = hasRoundup ? 'inline' : 'none';
            document.getElementById('tipsTabCheck').style.display = hasTips ? 'inline' : 'none';

            // Update Next button - always shows "Generate Newsletter" but disabled until all 3 selected
            const nextBtn = document.getElementById('researchNextBtn');
            if (nextBtn) {
                nextBtn.disabled = !allSelected;
                nextBtn.textContent = 'Generate Newsletter ‚Üí';
                nextBtn.onclick = allSelected ? () => generateContent() : null;
            }
        }

        // Alias for backwards compatibility
        function updateResearchNextButton() {
            updateSelectionProgress();
        }

        // Select a research result directly from the dashboard
        function selectResearchResult(cardType, index, element, result) {
            // Build the selection object
            const selectedObj = {
                title: result.headline || result.title,
                description: result.industry_data || result.snippet || result.agent_implications,
                source_url: result.url,
                url: result.url,
                publisher: result.publisher,
                so_what: result.so_what || result.agent_implications,
                _cardType: cardType
            };

            // Handle ROUNDUP tab specially - allows multiple selections with toggle
            if (currentResearchSection === 'roundup') {
                // Check if already selected (toggle off)
                const existingIndex = selectedRoundup.findIndex(r => r.url === selectedObj.url);
                if (existingIndex >= 0) {
                    // Deselect - remove from array
                    selectedRoundup.splice(existingIndex, 1);
                    element.classList.remove('selected');
                    element.style.borderColor = '#e5e7eb';
                    element.style.background = '#fff';
                    const indicator = element.querySelector('.selection-indicator');
                    if (indicator) {
                        indicator.style.background = 'white';
                        indicator.style.borderColor = '#ccc';
                        indicator.querySelector('.check-icon').style.display = 'none';
                    }
                    console.log('[Research] Deselected from ROUNDUP:', selectedObj.title, `(${selectedRoundup.length}/5)`);
                } else if (selectedRoundup.length < 5) {
                    // Select - add to array
                    selectedRoundup.push(selectedObj);
                    element.classList.add('selected');
                    element.style.borderColor = '#018181';
                    element.style.background = '#e6f4f4';
                    const indicator = element.querySelector('.selection-indicator');
                    if (indicator) {
                        indicator.style.background = '#018181';
                        indicator.style.borderColor = '#018181';
                        indicator.querySelector('.check-icon').style.display = 'block';
                    }
                    console.log('[Research] Selected for ROUNDUP:', selectedObj.title, `(${selectedRoundup.length}/5)`);
                } else {
                    // Already have 5, show message
                    alert('You have already selected 5 articles for News Roundup. Deselect one to choose a different article.');
                    return;
                }

                // Update tab check and label
                document.getElementById('roundupTabCheck').style.display = selectedRoundup.length > 0 ? 'inline' : 'none';
                document.getElementById('researchSectionLabel').innerHTML =
                    `Researching for: <strong>News Roundup</strong> section. Search and select <strong>5 articles</strong> below. (${selectedRoundup.length}/5 selected)`;

                updateResearchNextButton();
                return;
            }

            // For single-select tabs (claims, spotlight, tips), clear all selections first
            document.querySelectorAll('.research-result-item').forEach(item => {
                item.classList.remove('selected');
                item.style.borderColor = '#e5e7eb';
                item.style.background = '#fff';
                const indicator = item.querySelector('.selection-indicator');
                if (indicator) {
                    indicator.style.background = 'white';
                    indicator.style.borderColor = '#ccc';
                    indicator.querySelector('.check-icon').style.display = 'none';
                }
            });

            // Mark this one as selected
            element.classList.add('selected');
            element.style.borderColor = '#018181';
            element.style.background = '#e6f4f4';
            const indicator = element.querySelector('.selection-indicator');
            if (indicator) {
                indicator.style.background = '#018181';
                indicator.style.borderColor = '#018181';
                indicator.querySelector('.check-icon').style.display = 'block';
            }

            // Store in the correct section and show checkmark on tab
            if (currentResearchSection === 'claims') {
                selectedClaims = selectedObj;
                document.getElementById('claimsTabCheck').style.display = 'inline';
                console.log('[Research] Selected for CLAIMS:', selectedClaims.title);
            } else if (currentResearchSection === 'spotlight') {
                selectedSpotlight = selectedObj;
                document.getElementById('spotlightTabCheck').style.display = 'inline';
                console.log('[Research] Selected for SPOTLIGHT:', selectedSpotlight.title);
            } else if (currentResearchSection === 'tips') {
                // For tips, only allow 1 selection (single article generates 5 tips)
                selectedTips = selectedObj;
                document.getElementById('tipsTabCheck').style.display = 'inline';
                console.log('[Research] Selected for TIPS:', selectedTips.title);
            }

            // Update the Next button
            updateResearchNextButton();
        }

        function displayExplorerResults(results, container, queriesUsed = null) {
            container.innerHTML = '';

            // Store results for selection
            researchResults.explorer = results;
            updateAllResults();

            // Show queries used if provided
            if (queriesUsed && queriesUsed.length > 0) {
                const queriesDiv = document.createElement('div');
                queriesDiv.style.cssText = 'font-size: 11px; color: #666; background: #f5f5f5; padding: 8px; margin-bottom: 10px; border-radius: 4px;';
                queriesDiv.innerHTML = `<strong>Queries tried:</strong><br>${queriesUsed.join('<br>')}`;
                container.appendChild(queriesDiv);
            }

            // Content type badge colors
            const typeColors = {
                'trend': { bg: '#dbeafe', border: '#3b82f6', text: '#1d4ed8' },
                'tip': { bg: '#dcfce7', border: '#22c55e', text: '#15803d' },
                'news': { bg: '#fef3c7', border: '#f59e0b', text: '#92400e' },
                'insight': { bg: '#f3e8ff', border: '#a855f7', text: '#7c3aed' },
                'case_study': { bg: '#fce7f3', border: '#ec4899', text: '#be185d' }
            };

            results.forEach((result, index) => {
                const contentType = result.content_type || 'insight';
                const colors = typeColors[contentType] || typeColors['insight'];

                const item = document.createElement('div');
                item.className = 'research-result-item';
                item.dataset.cardType = 'explorer';
                item.dataset.index = index;
                item.dataset.url = result.url || '';
                item.style.cssText = 'position: relative; cursor: pointer;';
                item.innerHTML = `
                    <!-- Selection checkbox indicator -->
                    <div class="selection-indicator" style="position: absolute; top: 8px; right: 8px; width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; background: white; transition: all 0.2s;">
                        <svg class="check-icon" style="display: none; width: 14px; height: 14px; color: white;" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>

                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; padding-right: 28px;">
                        <span style="background: ${colors.bg}; border: 1px solid ${colors.border}; color: ${colors.text}; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase;">${contentType.replace('_', ' ')}</span>
                    </div>
                    <div class="research-result-title">${result.headline || result.title || 'Untitled'}</div>
                    <div class="research-result-snippet" style="font-style: italic; color: #555;">${result.story_angle || ''}</div>
                    <div class="research-result-snippet" style="margin-top: 4px; font-size: 12px;">${result.why_it_matters || result.agent_implications || ''}</div>
                    <div class="research-result-meta">
                        <span>${result.publisher || 'Unknown source'}</span>
                        ${result.url ? `<a href="${result.url}" target="_blank" class="research-result-link" onclick="event.stopPropagation()">View ‚Üí</a>` : ''}
                    </div>
                `;

                // Add click handler for selection
                item.onclick = () => selectResearchResult('explorer', index, item, result);
                container.appendChild(item);
            });
        }

        function displayCardResults(cardType, results, container, queriesUsed = null) {
            container.innerHTML = '';

            // Show queries used if provided
            if (queriesUsed && queriesUsed.length > 0) {
                const queriesDiv = document.createElement('div');
                queriesDiv.className = 'queries-used';
                queriesDiv.style.cssText = 'font-size: 11px; color: #666; background: #f5f5f5; padding: 8px; margin-bottom: 10px; border-radius: 4px;';
                queriesDiv.innerHTML = `<strong>Queries tried:</strong><br>${queriesUsed.join('<br>')}`;
                container.appendChild(queriesDiv);
            }

            results.forEach((result, index) => {
                const item = document.createElement('div');
                item.className = 'research-result-item';
                item.dataset.cardType = cardType;
                item.dataset.index = index;
                item.dataset.url = result.url || '';
                item.innerHTML = `
                    <div class="research-result-title">${result.title || 'Untitled'}</div>
                    <div class="research-result-snippet">${(result.snippet || result.agent_implications || '').substring(0, 150)}...</div>
                    <div class="research-result-meta">
                        <span>${result.publisher || 'Unknown source'}</span>
                        ${result.url ? `<a href="${result.url}" target="_blank" class="research-result-link" onclick="event.stopPropagation()">View ‚Üí</a>` : ''}
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function updateAllResults() {
            // Combine all results from all cards
            allResearchResults = [
                ...researchResults.insight.map((r, i) => ({ ...r, _cardType: 'insight', _index: i })),
                ...researchResults.explorer.map((r, i) => ({ ...r, _cardType: 'explorer', _index: i })),
                ...researchResults.perplexity.map((r, i) => ({ ...r, _cardType: 'perplexity', _index: i }))
            ];
        }

        function goToSectionSelection(section) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            document.getElementById(`step-select-${section}`).classList.add('active');
            updateProgress(section === 'news' ? 3 : section === 'tip' ? 4 : 5);

            // Populate results for this section
            const containerId = `allResultsFor${section.charAt(0).toUpperCase() + section.slice(1)}`;
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (allResearchResults.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No research results yet. Go back and search in at least one card.</p>';
                return;
            }

            allResearchResults.forEach((result, globalIndex) => {
                const card = document.createElement('div');
                card.className = 'topic-card';
                card.dataset.globalIndex = globalIndex;
                card.innerHTML = `
                    <div class="title">${getCardIcon(result._cardType)} ${result.title || 'Untitled'}</div>
                    <div class="description">${result.snippet || result.agent_implications || ''}</div>
                    ${result.url ? `<a href="${result.url}" target="_blank" class="source" onclick="event.stopPropagation()">View source ‚Üí</a>` : ''}
                    <div style="margin-top: 8px; font-size: 12px; color: #999;">
                        Source: ${getCardLabel(result._cardType)} | ${result.publisher || 'Unknown'}
                    </div>
                `;
                card.onclick = () => selectForSection(section, globalIndex, card);
                container.appendChild(card);
            });
        }

        function getCardIcon(cardType) {
            const icons = { insight: 'üìä', explorer: 'üì∞', perplexity: 'üîÆ' };
            return icons[cardType] || 'üìÑ';
        }

        function getCardLabel(cardType) {
            const labels = { insight: 'Insight Builder', explorer: 'Source Explorer', perplexity: 'Perplexity' };
            return labels[cardType] || cardType;
        }

        function selectForSection(section, globalIndex, element) {
            const result = allResearchResults[globalIndex];

            // Update global selection (maps to existing selectedNews/selectedTip/selectedTrend)
            const selectedObj = {
                title: result.title,
                description: result.snippet || result.agent_implications,
                source_url: result.url,
                url: result.url,
                publisher: result.publisher,
                _cardType: result._cardType
            };

            if (section === 'news') {
                selectedNews = selectedObj;
                document.querySelectorAll('#allResultsForNews .topic-card').forEach(c => c.classList.remove('selected'));
                document.getElementById('newsSelectNextBtn').disabled = false;
            } else if (section === 'tip') {
                selectedTip = selectedObj;
                document.querySelectorAll('#allResultsForTip .topic-card').forEach(c => c.classList.remove('selected'));
                document.getElementById('tipSelectNextBtn').disabled = false;
            } else if (section === 'trend') {
                selectedTrend = selectedObj;
                document.querySelectorAll('#allResultsForTrend .topic-card').forEach(c => c.classList.remove('selected'));
                document.getElementById('trendSelectNextBtn').disabled = false;
            }

            element.classList.add('selected');
        }

        // =============================================================================
        // END 4-CARD RESEARCH DASHBOARD FUNCTIONS
        // =============================================================================

        function showStep(stepNum) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            document.getElementById(`step${stepNum}`).classList.add('active');
            updateProgress(stepNum);

            // Note: Meme generation now happens via the prompt step (15_5) ‚Üí step 16 flow
            // No longer auto-generate on entering step 16

            // Don't auto-generate subject lines - wait for user to select tone
            // The tone selection UI will be shown by default

            // Pre-populate subject line for Ontraport from selected subject (Step 11)
            if (stepNum === 15) {
                const subjectField = document.getElementById('subject');
                const subjectDisplay = document.getElementById('ontraportSubjectDisplay');
                const finalSubject = document.getElementById('finalSubjectLine');

                let subjectLine = '';
                if (finalSubject && finalSubject.value) {
                    subjectLine = finalSubject.value;
                } else {
                    // Fallback if no subject was selected
                    const monthName = selectedMonth ? selectedMonth.charAt(0).toUpperCase() + selectedMonth.slice(1) : 'Monthly';
                    subjectLine = `${monthName} BriteCo Brief - Agent Newsletter`;
                }

                if (subjectField) subjectField.value = subjectLine;
                if (subjectDisplay) subjectDisplay.textContent = subjectLine;
            }
        }

        // Navigate to subject line step (skipping meme)
        function showSubjectLineStep() {
            showStep(12);
        }

        function updateProgress(step) {
            const totalSteps = 14; // Reduced from 15 (meme step removed)

            // Map internal step numbers to display numbers (skip 11 which was meme)
            const stepToDisplay = {
                1: 1, 2: 2, 3: 3, 4: 4, 5: 5, 6: 6, 7: 7, 8: 8, 9: 9, 10: 10,
                // Step 11 (meme) is skipped
                12: 11, 13: 12, 14: 13, 15: 14
            };

            const displayStep = stepToDisplay[step] || step;
            const progress = ((displayStep - 1) / (totalSteps - 1)) * 100;
            document.getElementById('progressBar').style.width = progress + '%';

            // Update step counter text
            document.getElementById('progressStep').textContent = `Step ${displayStep} of ${totalSteps}`;

            // Step labels for clarity (14 steps total, meme removed)
            const stepLabels = {
                1: 'Select Month',
                2: 'Research Dashboard',
                3: 'Researching',
                4: 'Writing',
                5: 'Review Content',
                6: 'Brand Check',
                7: 'Check Results',
                8: 'Edit Prompts',
                9: 'Generating Images',
                10: 'Review Images',
                // 11 was Meme - removed
                12: 'Subject Line',
                13: 'Preview',
                14: 'Test Email',
                15: 'Ontraport'
            };

            document.getElementById('progressLabel').textContent = stepLabels[step] || '';
        }

        // Initialize
        initMonths();
        loadNewsletterArchive();

        // Newsletter Archive Functions
        async function loadNewsletterArchive() {
            try {
                const response = await fetch(`${API_BASE}/api/get-newsletter-archive`);
                const data = await response.json();

                if (data.success && data.newsletters && data.newsletters.length > 0) {
                    displayNewsletterArchive(data.newsletters);
                } else {
                    document.getElementById('newsletterArchiveEmpty').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading newsletter archive:', error);
                document.getElementById('newsletterArchiveEmpty').style.display = 'block';
            }
        }

        function displayNewsletterArchive(newsletters) {
            const grid = document.getElementById('newsletterArchiveGrid');
            grid.innerHTML = '';

            newsletters.forEach(newsletter => {
                const card = document.createElement('div');
                card.style.cssText = 'background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;';
                card.onmouseenter = () => {
                    card.style.transform = 'translateY(-4px)';
                    card.style.boxShadow = '0 4px 16px rgba(0,0,0,0.15)';
                };
                card.onmouseleave = () => {
                    card.style.transform = 'translateY(0)';
                    card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                };

                card.innerHTML = `
                    <div style="width: 100%; height: 180px; background: #272D3F; display: flex; align-items: center; justify-content: center;">
                        <div style="font-size: 48px; color: #31D7CA; opacity: 0.4;">üì∞</div>
                    </div>
                    <div style="padding: 20px;">
                        <span style="display: inline-block; background: #272D3F; color: white; padding: 6px 14px; border-radius: 4px; font-size: 12px; font-weight: 600; text-transform: uppercase; margin-bottom: 16px;">${newsletter.month} ${newsletter.year}</span>

                        <div style="margin: 16px 0;">
                            <div style="margin-bottom: 14px; padding-left: 12px; border-left: 3px solid #31D7CA;">
                                <div style="font-size: 11px; text-transform: uppercase; color: #31D7CA; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 4px;">NEWS</div>
                                <div style="font-size: 14px; color: #272D3F; font-weight: 600; line-height: 1.4;">${newsletter.sections.news?.title || 'News Article'}</div>
                            </div>

                            <div style="margin-bottom: 14px; padding-left: 12px; border-left: 3px solid #31D7CA;">
                                <div style="font-size: 11px; text-transform: uppercase; color: #31D7CA; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 4px;">TIP</div>
                                <div style="font-size: 14px; color: #272D3F; font-weight: 600; line-height: 1.4;">${newsletter.sections.tip?.title || 'Pro Tip'}</div>
                            </div>

                            <div style="margin-bottom: 14px; padding-left: 12px; border-left: 3px solid #31D7CA;">
                                <div style="font-size: 11px; text-transform: uppercase; color: #31D7CA; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 4px;">TREND</div>
                                <div style="font-size: 14px; color: #272D3F; font-weight: 600; line-height: 1.4;">${newsletter.sections.trend?.title || 'Trend Alert'}</div>
                            </div>
                        </div>

                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #eee;">
                            <button onclick="viewNewsletter('${newsletter.id}')" style="width: 100%; padding: 12px 16px; background: #31D7CA; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.2s;">View Newsletter</button>
                        </div>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        function viewNewsletter(newsletterId) {
            // Fetch and display the newsletter HTML
            fetch(`${API_BASE}/api/get-newsletter-archive`)
                .then(res => res.json())
                .then(data => {
                    const newsletter = data.newsletters.find(n => n.id === newsletterId);
                    if (newsletter && newsletter.html_content) {
                        document.getElementById('newsletterModalContent').innerHTML = newsletter.html_content;
                        document.getElementById('newsletterModal').style.display = 'block';
                    }
                })
                .catch(error => console.error('Error viewing newsletter:', error));
        }

        function closeNewsletterModal() {
            document.getElementById('newsletterModal').style.display = 'none';
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeNewsletterModal();
            }
        });

        // Close modal on background click
        document.getElementById('newsletterModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'newsletterModal') {
                closeNewsletterModal();
            }
        });
    </script>

    <!-- Briteco Newsletter Template -->
    <script src="briteco_template.js"></script>
</body>
</html>
